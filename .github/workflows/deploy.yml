name: Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

concurrency:
  group: github-pages-deployment
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          # If private submodules fail to fetch, add: ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            gsnake-web/package-lock.json
      - run: npm ci
      - run: npm --prefix gsnake-web ci
      - name: Build WASM
        run: python3 scripts/build_wasm.py
      - run: npm --prefix gsnake-web run check

      - name: Run Rust contract tests
        run: cd gsnake-core && cargo test contract_tests

      - name: Generate contract fixtures
        run: cd gsnake-core && cargo test generate_contract_fixtures

      - name: Run TypeScript contract tests
        run: cd gsnake-web && npm test

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build fixture WASM
        run: ./scripts/build_fixture_wasm.sh

      - name: Setup gsnake-web for E2E
        run: |
          rm -rf gsnake-web/node_modules/gsnake-wasm
          cp -R e2e/fixtures/gsnake-wasm/pkg gsnake-web/node_modules/gsnake-wasm
          npm --prefix gsnake-web run build

      - run: npm --prefix gsnake-editor ci

      - name: Clean up existing server processes
        run: |
          # Kill any Node.js server processes
          pkill -f "vite preview" || true
          pkill -f "vite.*--port 3000" || true
          pkill -f "npm.*run.*dev" || true
          pkill -f "tsx server.ts" || true
          pkill -f "gsnake-editor" || true
          # Also try to kill by port if lsof/fuser available
          fuser -k 3000/tcp || true
          fuser -k 3001/tcp || true
          fuser -k 3003/tcp || true
          sleep 2

      - name: Start web preview server
        run: |
          nohup npm --prefix gsnake-web run preview -- --port 3000 --strictPort > /tmp/web-server.log 2>&1 &
          sleep 5
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:3000

      - name: Start editor dev server
        run: |
          nohup npm --prefix gsnake-editor run dev:editor > /tmp/editor-dev.log 2>&1 &
          sleep 5
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:3003

      - name: Start editor API server
        run: |
          nohup npm --prefix gsnake-editor run dev:server > /tmp/editor-api.log 2>&1 &
          sleep 5
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:3001

      - name: Run E2E contract tests
        env:
          CI: true
        run: npm run test:e2e

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          # If private submodules fail to fetch, add: ssh-key: ${{ secrets.SUBMODULE_SSH_KEY }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            gsnake-web/package-lock.json
      
      - run: npm ci
      - run: npm --prefix gsnake-web ci

      # --- Tag Specific Logic: Extract Info ---
      - name: Extract Tag Info
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          
          # Determine source branch (branch that contains this tag's commit)
          SOURCE_BRANCH=$(git branch -r --contains HEAD | grep -v 'HEAD' | head -1 | sed 's/.*origin\///')
          if [ -z "$SOURCE_BRANCH" ]; then
            SOURCE_BRANCH="main"  # Fallback to main if detection fails
          fi
          
          echo "IS_TAG_DEPLOY=true" >> $GITHUB_ENV
          echo "VERSION_TAG=$TAG_NAME" >> $GITHUB_ENV
          echo "VERSION_NUM=$VERSION" >> $GITHUB_ENV
          echo "SOURCE_BRANCH=$SOURCE_BRANCH" >> $GITHUB_ENV

      # --- Tag Specific Logic: Sync Version & Commit Back ---
      - name: Sync Package Version (Tags)
        if: env.IS_TAG_DEPLOY == 'true'
        run: |
          # 1. Update version in current workspace (for build artifact)
          npm version ${{ env.VERSION_NUM }} --no-git-tag-version
          
          # 2. Commit back to source branch
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Stash current changes (the version bump) to move branches safely
          git stash
          
          # Checkout source branch to update
          git checkout ${{ env.SOURCE_BRANCH }}
          git pull origin ${{ env.SOURCE_BRANCH }} || echo "Warning: Could not pull ${{ env.SOURCE_BRANCH }}, proceeding with checkout state"
          
          # Apply version update to source branch
          npm version ${{ env.VERSION_NUM }} --no-git-tag-version
          
          # Commit and Push
          git add package*.json
          git commit -m "chore: release ${{ env.VERSION_TAG }}" || echo "No changes to commit"
          git push origin ${{ env.SOURCE_BRANCH }}
          
          # Go back to tag commit for building the artifact
          git checkout -
          git stash pop
          # Now workspace has the version update applied to the tag code

      # --- Set Environment Variables ---
      - name: Set Base Path
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "VITE_BASE_PATH=/gSnake/main/" >> $GITHUB_ENV
            echo "DEPLOY_DIR=main" >> $GITHUB_ENV
          elif [[ "${{ env.IS_TAG_DEPLOY }}" == "true" ]]; then
            echo "VITE_BASE_PATH=/gSnake/${{ env.VERSION_TAG }}/" >> $GITHUB_ENV
            echo "DEPLOY_DIR=${{ env.VERSION_TAG }}" >> $GITHUB_ENV
          fi

      # --- Build ---
      - name: Build
        run: npm --prefix gsnake-web run build

      # --- Prepare gh-pages branch ---
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-root
        continue-on-error: true

      - name: Prepare Deployment Directory
        run: |
          mkdir -p gh-pages-root
          # Remove .git folder so it doesn't interfere with the deployment action's git operations
          rm -rf gh-pages-root/.git

      # --- Update Versions Registry and Pages (Tags only) ---
      - name: Update Version Registry
        if: env.IS_TAG_DEPLOY == 'true'
        run: |
          cd gh-pages-root
          
          # Initialize versions.json if missing
          if [ ! -f versions.json ]; then
            echo '{"latestVersion": "", "versions": []}' > versions.json
          fi
          
          # Update metadata and generate pages using Node script
          node -e "
            const fs = require('fs');
            try {
              // 1. Update versions.json
              const data = JSON.parse(fs.readFileSync('versions.json', 'utf8'));
              const newVer = '${{ env.VERSION_TAG }}';
              const date = new Date().toISOString();
              
              data.latestVersion = newVer;
              // Remove existing entry for this version if redeploying
              data.versions = data.versions.filter(v => v.version !== newVer);
              // Add new entry at top
              data.versions.unshift({ version: newVer, date: date });
              
              fs.writeFileSync('versions.json', JSON.stringify(data, null, 2));
              
              // 2. Generate Root Redirect (index.html)
              const rootHtml = \`<!DOCTYPE html>
          <html>
          <head>
            <meta charset='utf-8'>
            <title>Redirecting...</title>
            <script>
              fetch('/gSnake/versions.json')
                .then(res => res.json())
                .then(data => {
                  if (data.latestVersion) {
                    window.location.href = '/gSnake/' + data.latestVersion + '/';
                  } else {
                     window.location.href = '/gSnake/main/';
                  }
                })
                .catch(err => {
                  window.location.href = '/gSnake/main/';
                });
            </script>
          </head>
          <body><p>Redirecting...</p></body>
          </html>\`;
              fs.writeFileSync('index.html', rootHtml);
              
              // 3. Generate Versions Index (versions/index.html)
              if (!fs.existsSync('versions')) fs.mkdirSync('versions');
              
              const versionsHtml = \`<!DOCTYPE html>
          <html>
          <head>
          <title>gSnake Versions</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f5f5f5; }
            h1 { color: #333; margin-bottom: 10px; }
            .subtitle { color: #666; margin-bottom: 30px; }
            .version-list { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .version-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
            .version-item:last-child { border-bottom: none; }
            .version-item:hover { background: #f9f9f9; }
            .version-number { font-size: 18px; font-weight: 600; color: #0066cc; text-decoration: none; }
            .version-number:hover { text-decoration: underline; }
            .version-date { color: #666; font-size: 14px; }
            .latest-badge { background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
          </style>
          </head>
          <body>
            <h1>gSnake Versions</h1>
            <p class='subtitle'>All released versions of gSnake</p>
            <div class='version-list'>
              \${data.versions.map((v, i) => \`
                <div class='version-item'>
                  <div>
                    <a href='/gSnake/\${v.version}/' class='version-number'>
                      \${v.version}
                      \${i === 0 ? '<span class=\"latest-badge\">Latest</span>' : ''}
                    </a>
                  </div>
                  <div class='version-date'>\${new Date(v.date).toLocaleDateString()}</div>
                </div>
              \`).join('')}
            </div>
          </body>
          </html>\`;
              fs.writeFileSync('versions/index.html', versionsHtml);
              
            } catch (e) {
              console.error('Error updating metadata:', e);
              process.exit(1);
            }
          "

      # --- Copy Build Artifacts ---
      - name: Copy Build Artifacts
        run: |
          TARGET_DIR="gh-pages-root/${{ env.DEPLOY_DIR }}"
          if [ -d "gsnake-web/packages/gsnake-web-app/dist" ]; then
            BUILD_DIR="gsnake-web/packages/gsnake-web-app/dist"
          elif [ -d "gsnake-web/dist" ]; then
            BUILD_DIR="gsnake-web/dist"
          else
            echo "No build output directory found."
            echo "Checked:"
            echo "  - gsnake-web/packages/gsnake-web-app/dist"
            echo "  - gsnake-web/dist"
            echo "Available dist directories under gsnake-web:"
            find gsnake-web -maxdepth 4 -type d -name dist | sort || true
            exit 1
          fi

          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          cp -a "$BUILD_DIR"/. "$TARGET_DIR"/

      # --- Deploy ---
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-root
          keep_files: true # Preserve existing version directories
          branch: gh-pages
