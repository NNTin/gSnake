---
phase: 02-rendering-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsnake-web/vite.config.ts
  - gsnake-web/types/svg.d.ts
  - gsnake-web/components/SpriteLoader.svelte
  - gsnake-web/components/App.svelte
  - gsnake-web/components/Cell.svelte
  - gsnake-web/package.json
autonomous: true

must_haves:
  truths:
    - "SVG sprite sheet is inlined into the DOM when the app starts"
    - "Each game cell renders as an SVG use element referencing the correct sprite symbol"
    - "FallingFood cells render using the Food symbol (mapping handles the alias)"
    - "Empty cells render the Empty symbol (not a blank div)"
    - "TypeScript does not show errors when importing SVG files with ?url suffix"
  artifacts:
    - path: "gsnake-web/types/svg.d.ts"
      provides: "Ambient module declarations for SVG imports"
      contains: "declare module"
    - path: "gsnake-web/components/SpriteLoader.svelte"
      provides: "Component that inlines sprites.svg into the DOM"
      contains: "@html"
    - path: "gsnake-web/components/Cell.svelte"
      provides: "SVG-based cell rendering with use element"
      contains: "<use href="
  key_links:
    - from: "gsnake-web/components/SpriteLoader.svelte"
      to: "gsnake-web/assets/sprites.svg"
      via: "fetch of ?url import"
      pattern: "sprites\\.svg\\?url"
    - from: "gsnake-web/components/Cell.svelte"
      to: "sprites.svg symbol IDs"
      via: "href attribute on use element"
      pattern: "href=\"#"
    - from: "gsnake-web/components/App.svelte"
      to: "gsnake-web/components/SpriteLoader.svelte"
      via: "component import and render"
      pattern: "SpriteLoader"
---

<objective>
Install SVG tooling, create the sprite loader component, and convert Cell.svelte from colored divs to SVG `<use>` element rendering.

Purpose: Build the complete rendering pipeline so game cells display SVG sprites from the Phase 1 sprite sheet instead of solid-color divs. This is the core infrastructure that Phase 3 (game integration) builds upon.

Output: Working SVG rendering system where each cell references a symbol from the inlined sprite sheet.
</objective>

<execution_context>
@/home/nntin/.claude/get-shit-done/workflows/execute-plan.md
@/home/nntin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-svg-asset-creation/01-01-SUMMARY.md
@.planning/phases/02-rendering-infrastructure/02-RESEARCH.md

# Key source files
@gsnake-web/vite.config.ts
@gsnake-web/components/Cell.svelte
@gsnake-web/components/App.svelte
@gsnake-web/components/GameGrid.svelte
@gsnake-web/components/GameContainer.svelte
@gsnake-web/types/models.ts
@gsnake-web/assets/sprites.svg
@gsnake-web/package.json
@gsnake-web/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-svelte-svg, configure Vite, and add TypeScript SVG declarations</name>
  <files>
    gsnake-web/package.json
    gsnake-web/vite.config.ts
    gsnake-web/types/svg.d.ts
  </files>
  <action>
    1. Install vite-plugin-svelte-svg as a dev dependency:
       ```
       cd gsnake-web && npm install vite-plugin-svelte-svg --save-dev
       ```

    2. Update `gsnake-web/vite.config.ts` to add the svelteSVG plugin:
       - Import: `import svelteSVG from "vite-plugin-svelte-svg";`
       - Add to plugins array BEFORE `svelte()`:
         ```typescript
         svelteSVG({
           svgoConfig: {
             plugins: [
               {
                 name: "preset-default",
                 params: {
                   overrides: {
                     removeViewBox: false,
                     cleanupIds: false,
                   },
                 },
               },
             ],
           },
           requireSuffix: true,
         }),
         ```
       - Plugin order must be: `wasm()`, `topLevelAwait()`, `svelteSVG({...})`, `svelte()`

    3. Create `gsnake-web/types/svg.d.ts` with ambient module declarations:
       ```typescript
       declare module "*.svg?component" {
         import type { SvelteComponent } from "svelte";
         const component: typeof SvelteComponent;
         export default component;
       }

       declare module "*.svg?url" {
         const url: string;
         export default url;
       }

       declare module "*.svg" {
         const content: string;
         export default content;
       }
       ```
       This file will be auto-included by tsconfig.json (which has `include: ["**/*.d.ts"]`).
  </action>
  <verify>
    1. Run `cd gsnake-web && npx tsc --noEmit` — no TypeScript errors
    2. Check `gsnake-web/node_modules/vite-plugin-svelte-svg` exists
    3. Verify vite.config.ts has svelteSVG in plugins array before svelte()
  </verify>
  <done>
    vite-plugin-svelte-svg is installed, Vite config includes SVGO optimization plugin with viewBox and ID preservation, and TypeScript recognizes SVG imports without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SpriteLoader component and integrate into App.svelte</name>
  <files>
    gsnake-web/components/SpriteLoader.svelte
    gsnake-web/components/App.svelte
  </files>
  <action>
    1. Create `gsnake-web/components/SpriteLoader.svelte`:
       - Import `onMount` from svelte
       - Import sprite URL: `import spritesUrl from "../assets/sprites.svg?url";`
       - In `onMount`, fetch the sprite URL and store the response text in a reactive variable `spriteContent`
       - Render with `{@html spriteContent}` wrapped in an `{#if spriteContent}` block
       - The sprites.svg already has `style="display:none"` on the root `<svg>` element, so no additional hiding needed
       - Do NOT add any wrapper div — the `{@html}` renders the SVG directly into the DOM

       Example structure:
       ```svelte
       <script lang="ts">
         import { onMount } from "svelte";
         import spritesUrl from "../assets/sprites.svg?url";

         let spriteContent = "";

         onMount(async () => {
           const response = await fetch(spritesUrl);
           spriteContent = await response.text();
         });
       </script>

       {#if spriteContent}
         {@html spriteContent}
       {/if}
       ```

    2. Update `gsnake-web/components/App.svelte`:
       - Add import: `import SpriteLoader from "./SpriteLoader.svelte";`
       - Place `<SpriteLoader />` BEFORE `<GameContainer />` in the template section
       - This ensures sprites are loaded into the DOM before any Cell components try to reference them
  </action>
  <verify>
    1. Run `cd gsnake-web && npx svelte-check --tsconfig ./tsconfig.json` — no errors related to SpriteLoader
    2. Inspect App.svelte contains both SpriteLoader import and component usage
    3. SpriteLoader.svelte exists and imports sprites.svg with ?url suffix
  </verify>
  <done>
    SpriteLoader.svelte fetches and inlines sprites.svg into the DOM at app startup, and App.svelte renders SpriteLoader before GameContainer so sprite symbols are available when cells render.
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert Cell.svelte from colored divs to SVG use-element rendering</name>
  <files>
    gsnake-web/components/Cell.svelte
  </files>
  <action>
    1. Rewrite `gsnake-web/components/Cell.svelte` to render SVG `<use>` elements:

       - Keep the existing `type` prop: `export let type: CellType;`
       - Replace the `getTypeClass` function with a `getSymbolId` function that maps CellType to sprite symbol ID:
         - Most CellType values map directly (the symbol IDs in sprites.svg match CellType string values exactly)
         - Special case: `FallingFood` maps to `Food` (FallingFood shares the Food symbol per Phase 1 decision)
         - Return the string value for all other types (Empty, SnakeHead, SnakeBody, Food, FloatingFood, Obstacle, Exit, Stone, Spike)
       - Use reactive declaration: `$: symbolId = getSymbolId(type);`
       - Replace the `<div class="cell {typeClass}">` with:
         ```svelte
         <svg class="cell" viewBox="0 0 32 32">
           <use href="#{symbolId}" />
         </svg>
         ```
       - Replace the CSS styles completely:
         - Remove all the `.cell.snake-head`, `.cell.food`, etc. color rules
         - Keep `.cell` base style but update it for SVG:
           ```css
           .cell {
             width: 100%;
             height: 100%;
             display: block;
           }
           ```
       - Use plain `href` (NOT `xlink:href` — deprecated in SVG 2)

       Complete component:
       ```svelte
       <script lang="ts">
         import type { CellType } from "../types/models";

         export let type: CellType;

         $: symbolId = getSymbolId(type);

         function getSymbolId(t: CellType): string {
           if (t === "FallingFood") return "Food";
           return t;
         }
       </script>

       <svg class="cell" viewBox="0 0 32 32">
         <use href="#{symbolId}" />
       </svg>

       <style>
         .cell {
           width: 100%;
           height: 100%;
           display: block;
         }
       </style>
       ```

    2. Verify the mapping covers all CellType values:
       - Empty -> "Empty" (direct)
       - SnakeHead -> "SnakeHead" (direct)
       - SnakeBody -> "SnakeBody" (direct)
       - Food -> "Food" (direct)
       - Obstacle -> "Obstacle" (direct)
       - Exit -> "Exit" (direct)
       - FloatingFood -> "FloatingFood" (direct)
       - FallingFood -> "Food" (alias)
       - Stone -> "Stone" (direct)
       - Spike -> "Spike" (direct)
  </action>
  <verify>
    1. Run `cd gsnake-web && npx svelte-check --tsconfig ./tsconfig.json` — no errors in Cell.svelte
    2. Verify Cell.svelte contains `<use href=` (not `xlink:href`)
    3. Verify Cell.svelte no longer contains any `background:` color CSS rules
    4. Verify `FallingFood` is mapped to `Food` in getSymbolId function
    5. Run `cd gsnake-web && npm test` — existing tests pass (if any Cell tests exist)
  </verify>
  <done>
    Cell.svelte renders each game cell as an `<svg>` wrapper containing a `<use>` element that references the correct sprite symbol by ID. FallingFood correctly maps to the Food symbol. DOM shows 2 nodes per cell (svg + use) instead of a colored div. All colored-div CSS has been removed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check:** `cd gsnake-web && npx tsc --noEmit` — zero TypeScript errors
2. **Svelte check:** `cd gsnake-web && npx svelte-check --tsconfig ./tsconfig.json` — no errors
3. **Tests:** `cd gsnake-web && npm test` — all existing tests pass
4. **DOM structure (manual):** Start dev server (`cd gsnake-web && npm run dev`), open browser DevTools:
   - Verify a hidden `<svg>` element with 9 `<symbol>` children exists in the DOM (from SpriteLoader)
   - Verify each game cell is an `<svg class="cell"><use href="#SymbolId" /></svg>` (2 nodes per cell)
   - Verify no colored `<div>` elements remain in the game grid
5. **Visual check:** Game objects should display as SVG graphics, not solid-color squares
</verification>

<success_criteria>
- vite-plugin-svelte-svg is in devDependencies and configured with SVGO (removeViewBox: false, cleanupIds: false)
- TypeScript `*.svg?url` and `*.svg?component` imports resolve without errors
- SpriteLoader.svelte successfully inlines sprites.svg into the DOM via fetch + {@html}
- App.svelte renders SpriteLoader before GameContainer
- Cell.svelte uses `<svg><use href="#symbolId" /></svg>` pattern for all 10 CellType values
- FallingFood maps to Food symbol ID
- No colored-div CSS remains in Cell.svelte
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-rendering-infrastructure/02-01-SUMMARY.md`
</output>
