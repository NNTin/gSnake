---
phase: 04-performance-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsnake-web/components/Cell.svelte
  - gsnake-web/components/GameGrid.svelte
  - gsnake-web/components/SpriteLoader.svelte
autonomous: false

must_haves:
  truths:
    - "Chrome DevTools Performance tab shows frame times consistently under 16.67ms during snake movement and falling objects"
    - "A level with all object types simultaneously visible runs at 60fps for 30 seconds"
    - "Visual regression screenshots show SVG rendering matches expected appearance for all objects"
    - "will-change CSS hints are not applied to static cell elements"
    - "No significant memory increase when switching between levels multiple times"
  artifacts:
    - path: "gsnake-web/components/Cell.svelte"
      provides: "SVG rendering without will-change on static elements"
      contains: ".cell"
    - path: "gsnake-web/components/GameGrid.svelte"
      provides: "Grid rendering with primitive CellType props"
      contains: "game-field"
    - path: "gsnake-web/components/SpriteLoader.svelte"
      provides: "SVG sprite loading with onDestroy cleanup"
      contains: "onDestroy"
  key_links:
    - from: "gsnake-web/components/Cell.svelte"
      to: "sprites.svg symbols"
      via: "SVG use href with CSS opacity"
      pattern: "use href.*#"
    - from: "gsnake-web/components/GameGrid.svelte"
      to: "gsnake-web/components/Cell.svelte"
      via: "primitive CellType prop"
      pattern: "Cell type=\\{cell\\}"
---

<objective>
Validate that the SVG visual upgrade maintains 60fps performance, renders all CellType combinations correctly with proper transparency, and has no CSS performance anti-patterns.

Purpose: Final validation phase ensuring the visual upgrade from colored squares to SVG graphics has not introduced performance regressions or rendering issues. Incorporates the memory leak verification carried forward from Phase 3.

Output: Verified performance metrics (frame times, FPS, memory stability), visual regression confirmation, and CSS optimization audit.
</objective>

<execution_context>
@/home/nntin/.claude/get-shit-done/workflows/execute-plan.md
@/home/nntin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance-validation/04-RESEARCH.md
@.planning/phases/03-game-integration/03-01-SUMMARY.md
@.planning/phases/03-game-integration/03-02-SUMMARY.md
@gsnake-web/components/Cell.svelte
@gsnake-web/components/GameGrid.svelte
@gsnake-web/components/SpriteLoader.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated performance pre-checks and production build validation</name>
  <files>
    gsnake-web/components/Cell.svelte
    gsnake-web/components/GameGrid.svelte
    gsnake-web/components/SpriteLoader.svelte
  </files>
  <action>
    Run the following automated validation checks to confirm performance foundations before manual DevTools profiling:

    **1. will-change CSS audit:**
    Grep all `.svelte` and `.css` files in `gsnake-web/` for `will-change`. Confirm NO matches exist. This validates success criteria #4: will-change hints are NOT applied to static cell elements. The current Cell.svelte has no will-change property (correct behavior -- SVG cells are re-rendered by Svelte reactivity, not CSS animations).

    If `will-change` IS found on `.cell` or any static element, REMOVE it. Only leave will-change on elements that use CSS transitions or animations (currently none exist).

    **2. Run full test suite:**
    Execute `cd gsnake-web && npm test` to confirm all 68 tests still pass after Phase 3 changes. This ensures no regressions in the rendering pipeline.

    **3. Production build validation:**
    Execute `cd gsnake-web && npm run build` to confirm the production build succeeds. Check the build output for:
    - No warnings or errors
    - Bundle includes sprites.svg asset
    - Build completes in reasonable time (<30 seconds)

    Record the build output (bundle sizes) for the verification report.

    **4. DOM structure audit:**
    Read Cell.svelte and verify each cell produces exactly 2 DOM nodes: one `<svg>` element and one `<use>` child. Confirm no extraneous wrapper divs, no extra DOM nodes per cell. For a 20x15 grid (300 cells), this means ~600 SVG DOM nodes for the game field, which is well within performance budget.

    **5. CellType rendering completeness check:**
    Read Cell.svelte and verify `getSymbolId()` handles all 10 CellType values (Empty, SnakeHead, SnakeBody, Food, Obstacle, Exit, FloatingFood, FallingFood, Stone, Spike). Confirm FallingFood maps to Food symbol. Verify `getOpacity()` returns correct values: Spike=0.8, Stone=0.85, Obstacle=0.9, all others=1.0.

    Do NOT modify any source files unless will-change is found. This task is primarily audit/verification.
  </action>
  <verify>
    - `grep -r "will-change" gsnake-web/components/ gsnake-web/styles/` returns no matches (or only on genuinely animated elements)
    - `cd gsnake-web && npm test` passes all 68 tests
    - `cd gsnake-web && npm run build` succeeds without errors
    - Cell.svelte produces svg > use DOM structure (2 nodes per cell)
    - getSymbolId covers all 10 CellType values
    - getOpacity returns correct values for all CellType values
  </verify>
  <done>
    All automated pre-checks pass: will-change absent from static elements, test suite green, production build succeeds, DOM structure is optimal (2 nodes per cell), and all CellType values render with correct symbol IDs and opacity values.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Manual DevTools performance profiling and visual regression verification</name>
  <files>
    gsnake-web/components/Cell.svelte
    gsnake-web/components/GameGrid.svelte
    gsnake-web/components/SpriteLoader.svelte
  </files>
  <action>
Start the dev server (`cd gsnake-web && npm run dev`) and present the game at http://localhost:3000/ for human performance profiling and visual verification. No code changes in this task â€” this is a verification checkpoint.

The SVG visual upgrade is complete across Phases 1-3. All game objects render as SVG graphics with per-CellType opacity for visual depth. Task 1 confirmed: no will-change CSS anti-patterns, all tests pass, production build succeeds, and DOM structure is optimal.

This checkpoint validates the four Phase 4 success criteria that require manual Chrome DevTools interaction, plus the memory leak verification carried forward from Phase 3.
  </action>
  <verify>
Human performs these checks with Chrome DevTools open (F12):

**Prerequisites:**
- Dev server running: `cd gsnake-web && npm run dev`
- Chrome open to http://localhost:3000

**Test 1: Frame Time Profiling (PERF-01, Success Criteria #1)**
1. DevTools > Performance tab
2. Click Record (red circle)
3. Play the game for 15-20 seconds:
   - Move snake rapidly with arrow keys
   - Let falling objects drop (load a hard level)
   - Collect food items
4. Click Stop
5. Analysis:
   - Check FPS chart for red bars (dropped frames)
   - Hover over Frames section -- verify frame times < 16.67ms
   - Check Main section for red triangles (long tasks > 50ms)
6. PASS if: 95%+ of frames < 16.67ms, no red bars lasting >500ms

**Test 2: 30-Second Stress Test (PERF-02, Success Criteria #2)**
1. Open Command Menu (Ctrl+Shift+P)
2. Type "Performance monitor" and select it
3. Load a hard level with spikes, obstacles, floating food
4. Play continuously for 30 seconds while observing:
   - FPS: Should stay 58-60
   - DOM Nodes: Should remain stable (~300-600)
   - CPU Usage: Should stay <50%
5. PASS if: Average FPS >= 58, no drops below 45 for >2 seconds, DOM nodes stable

**Test 3: Visual Regression (PERF-03, PERF-04, Success Criteria #3)**
1. Load levels that show different object types:
   - Easy level: SnakeHead, SnakeBody, Food, Exit, Empty
   - Hard level: Spike, Stone, Obstacle, FloatingFood, FallingFood
2. For each object type, verify:
   - Object is visually recognizable (snake looks like a snake, food looks like food)
   - Transparency is visible on hazards (Spike slightly transparent, Stone slightly transparent, Obstacle slightly transparent)
   - No rendering artifacts, missing symbols, or broken SVGs
   - Colors match design intent (blue snake, red food, green exit)
3. PASS if: All 9 unique object types render correctly, transparency creates visible depth

**Test 4: Memory Leak Check (Carried forward from Phase 3 VERIFICATION.md)**
1. DevTools > Memory tab
2. Take heap snapshot (Snapshot 1)
3. Play Level 1 for ~10 seconds, then switch levels
4. Play Level 2 for ~10 seconds, then switch levels
5. Take heap snapshot (Snapshot 2)
6. Compare: Memory increase should be < 1MB
7. PASS if: No significant memory growth, no "Detached" DOM nodes accumulating

**Test 5: will-change Visual Confirmation (Success Criteria #4)**
1. DevTools > Elements tab
2. Select a `.cell` SVG element during gameplay
3. Check Computed styles for `will-change`
4. PASS if: will-change is `auto` or absent on all cell elements

**Production Build Verification (Optional but recommended):**
1. Build: `cd gsnake-web && npm run build`
2. Preview: `cd gsnake-web && npm run preview`
3. Open http://localhost:4173
4. Repeat Tests 1-2 above on production build
5. Expect 20-30% better performance than dev mode

Resume signal: Report results for each test (PASS/FAIL + observations). Type "approved" if all tests pass, or describe specific failures.
  </verify>
  <done>
Human confirms all five tests pass: frame times under 16.67ms during active gameplay (Test 1), FPS stays >= 58 for 30 seconds with all object types visible (Test 2), all 9 unique object types render correctly with proper transparency (Test 3), no memory leaks during level switching (Test 4), and no will-change CSS on static cell elements (Test 5).
  </done>
</task>

</tasks>

<verification>
Phase 4 verification spans all four PERF requirements:

- **PERF-01** (Profile rendering): Covered by Task 2 Test 1 (frame times), Test 2 (DOM node count), Test 4 (memory)
- **PERF-02** (60fps validation): Covered by Task 2 Test 1 + Test 2 (30-second stress test)
- **PERF-03** (Transparency layering): Covered by Task 1 check 5 (opacity values) and Task 2 Test 3 (visual regression)
- **PERF-04** (Visual regression): Covered by Task 2 Test 3 (screenshot comparison for all object types)

Memory leak verification (carried forward from Phase 3 VERIFICATION.md) is covered by Task 2 Test 4.
</verification>

<success_criteria>
1. Chrome DevTools Performance tab shows 95%+ of frame times under 16.67ms during active gameplay
2. Performance Monitor shows average FPS >= 58 during 30-second stress test with all object types visible
3. All 9 unique object types render as recognizable SVGs with correct transparency levels
4. No `will-change` CSS property on static `.cell` elements (confirmed both by code grep and DevTools inspection)
5. Memory stays stable (<1MB increase) during repeated level switching
6. Production build succeeds and all 68 unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-validation/04-01-SUMMARY.md`
</output>
