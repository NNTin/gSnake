# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

gSnake is a monorepo containing a browser-based Snake game with a Rust game engine compiled to WebAssembly. Key packages:

- **`gsnake-core/`** — Rust workspace: game engine (`engine/core`), WASM binding (`engine/bindings/wasm`), CLI binding
- **`gsnake-web/`** — Svelte web player (workspace with two sub-packages: `gsnake-web-ui` and `gsnake-web-app`)
- **`gsnake-editor/`** — Svelte level editor + Express API server
- **`gsnake-levels/`** — Rust CLI tools for managing level JSON definitions
- **`e2e/`** — Playwright E2E tests (run from repo root)

## Development Commands

### Start both editor and web player (dev mode)
```bash
npm run dev                       # from repo root — starts editor (3003) and web (3000)
```

Or start each independently:
```bash
# Game player (port 3000)
npm --prefix gsnake-web run dev

# Level editor UI (port 3003) + API server (port 3001)
npm --prefix gsnake-editor run dev
```

### Build WASM (required before running gsnake-web)
```bash
cd gsnake-core/engine/bindings/wasm && wasm-pack build --target bundler
```

Or via npm script (inside gsnake-web-app):
```bash
npm --prefix gsnake-web run build:wasm
```

### Run tests

**Rust (gsnake-core):**
```bash
cargo test --verbose                             # from gsnake-core/
cargo test --test contract_tests --verbose       # from gsnake-core/engine/core/
cargo test generate_contract_fixtures --verbose  # from gsnake-core/engine/core/
```

**gsnake-web (Vitest):**
```bash
npm --prefix gsnake-web run test                 # run once
npm --prefix gsnake-web run test:watch           # watch mode
npm --prefix gsnake-web run coverage             # coverage report
```

**gsnake-editor (Vitest):**
```bash
npm --prefix gsnake-editor run test              # run once
npm --prefix gsnake-editor run test:watch        # watch mode
npm --prefix gsnake-editor run coverage          # coverage report
```

**E2E (Playwright, from repo root):**
```bash
npm run test:e2e
```
E2E requires all three servers running: web preview (3000), editor UI (3003), editor API (3001). In CI these are started separately and health-checked before tests run.

### Lint and format (gsnake-editor)
```bash
npm --prefix gsnake-editor run lint
npm --prefix gsnake-editor run format            # Prettier write
npm --prefix gsnake-editor run format:check      # Prettier check only
```

### Type checking
```bash
npm --prefix gsnake-web run check                # svelte-check
npm --prefix gsnake-editor run check             # svelte-check + tsc
cargo check                                      # from gsnake-core/
```

### Level schema validation
```bash
npm run test:level-schema                        # from repo root
```

### Git hooks (optional, runs pre-commit checks locally)
```bash
.github/hooks/enable-all-hooks.sh               # enable for all repos
```

## Architecture

### Data Flow

**Rust → WASM → TypeScript → Svelte:**

1. `gsnake-core/engine/core` implements all game logic (GameEngine, physics, level parsing)
2. `gsnake-core/engine/bindings/wasm` wraps the engine with `wasm-bindgen` → built to `pkg/` by `wasm-pack`
3. `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts` wraps the WASM module, emits typed events (`frameChanged`, `levelChanged`, `engineError`)
4. `gsnake-web/packages/gsnake-web-app/stores/stores.ts` connects engine events to Svelte writable stores
5. Svelte components subscribe to stores and re-render reactively

**Types are generated from Rust** via `ts-rs` into `gsnake-web/packages/gsnake-web-app/types/models.ts` — **do not edit this file manually**.

### Key Abstractions

- **`Frame`** — Immutable snapshot of game state: a 2D grid of `CellType` values + `GameState`. Generated after each move. The initial frame must be explicitly fetched via `getFrame()` after loading a level — the `onFrame` callback only fires on `processMove()`.
- **`CellType`** — Rust enum with 10 variants: `Empty`, `SnakeHead`, `SnakeBody`, `Food`, `Obstacle`, `Exit`, `FloatingFood`, `FallingFood`, `Stone`, `Spike`.
- **`GameEvent`** — Discriminated union (`frameChanged | levelChanged | engineError`) emitted by `WasmGameEngine.ts` and consumed by stores.
- **`LevelDefinition`** — JSON-serializable level schema. Source of truth is in `gsnake-core`; the editor's `LevelExportPayload` must conform to this contract.

### Critical Initialization Pattern

See `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md` for the canonical frame-emission rules. In short:
1. Register `onFrame` callback
2. Immediately call `getFrame()` and emit `frameChanged` (otherwise the grid never renders on load)
3. Gameplay calls `processMove()` which triggers the callback automatically

### Port Map
| Service | Port |
|---------|------|
| gsnake-web (game player) | 3000 |
| gsnake-editor API (Express) | 3001 |
| gsnake-editor UI (Vite) | 3003 |

### gsnake-web Package Structure

`gsnake-web` is itself a workspace with two packages:
- **`gsnake-web-ui`** — Shared Svelte component library (sprites, CSS). Built separately, used as a local file dependency by the editor.
- **`gsnake-web-app`** — The actual game application. Depends on `gsnake-wasm` (local file dep pointing to the built WASM pkg) and `gsnake-web-ui`.

## Conventions

- **No default exports** — use named exports everywhere
- **TypeScript strict mode** — no implicit any; use `import type` for type-only imports
- **Error type** — errors are normalized to `ContractError { kind, message, context? }` and emitted as `engineError` events
- **Test pattern** — `beforeEach` creates fresh instances; `afterEach` detaches listeners and restores mocks; use factory functions (`createLevel()`, `createFrame()`) for test data
- **Store assertions** — use `get(store)` from `svelte/store` to read current value in tests
- **Vitest mocking** — use stub classes or `vi.fn()`, no external mocking libraries; WASM module is mocked with `vi.hoisted` + a `MockRustEngine` class
- **Coverage threshold** — 80% line/statement in both `gsnake-web` and `gsnake-editor` (enforced as CI merge gate)
- **Editor import safety** — `gsnake-editor` load flows must reject out-of-bounds coordinates before placement; never silently clip/drop entities during import.
- **LevelDefinition API bounds safety** — keep `snake` non-empty (`minItems: 1`) and non-negative coordinates in `contracts/level-definition.schema.json`, and enforce `x < gridSize.width` / `y < gridSize.height` in `gsnake-editor/src/server/levelDefinitionValidator.ts`.
- **LevelDefinition difficulty contract** — keep `difficulty` constrained by schema enum (`easy`, `medium`, `hard`) to match TypeScript difficulty unions used by editor/web models.
- **Editor load-validation consistency** — keep level-file required-field and grid-size checks centralized in `gsnake-editor/src/lib/levelFileValidation.ts`; both `App.svelte` and `EditorLayout.svelte` must call the shared helper.
- **Editor grid-size integer contract** — in `gsnake-editor/src/lib/GridSizeModal.svelte`, enforce integer dimensions with both UI constraints (`step="1"`) and runtime guards (`Number.isInteger`) so `gridSize` always matches schema integer requirements.
- **Editor file-picker launch safety** — in `gsnake-editor/src/lib/EditorLayout.svelte`, wrap hidden-input `appendChild` + `input.click()` in guarded cleanup logic so picker-launch failures cannot leak transient DOM nodes/listeners.
- **Editor sprite safety** — `gsnake-editor/src/lib/SpriteLoader.svelte` must gate on `response.ok` + `image/svg+xml`, then sanitize parsed SVG before rendering; do not inject raw fetched markup.
- **Editor sprite failure diagnostics** — on `SpriteLoader` fetch/validation failures, keep sprite markup unset and expose a visible fallback with `data-sprite-load-error` so missing-asset issues are diagnosable from both UI and tests.
- **Editor API CORS determinism** — resolve `GSNAKE_EDITOR_ALLOWED_ORIGINS` once at startup in `gsnake-editor/server.ts`; do not read env vars per request.
- **Editor server main-module checks** — in `gsnake-editor/server.ts`, detect direct execution via `path.resolve(fileURLToPath(import.meta.url)) === path.resolve(process.argv[1])`; avoid raw `import.meta.url` string comparisons.
- **Editor grid reset ordering** — in `gsnake-editor/src/lib/EditorLayout.svelte`, keep grid reinitialization explicit via `resetGrid(width, height)` calls in load/placement flows; avoid broad reactive `cells` resets that can wipe entities after dimension updates.
- **Editor destructive navigation guard** — in `gsnake-editor/src/lib/EditorLayout.svelte`, gate `handleNewLevel` behind unsaved-change confirmation (`undoStack.length > 0` + `window.confirm(...)`) so canceling preserves in-progress edits and prevents `newLevel` dispatch.
- **Editor snake-direction coherence** — in `gsnake-editor/src/lib/EditorLayout.svelte`, when edit operations clear snake segments to zero, reset `snakeDirection` to the default `east` via a shared helper so toolbar state and exports stay aligned.
- **Editor snake metadata cleanup** — in `gsnake-editor/src/lib/EditorLayout.svelte`, clear snake cells through a shared helper that resets `entity`, `isSnakeSegment`, and `snakeSegmentIndex` together so per-cell metadata cannot drift.
- **Editor test API endpoint config** — `gsnake-editor/src/lib/EditorLayout.svelte` should resolve test uploads from `VITE_GSNAKE_API_URL` (fallback `http://localhost:3001`) and normalize trailing slashes before appending `/api/test-level`.
- **Editor Save/Test required-entity parity** — keep snake/food/exit validation centralized in shared helpers in `gsnake-editor/src/lib/EditorLayout.svelte` so Save warnings and Test preflight blocking rules cannot drift.
- **Editor drag preview safety** — in `gsnake-editor/src/lib/EntityPalette.svelte`, build drag-image SVGs with DOM APIs (`createElementNS`/`setAttribute`) instead of `innerHTML`, and keep dragstart behavior (`setData`, `setDragImage` offsets, cleanup) covered by `src/tests/EntityPalette.test.ts`.

## CI / Merge Gates

Required checks for PRs (`.github/workflows/ci.yml`):
- `core-coverage` — Rust test coverage via `cargo-llvm-cov`
- `gsnake-editor-coverage` — Vitest coverage ≥ 80%
- `gsnake-web-coverage` — Vitest coverage ≥ 80%
- `e2e-test` — Full Playwright E2E suite

The pre-commit hook (when enabled) runs `cargo fmt`, `cargo clippy`, `cargo check`, and `cargo build` on `gsnake-core`, but does **not** run tests or recurse into submodules.
