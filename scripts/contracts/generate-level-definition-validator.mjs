import { existsSync, mkdirSync, readFileSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import Ajv2020 from "ajv/dist/2020.js";
import standaloneCode from "ajv/dist/standalone/index.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, "../..");

const schemaPath = path.join(repoRoot, "contracts", "level-definition.schema.json");
const outputDir = path.join(repoRoot, "contracts", "generated");
const outputPath = path.join(outputDir, "level-definition-validator.ts");
const schemaKey = "levelDefinition";
const exportName = "validateLevelDefinition";
const isCheckOnly = process.argv.includes("--check");

function buildGeneratedModule() {
  const schema = JSON.parse(readFileSync(schemaPath, "utf8"));
  const ajv = new Ajv2020({
    allErrors: true,
    strict: true,
    code: {
      esm: true,
      source: true,
      lines: true,
    },
  });

  ajv.addSchema(schema, schemaKey);
  const standaloneModule = standaloneCode(ajv, { [exportName]: schemaKey })
    .replace(
      /const (\w+) = require\("([^"]+)"\)\.default;/g,
      'import $1 from "$2.js";',
    )
    .trimEnd();

  return [
    "// @ts-nocheck",
    "// This file is generated by scripts/contracts/generate-level-definition-validator.mjs.",
    "// Do not edit this file manually.",
    "",
    standaloneModule,
    "",
    "export function isLevelDefinition(data: unknown): boolean {",
    "  return Boolean(validateLevelDefinition(data));",
    "}",
    "",
    "function normalizeFieldPath(instancePath, params) {",
    "  if (params && typeof params === \"object\") {",
    "    if (typeof params.missingProperty === \"string\") {",
    "      return `${instancePath || \"$\"}.${params.missingProperty}`;",
    "    }",
    "    if (typeof params.additionalProperty === \"string\") {",
    "      return `${instancePath || \"$\"}.${params.additionalProperty}`;",
    "    }",
    "  }",
    "  return instancePath || \"$\";",
    "}",
    "",
    "export function getLevelDefinitionValidationIssues() {",
    "  return (validateLevelDefinition.errors ?? []).map((error) => ({",
    "    field: normalizeFieldPath(error.instancePath, error.params),",
    "    keyword: error.keyword,",
    "    message: error.message ?? \"validation error\",",
    "  }));",
    "}",
    "",
  ].join("\n");
}

const generatedModule = buildGeneratedModule();

if (isCheckOnly) {
  if (!existsSync(outputPath)) {
    console.error(`Generated validator is missing: ${path.relative(repoRoot, outputPath)}`);
    console.error("Run: npm run generate:level-validator");
    process.exit(1);
  }

  const currentModule = readFileSync(outputPath, "utf8");
  if (currentModule !== generatedModule) {
    console.error("Generated validator is out of date. Run: npm run generate:level-validator");
    process.exit(1);
  }

  console.log(`Generated validator is up to date: ${path.relative(repoRoot, outputPath)}`);
  process.exit(0);
}

mkdirSync(outputDir, { recursive: true });
writeFileSync(outputPath, generatedModule);
console.log(`Generated ${path.relative(repoRoot, outputPath)} from ${path.relative(repoRoot, schemaPath)}`);
