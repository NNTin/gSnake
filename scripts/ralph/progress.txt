## Codebase Patterns
- Coverage behavior should be changed via each package's `coverage` command first; workflows should call those commands instead of duplicating coverage flags.
- For `gsnake-web`, enforce coverage gates in `vitest.config.ts` via `test.coverage.thresholds`; CI coverage jobs call `npm run coverage` and inherit those limits.
- For `gsnake-editor`, enforce coverage gates in `vitest.config.ts` via `test.coverage.thresholds`; standalone and root CI coverage jobs both call `npm run coverage` and inherit those limits.
- In local `scripts/test/test_act.sh` runs, `actions/upload-artifact` steps can fail with missing `ACTIONS_RUNTIME_TOKEN`; use pre-upload step results to judge actual test/coverage health.
- For `gsnake-web` `WasmGameEngine` unit tests, mock `gsnake-wasm` with `vi.hoisted` shared state and a local `MockRustEngine` class to drive init/error branches deterministically.
- For `gsnake-web` store wiring tests, drive event-order transitions with a small fake engine (`engineError` followed by `frameChanged`) to assert stale errors are cleared and frame state is resynced.
- For `gsnake-web` component tests, keep `vitest.config.ts` aligned with Vite (`svelte`, `vite-plugin-wasm`, `vite-plugin-top-level-await`) and use `// @vitest-environment jsdom` plus `context` maps when components rely on `getContext`.
- For `gsnake-web` `GameContainer` UI tests, inject a `GAME_ENGINE` context stub (`loadLevel`, `restartLevel`, `processMove`) and drive `gameState`/`level` stores to assert status-specific CTA visibility via `data-element-id` selectors.
- For `gsnake-editor` server API tests, call `resetTestLevelForTests()` in `beforeEach` so module-scoped in-memory storage does not leak state between requests/assertions.
- For `gsnake-editor` export/ID logic, keep pure helpers in `src/lib/levelModel.ts` and call them from Svelte components so unit tests cover runtime payload contracts without UI harness setup.
- For `gsnake-editor` Svelte component tests, keep `vitest.config.ts` aligned with `vite.config.ts` and do not force runes mode while components still use legacy `export let` syntax.
- For `gsnake-editor` load flows that change grid dimensions and then hydrate entities, `await tick()` between dimension updates and `placeEntitiesFromLevelData(...)` so reactive grid reinitialization does not wipe imported entities.
- For `gsnake-editor` grid interaction tests, target cells with `.cell[data-row][data-col]` and assert snake labels (`H`, `1`, `2`, ...) to verify segment reindexing after removals and undo/redo.
- For `gsnake-editor` save validation, count `food`, `floating-food`, and `falling-food` together so modal warnings stay consistent with exported `totalFood`.
- For `gsnake-core` branch-coverage work, place tests in `engine/core/src/*.rs` modules so they can mutate private `GameEngine`/`LevelState` fields without adding production-only hooks.
- For `gsnake-core` wasm binding unit tests on native targets, keep parsing/callback logic in pure helpers and avoid creating `JsValue`/`Function` test fixtures directly because `wasm-bindgen` JS shims panic outside `wasm32`.
- For `gsnake-core` CLI coverage, keep parser/exit failure assertions in unit tests inside `engine/bindings/cli/src/*.rs` and use temp JSON files to cover missing-file, malformed-JSON, and invalid-key playback errors.
- For `gsnake-levels` tests that change process cwd (`find_levels_root` paths), use a shared test guard (`src/test_cwd.rs`) to serialize cwd mutation and always restore the original directory.
- For `gsnake-levels` CLI error-path coverage, add integration tests that run `env!("CARGO_BIN_EXE_gsnake-levels")` from temp directories and assert both exit code `1` and stable stderr fragments.
- For root Playwright gameplay flow tests, use `data-element-id` selectors plus a numeric counter helper (`moves-display`) so each keyboard action asserts deterministic move increments instead of relying on timing-only waits.
- For root Playwright editor-to-web E2E handoff tests, poll editor/web/API service readiness (`3003`, `3000`, `3001`) before UI steps and round-trip exported JSON via `download` + `filechooser` to keep save/load assertions deterministic in CI.

## 2026-02-08 23:57 - US-001
- Defined and documented a single package-level coverage command contract for gsnake-web, gsnake-editor, gsnake-core, and gsnake-levels
- Added `coverage` npm scripts for JS packages and reusable `scripts/coverage.sh` scripts for Rust packages
- Updated root and submodule CI coverage jobs to call package-level commands instead of inline coverage invocations
- Standardized and documented coverage output locations: `coverage/` for JS packages and `target/llvm-cov/lcov.info` for Rust packages
- Verified all four coverage commands run successfully locally
- Verified typecheck and test commands pass for all four packages
- **Files changed:**
  - Modified: README.md
  - Modified: .github/workflows/ci.yml
  - Modified: gsnake-web/package.json
  - Modified: gsnake-web/README.md
  - Modified: gsnake-web/.github/workflows/ci.yml
  - Modified: gsnake-editor/package.json
  - Modified: gsnake-editor/README.md
  - Modified: gsnake-editor/.github/workflows/ci.yml
  - Modified: gsnake-core/README.md
  - Created: gsnake-core/scripts/coverage.sh
  - Modified: gsnake-levels/README.md
  - Created: gsnake-levels/scripts/coverage.sh
  - Modified: gsnake-levels/.github/workflows/ci.yml
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Package-level coverage commands are now the source of truth for CI and local runs; update these first when changing coverage behavior
  - For Rust packages, keep coverage flags in `scripts/coverage.sh` to avoid drift between different workflow files
  - Keep coverage outputs package-local (`coverage/` or `target/llvm-cov/lcov.info`) so artifact uploads stay stable across root and standalone workflows
---
## 2026-02-09 00:34 - US-002
- Added `WasmGameEngine` unit tests for init failure on level loading, contract-error passthrough mapping, and reset behavior after next-level progression
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check` and `npm --prefix gsnake-web run test`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-web/tests/unit/WasmGameEngine.test.ts
  - Modified: gsnake-web/engine/CLAUDE.md
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `WasmGameEngine` emits fallback `initializationFailed` errors for level-load failures, and preserves full contract errors when already in contract shape
  - Reset behavior can be validated by asserting constructor invocations in the mocked Rust engine (`init` + `nextLevel` + `resetLevel`)
  - Full act refresh currently reports coverage gate failures across package and root coverage jobs; functional/typecheck/test jobs remain green
---
## 2026-02-09 01:28 - US-003
- Added explicit `gsnake-web` store wiring tests for `levelChanged`, `frameChanged`, and `engineError` handling, including stale error clearing when a new frame arrives
- Verified `gameState` and `snakeLength` synchronization from `frameChanged` events and kept contract debug exposure coverage with and without `contractTest=1`
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-web/tests/unit/stores.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/CLAUDE.md
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Store wiring tests are easiest to keep deterministic by emitting engine events in sequence through a fake listener-based engine rather than mocking Svelte internals
  - To validate `frameChanged` recovery, set `engineError` first via `engineError` event and assert it is cleared after the next `frameChanged` event
  - CI status refresh currently remains blocked by coverage gate jobs across package and root workflows even when functional/test/typecheck jobs pass
---
## 2026-02-09 02:24 - US-004
- Added `gsnake-web` component tests for level selector open/close, selecting a level, and level-load-error modal display/dismiss behavior
- Updated `gsnake-web` Vitest config to load Svelte components in tests by reusing the Vite plugin stack
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Modified: gsnake-web/vitest.config.ts
  - Added: gsnake-web/tests/unit/LevelUiFlows.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `LevelSelectorOverlay` tests that click level cards need async flush cycles after click because `selectLevel` awaits `loadLevel` before closing the overlay store
  - For components that use Svelte stores directly, instantiate components against `document.body` and assert both visible labels/buttons and store state transitions
  - CI full refresh continues to fail only on coverage gates while functional/typecheck/test/e2e jobs remain green
---
## 2026-02-09 03:19 - US-005
- Added `gsnake-web` UI flow tests for level-complete/all-complete states, game-over CTAs, header restart button behavior, and keyboard restart/back actions driven by UI state
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Modified: gsnake-web/tests/unit/LevelUiFlows.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `GameContainer` tests should always provide a full `GAME_ENGINE` stub because restart controls and game-over modal actions both rely on context methods
  - To validate restart-related CTAs, set `gameState` to `GameOver` and `AllComplete` explicitly and assert modal action buttons by `data-element-id`
  - CI full refresh still fails only on coverage gates while functional/typecheck/test/e2e jobs remain green
---
## 2026-02-09 04:15 - US-006
- Added negative-path API tests for `POST /api/test-level` (missing payload, malformed field types, malformed JSON body) and unsupported methods on `/api/test-level`
- Hardened `gsnake-editor` server behavior with runtime payload schema validation, structured `400` JSON errors, and explicit `405` responses with `Allow` header
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run lint` (lint only reports warnings from generated coverage files)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-editor/server.ts
  - Modified: gsnake-editor/src/tests/server.test.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `gsnake-editor/server.ts` stores test levels in module-scoped memory; export/use `resetTestLevelForTests()` in test suites to keep API tests deterministic
  - API negative-path tests in this repo should assert structured JSON error contracts (`error` plus `details`/`allowedMethods`) and `Allow` headers for `405`
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 05:12 - US-007
- Added `gsnake-editor` model tests for uint32 ID validation boundaries/invalid inputs, deterministic ID generation behavior, and export payload contract shape/field naming
- Extracted shared editor model logic into `src/lib/levelModel.ts` (`isValidLevelId`, `generateLevelId`, `buildLevelExportPayload`) and wired `App.svelte` + `EditorLayout.svelte` to use it
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Added: gsnake-editor/src/lib/levelModel.ts
  - Modified: gsnake-editor/src/App.svelte
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/src/tests/types.test.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Move reusable Svelte component logic (ID validation and export serialization) into plain `src/lib/*.ts` helpers first, then call from components to keep tests deterministic and lightweight
  - Export payload contract checks should assert camelCase keys (`gridSize`, `snakeDirection`) and reject snake_case variants to mirror gsnake-core contract expectations
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 06:09 - US-008
- Added `gsnake-editor` `EditorLayout` component tests covering save modal opening, export/download payload flow, valid JSON load rendering, and invalid load toast feedback
- Fixed load hydration ordering in `EditorLayout` by awaiting a Svelte tick after grid dimension updates before applying loaded entities, preventing reactive grid reset from clearing imported state
- Updated `gsnake-editor` Vitest Svelte plugin setup to match Vite config (no forced runes mode) so legacy `export let` components compile in tests
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint` (warnings only from generated coverage files), `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Added: gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/vitest.config.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `EditorLayout` load tests can mock `input[type=file]` payloads with file-like objects exposing `text()` instead of relying on environment-specific `File`/`Blob` APIs
  - For save-export UI tests, assert `URL.createObjectURL` inputs and anchor-click side effects to cover download behavior without filesystem/network dependencies
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 07:02 - US-009
- Added `gsnake-editor` `EditorLayout` interaction tests for grid placement/removal, snake segment reindexing during edits, and multi-step undo/redo behavior with redo clearing on new actions
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Added: gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts
  - Added: gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/vitest.config.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Undo/redo regression tests for `EditorLayout` are easiest to stabilize by asserting toolbar button enabled states alongside grid cell classes and snake index labels
  - Use Shift+click in component tests (`fireEvent.click(cell, { shiftKey: true })`) to cover the removal path and segment-index compaction logic
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 07:59 - US-010
- Expanded `gsnake-core` engine/gravity coverage with targeted tests for non-playing and empty-snake move rejection, blocked stone pushes, gravity spike death paths, floating/falling food collection, and frame generation guardrails
- Added gravity unit tests for immediate spike contact, stone support, and solid-exit support to cover previously untested fall-stop branches
- Verified `gsnake-core` checks pass with `cargo check --workspace --all-targets`, `cargo test`, `./scripts/coverage.sh`, and `cargo llvm-cov --package gsnake-core --all-targets --summary-only` (engine line coverage 98.34%, gravity 100%)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-core/engine/core/src/engine.rs
  - Modified: gsnake-core/engine/core/src/gravity.rs
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - For `GameEngine::process_move` branch coverage, build deterministic layouts that isolate one decision point (stone push outcome, gravity hit, or status gate) to avoid unrelated gravity/collision side effects
  - `generate_frame` guardrail branches are easiest to cover with explicit invalid dimensions (`<= 0`) and oversized grids (`> MAX_FRAME_CELLS`) rather than huge fixtures
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 09:51 - US-011
- Expanded `gsnake-core` wasm binding coverage by refactoring `engine/bindings/wasm/src/lib.rs` into testable helpers for initialization, direction parsing, move processing, callback emission, and error conversion
- Added targeted wasm-binding unit tests for initialization/error mapping, direction parsing edge cases, callback success/failure behavior, and contract error kind mapping
- Verified compatibility with web contract types via `npm --prefix gsnake-web run test -- tests/contract` (41 contract tests passed)
- Verified `gsnake-core` checks pass with `cargo test -p gsnake-wasm`, `cargo check --workspace --all-targets`, `cargo test --workspace`, `cargo fmt --all --check`, and `./scripts/coverage.sh`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-core/engine/bindings/wasm/src/lib.rs
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Keep wasm-facing logic thin and route parsing/callback/error branches through pure helper functions so native Rust unit tests can cover behavior without wasm harnesses
  - `wasm-bindgen` host tests should avoid creating JavaScript-backed values (`JsValue::from_str`, JS `Function`) directly because these require wasm runtime shims and can panic on native targets
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 10:47 - US-012
- Expanded `gsnake-core` CLI coverage with tests for input key mappings, playback parse failure paths, invalid/malformed playback files, and single-level exit behavior messaging
- Verified `gsnake-core` checks pass with `cargo fmt --all --check`, `cargo check --workspace --all-targets`, `cargo test -p gsnake-cli`, and `cargo llvm-cov --package gsnake-cli --all-targets --summary-only` (input line coverage 87.69%, playback line coverage 98.59%)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-core/engine/bindings/cli/src/input.rs
  - Modified: gsnake-core/engine/bindings/cli/src/playback.rs
  - Modified: gsnake-core/engine/bindings/cli/src/main.rs
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - CLI parser failure-path coverage is deterministic when tests create temp playback JSON files and assert contextual errors from `Playback::from_input_file(...)`
  - In single-level mode, `finalize_exit` is the canonical failure gate and should keep returning `Level not completed` until completion status is reached
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 11:45 - US-013
- Expanded `gsnake-levels` coverage for `generate-levels-json` and `sync-metadata` with success/failure-path tests plus root/package cwd resolution tests
- Fixed a metadata-sync bug where difficulty filters were not normalized; `sync_metadata` now trims/lowercases difficulty input and rejects unknown values with an explicit error
- Verified `gsnake-levels` checks pass with `cargo check --workspace --all-targets`, `cargo test`, `./scripts/coverage.sh`, and `cargo llvm-cov --summary-only` (`generate.rs` line coverage 94.27%, `sync_metadata.rs` line coverage 95.78%)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-levels/src/generate.rs
  - Modified: gsnake-levels/src/sync_metadata.rs
  - Modified: gsnake-levels/src/lib.rs
  - Modified: gsnake-levels/src/main.rs
  - Added: gsnake-levels/src/test_cwd.rs
  - Modified: gsnake-levels (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - For cwd-sensitive command tests, guard `std::env::set_current_dir` with a shared mutex to avoid racey test failures under parallel Rust test execution
  - Keep difficulty normalization centralized before generating TOML and playback paths so single-difficulty sync uses canonical folder names
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 12:42 - US-014
- Expanded `gsnake-levels` verification/playback coverage with deterministic failure-path tests for `verify_level` (missing level/playback resources, malformed playback JSON, game-over and not-complete outcomes)
- Added `verify-all` tests for playback-path inference failure, missing-level errors, missing-playback skip behavior, and solved-status updates when verification fails
- Added CLI integration tests that run `gsnake-levels` commands and assert deterministic stderr fragments and exit status `1` for `verify`/`verify-all` failure scenarios
- Verified `gsnake-levels` checks pass with `cargo fmt --all --check`, `cargo check --workspace --all-targets`, `cargo test`, and `cargo llvm-cov --summary-only` (`verify.rs` line coverage 98.96%, `verify_all.rs` line coverage 96.58%)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-levels/src/verify.rs
  - Modified: gsnake-levels/src/verify_all.rs
  - Added: gsnake-levels/tests/cli_error_paths_test.rs
  - Modified: gsnake-levels (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Prefer temp-fixture level/playback files over repo fixtures for verify-path tests so assertions remain stable when generated level IDs change
  - For CLI exit-behavior tests, assert concise stderr substrings (`Failed to resolve playback path`, `Level file not found`) instead of absolute paths to keep tests deterministic across environments
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 14:34 - US-015
- Added a root Playwright gameplay progression scenario that covers level completion, level transition to Level 2, game-over modal behavior, and both button/keyboard restart flows
- Hardened the E2E assertions with a move-counter helper to validate deterministic state transitions after each key press
- Verified checks with `npm run test:e2e -- e2e/gravity.spec.ts`, `npm run test:e2e`, `npm --prefix gsnake-web run check`, and `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: e2e/gravity.spec.ts
  - Modified: gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm_bg.wasm
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - For gameplay E2E, assert move counter increments (`data-element-id="moves-display"`) on every key press to reduce flakiness when frame timing varies
  - Validate restart behavior through both UI CTA (`restart-level-btn`) and keyboard input (`Space`) to cover modal and input-path regressions in one scenario
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 15:31 - US-016
- Added a robust Playwright editor workflow scenario covering create, entity placement, save/export download, landing-page reload, in-editor reload, and test-mode handoff to gsnake-web
- Added API-backed handoff assertions for POST/GET `/api/test-level` payload consistency and popup test-mode rendering checks in gsnake-web
- Verified checks with `npm run test:e2e -- e2e/level-editor.spec.ts`, `npm run test:e2e`, and `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Modified: e2e/level-editor.spec.ts
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
  - Modified: scripts/test/result.txt
- **Learnings for future iterations:**
  - For editor save/load E2E flows, capture exported files via Playwright `download.saveAs(...)` and feed the same file back through `filechooser.setFiles(...)` to validate round-trip state
  - To keep editor/web integration tests stable, explicitly wait for all three services (editor UI, web UI, editor API) before triggering UI interactions and popup-based handoff checks
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 16:26 - US-017
- Fixed editor save validation so floating and falling food count as food, preventing false "No food placed" warnings for valid levels
- Added a regression test that places only floating food and verifies the save modal shows `Export` (no no-food warning)
- Verified `gsnake-editor` checks with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, and `npm --prefix gsnake-editor run test`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Save-modal validation in `EditorLayout` must treat `food`, `floating-food`, and `falling-food` as equivalent edible entities to stay consistent with exported `totalFood`
  - Regression tests for validation warnings are stable when asserting modal button label (`Export` vs `Export Anyway`) in addition to warning text
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 17:19 - US-018
- Raised `gsnake-web` Vitest coverage thresholds to enforce an 80% line gate in the package coverage command used by CI
- Updated `gsnake-web` README coverage section to document the enforced 80% line/statement floor
- Verified `gsnake-web` checks with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 18 passed, 7 failed)
- **Files changed:**
  - Modified: gsnake-web/vitest.config.ts
  - Modified: gsnake-web/README.md
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/CLAUDE.md
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `gsnake-web` coverage enforcement is controlled by `test.coverage.thresholds` in `vitest.config.ts`; workflow coverage jobs pick it up via `npm run coverage`
  - In local `act` runs, coverage jobs may still fail at `actions/upload-artifact` with missing `ACTIONS_RUNTIME_TOKEN` even when coverage tests themselves pass
  - This refresh also showed an `e2e-test` infrastructure failure from `wasm-pack` release download HTTP 500, which is external to coverage-threshold changes
  - Keep README coverage notes aligned with enforced thresholds to reduce confusion during CI triage
---
## 2026-02-09 18:22 - US-019
- Raised `gsnake-editor` Vitest coverage thresholds to enforce an 80% line gate in the package coverage command used by CI
- Updated `gsnake-editor` README coverage section to document the enforced 80% line threshold
- Verified `gsnake-editor` checks with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run coverage` (`83.2%` lines)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 17 passed, 8 failed; `gsnake-editor` coverage test steps passed and job failures remained at artifact upload under local `act`)
- **Files changed:**
  - Modified: gsnake-editor/vitest.config.ts
  - Modified: gsnake-editor/README.md
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `gsnake-editor` coverage enforcement should be tuned in `vitest.config.ts` thresholds; both standalone and root coverage workflows inherit it through `npm run coverage`
  - In `act` runs, confirm coverage-gate success from the `Run coverage` step and summary before treating `upload-artifact` `ACTIONS_RUNTIME_TOKEN` failures as true coverage regressions
  - Full `act` refresh now shows broader non-story failures (`gsnake-levels` test/coverage, root `wasm`, root `core-coverage`, root `gsnake-web-coverage`) while editor build/typecheck/test remain green
---
