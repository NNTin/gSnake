## Codebase Patterns
- For `gsnake-editor` Svelte 5 component-event unit tests, attach handlers via `render(Component, { events: { ... } })` rather than `component.$on(...)`, because testing-library exports no longer expose legacy component event APIs.
- For gsnake-web enum contract drift checks, keep runtime enum guard constants in `gsnake-web/packages/gsnake-web-app/contracts/enumGuards.ts` and assert parity against both generated TS unions (`types/models.ts`) and Rust wire enums (`gsnake-core/engine/core/src/models.rs`) so cross-language mismatch fails tests.
- For `gsnake-wasm` in `WasmGameEngine.ts`, import as a namespace and treat the default initializer as optional because generated `pkg/gsnake_wasm.js` may omit a default export while unit-test mocks still provide one.
- For `gsnake-editor/src/tests/integration.test.ts`, keep live endpoint checks opt-in with `GSNAKE_EDITOR_LIVE_INTEGRATION=1` and use explicit `it.skip` semantics by default, so CI avoids false-green placeholder assertions while enabled runs still enforce real HTTP contract checks.
- For `gsnake-editor/src/lib/levelModel.ts` export payload generation, treat `exit` as optional (`null` when absent), preserve `snake: []` when no segments are provided, and document duplicate-exit resolution as "last encountered exit wins" in row-major grid traversal.
- For `gsnake-editor` load/render assertions, prefer sprite-level checks on each target cell (`.cell-sprite use[href*="#<SpriteId>"]`) instead of generic `.has-entity` so entity-type regressions are detectable.
- For `e2e/contract.spec.ts`, load deterministic fixture levels through `levelsUrl` using a `data:application/json,...` URL when asserting `CellType` coverage so tests are not coupled to mutable default levels or the editor API test server.
- For gameplay-flow E2E specs like `e2e/gravity.spec.ts`, keep deterministic fixture levels and fixture-owned solution key arrays in the spec, then assert move totals from `solutionKeys.length` so completion checks stay stable when default levels change.
- In the `gsnake-core` workspace, run package-targeted checks with `cargo ... -p gsnake-core` (hyphenated package name); `gsnake_core` is the Rust crate import path, not the Cargo package ID.
- For `KeyboardHandler` unit coverage, set `gameState` per status (`Playing`, `GameOver`, `LevelComplete`, `AllComplete`) and assert side-effect exclusivity (`processMove` vs `restartLevel` vs `loadLevel`) so shortcut regressions are caught at state boundaries.
- For `WasmGameEngine`, treat `loadLevel(levelNumber)` as a 1-based public API and keep regression tests for both `loadLevel(2)` happy path events and `loadLevel(0)` invalid-index rejection (`Invalid level index: -1`) to catch boundary drift.
- For `WasmGameEngine` terminal transitions, keep `nextLevel()` as a no-op on the final index and normalize final-level `LevelComplete` frames to `AllComplete` in the wrapper so web end-of-game UI remains stable without Rust `total_levels` wiring.
- For `CompletionTracker`, treat localStorage as untrusted I/O: parse failures or non-array payloads should resolve to `[]`, and `markCompleted(...)` must catch `setItem` write failures instead of throwing.
- For Playwright popup flows in `e2e/*`, avoid `waitForTimeout(...)`; wait on `domcontentloaded` plus a deterministic ready selector such as `[data-element-id="game-field"]` and pair it with a positive visibility assertion.
- For `e2e/contract.spec.ts` keyboard-ordering checks, synchronize opposite-direction keypresses on deterministic frame progress (`frame.state.moves` increment via `waitForFunction`) instead of fixed sleeps to keep CI timing stable.
- For rendered-grid E2E checks in `e2e/snake-bugs.spec.ts`, extract `SnakeHead`/`SnakeBody` from `[data-element-id="game-field"] .cell use[href]` and map row-major DOM indices back to coordinates (`x = idx % width`, `y = floor(idx / width)`) so tests assert visual state instead of only API payloads.
- For `gsnake-web-app` store-driven `snakeLength`, count only `SnakeHead` and `SnakeBody`; keep regression tests with mixed extended cell types (`Stone`, `Spike`, `FloatingFood`, `FallingFood`) and a zero-snake frame to prevent accidental overcounting.
- For editor API contract E2E coverage, keep shared `POST`/`GET` `/api/test-level` assertions centralized in `e2e/workflow.spec.ts` and add only non-overlapping checks elsewhere to avoid duplicate maintenance and CI runtime.
- For root Playwright startup, run `gsnake-editor` UI/API as separate `webServer` entries (`dev:editor` + `dev:server`) and keep a global `/health` preflight (`e2e/global-setup.ts`) so API-dependent specs fail early with service-specific diagnostics.
- For `Cell` opacity coverage in `gsnake-web/packages/gsnake-web-app/tests/unit/Cell.test.ts`, keep an explicit table for all 10 `CellType` variants so style checks catch both default-opacity and special-opacity regressions.

# Ralph Progress Log
Started: Fri Feb 20 10:55:27 CET 2026
---

## [2026-02-20 11:00:51 CET] - US-001
- Replaced tautological enum contract tests with runtime assertions backed by production guard arrays and cross-checked against generated TS unions plus Rust enum serialization names.
- Added reusable runtime enum guard constants/type guards and updated WASM import initialization handling to satisfy package typecheck without relying on a guaranteed default export.
- Files changed: `gsnake-web/packages/gsnake-web-app/contracts/enumGuards.ts`, `gsnake-web/packages/gsnake-web-app/tests/contract/enums.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Runtime enum contract tests are strongest when they compare three sources: production guard arrays, generated TS bindings, and Rust enum wire values.
  - `gsnake-wasm` module shape can differ between generated artifacts and mocks; default initializer should be feature-detected before calling.
  - `npm run check` for `gsnake-web-app` catches module-shape/type issues that `vitest` can miss due to mocking.
---

## [2026-02-20 11:05:37 CET] - US-002
- Reworked editor integration tests to remove unconditional pass fallbacks and replaced them with explicit opt-in skip semantics plus strict runtime assertions against `VITE_GSNAKE_WEB_URL` and `?test=true` route contracts.
- Files changed: `gsnake-editor/src/tests/integration.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Live cross-service checks in unit-test suites should be opt-in and skipped explicitly when the environment is not provisioned, instead of passing vacuously.
  - Integration assertions should validate concrete response contracts (status/content-type/app shell marker) so endpoint regressions produce a hard failure.
  - `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, and `npm --prefix gsnake-editor test` provide sufficient local quality gates for editor test-only changes.
---

## [2026-02-20 11:10:35 CET] - US-003
- Expanded `e2e/contract.spec.ts` CellType allowlists to the full 10-variant contract set and added a dedicated fixture-level E2E scenario that asserts `FloatingFood`, `FallingFood`, `Stone`, and `Spike` each appear in the runtime frame.
- Files changed: `e2e/contract.spec.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Use `levelsUrl` with a `data:application/json,...` fixture in Playwright when you need deterministic level content without relying on `/api/test-level`.
  - Keep CellType allowlists centralized (for example `ALL_CELL_TYPES`) to prevent partial-contract drift across E2E scenarios.
  - `npx playwright test e2e/contract.spec.ts --project=chromium --reporter=list` is a fast targeted validation loop for contract-grid changes.
---

## [2026-02-20 11:18:27 CET] - US-004
- Verified and locked Rust contract coverage for all 10 `CellType` variants in both serialization and round-trip tests (`Empty`, `SnakeHead`, `SnakeBody`, `Food`, `Obstacle`, `Exit`, `FloatingFood`, `FallingFood`, `Stone`, `Spike`).
- Ran targeted Rust quality checks to confirm this story stays green.
- Files changed: `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - `cargo test --test contract_tests test_celltype_` is a fast targeted check for enum wire-contract coverage in `gsnake-core/engine/core/tests/contract_tests.rs`.
  - In the workspace, use `cargo check -p gsnake-core` (hyphenated package name) for package-scoped compile checks.
  - When a PRD story is already implemented in code, still record verification evidence in `progress.txt` before marking `passes: true`.
---

## [2026-02-20 11:20:26 CET] - US-005
- Added missing `KeyboardHandler` unit coverage for `Playing` shortcuts (`r` -> `restartLevel`, `q` -> `loadLevel(1)`) and `LevelComplete` no-op behavior.
- Verified keyboard tests assert no unintended side effects across `processMove`, `restartLevel`, and `loadLevel` for the new scenarios.
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/KeyboardHandler.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In keyboard-state tests, always set `gameState` explicitly before dispatch to avoid relying on prior test status.
  - Shortcut coverage should assert both the expected engine call and the absence of the other two engine actions.
  - For `gsnake-web-app` test-only updates, `npm --prefix gsnake-web/packages/gsnake-web-app run check && npm --prefix gsnake-web/packages/gsnake-web-app test` is a fast, sufficient quality gate.
---

## [2026-02-20 11:23:22 CET] - US-006
- Added `WasmGameEngine` unit coverage for the public `loadLevel()` API, including a successful `loadLevel(2)` transition with `levelChanged`/`frameChanged` event assertions.
- Added `init()` idempotency coverage to confirm a second `init()` call is a no-op that does not reinitialize the WASM bridge or replace loaded levels.
- Added out-of-range boundary coverage to assert `loadLevel(0)` rejects via the expected invalid-index error path.
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - `WasmGameEngine.loadLevel(...)` is intentionally 1-based at the public boundary, so boundary tests should include both valid `2` and invalid `0`.
  - Idempotent-init behavior is externally observable through unchanged `constructedLevels`, one-time wasm init calls, and retained `getLevels()` output.
  - `gsnake-web-app` does not expose a `lint` script; use `npm --prefix gsnake-web/packages/gsnake-web-app run check` plus `npm --prefix gsnake-web/packages/gsnake-web-app test` for package-level quality gates.
---

## [2026-02-20 11:27:18 CET] - US-007
- Added explicit `CompletionTracker` regression coverage for non-array JSON payloads (`42`, `{}`, `null`) and malformed JSON to ensure persistence parsing always degrades safely to an empty completed-level list.
- Hardened `markCompleted(...)` against localStorage write exceptions and verified unit tests assert quota/write failures do not propagate to callers.
- Files changed: `gsnake-web/packages/gsnake-web-app/engine/CompletionTracker.ts`, `gsnake-web/packages/gsnake-web-app/tests/unit/CompletionTracker.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Use `it.each(...)` over serialized payload strings for compact non-array storage regression tests in jsdom-backed unit suites.
  - For storage-backed helpers, treat reads and writes as independent failure points: parse guards in `getCompletedLevels()` plus `setItem` try/catch in `markCompleted(...)`.
  - `npm --prefix gsnake-web/packages/gsnake-web-app run check && npm --prefix gsnake-web/packages/gsnake-web-app test` remains the correct package-level gate for `CompletionTracker` changes.
---

## [2026-02-20 11:30:29 CET] - US-008
- Removed fixed popup sleep in editor integration E2E and replaced it with deterministic, event-driven synchronization (`domcontentloaded` + `[data-element-id="game-field"]` readiness).
- Replaced body-text inversion logic with explicit positive and negative assertions (`game-field` visible and no `Failed to load test level` error marker) so load success is directly validated.
- Files changed: `e2e/editor-integration.spec.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In popup-based Playwright flows, fixed sleeps are less reliable than selector-driven readiness checks tied to stable `data-element-id` hooks.
  - Keep one positive readiness assertion (`toBeVisible`) in addition to error-absence checks to avoid vacuous passes.
  - `npx playwright test e2e/editor-integration.spec.ts --project=chromium --reporter=list` is a fast targeted validation loop for this integration path.
---

## [2026-02-20 11:33:24 CET] - US-009
- Reworked gravity gameplay E2E to use deterministic fixture levels loaded through `levelsUrl` instead of mutable default level content.
- Replaced fixed `11` right-arrow loop with fixture-owned `LEVEL_ONE_SOLUTION_KEYS`, and asserted completion move count via `LEVEL_ONE_SOLUTION_KEYS.length`.
- Kept progression/game-over/restart assertions while validating them against fixture level IDs (`1`, `2`) to preserve stable UI expectations.
- Files changed: `e2e/gravity.spec.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - For E2E progression coverage, pair deterministic fixture levels with explicit per-level solution key arrays; this removes coupling to evolving default level design.
  - If assertions read `[data-element-id=\"level-display\"]`, fixture IDs should align with expected displayed values (the UI shows level IDs, not ordinal index).
  - `npx playwright test e2e/gravity.spec.ts --project=chromium --reporter=list` is a fast validation path for gravity-flow changes.
---

## [2026-02-20 11:35:53 CET] - US-010
- Replaced the fixed 100ms sleep in the 180-degree rejection contract test with deterministic frame-state synchronization by waiting for `frame.state.moves` to increment after the first keypress.
- Preserved the opposite-direction rejection assertion path (`inputRejected`) while removing CI-load-sensitive timing assumptions.
- Files changed: `e2e/contract.spec.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - For keyboard sequencing checks, capture `initialMoves` and wait for `moves + 1` before sending a second directional input to avoid flaky ordering caused by variable frame timing.
  - Root-level `npx playwright test e2e/contract.spec.ts --project=chromium --reporter=list` is a fast validation loop for contract payload and error-path changes.
  - Pair E2E validation with `npm --prefix gsnake-web run check` so type regressions are caught even when the changed file is test-only.
---

## [2026-02-20 11:39:47 CET] - US-011
- Reworked `e2e/snake-bugs.spec.ts` from API-only verification to browser rendering assertions by reading rendered `SnakeHead`/`SnakeBody` markers from the game grid and matching their coordinates against fixture snake segments.
- Added explicit stale-cell regression coverage by uploading a replacement test level, reopening `/?test=true`, and asserting level-A snake coordinates are absent while level-B coordinates render exactly.
- Files changed: `e2e/snake-bugs.spec.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In web-game E2E, `.cell > use[href="#CellType"]` is the most stable rendering contract for asserting which entity type is actually drawn.
  - When asserting rendered coordinates, convert flattened DOM cell index back to grid coordinates using fixture width (`x = idx % width`, `y = floor(idx / width)`).
  - `npx playwright test e2e/snake-bugs.spec.ts --project=chromium --reporter=list` is a fast targeted loop for snake-draw regression checks.
---

## [2026-02-20 11:42:33 CET] - US-012
- Added `buildLevelExportPayload` edge-case coverage for empty snake segments, missing exit cells, and duplicate exit cells.
- Locked duplicate-exit semantics by asserting the last encountered exit in row-major grid iteration is exported.
- Files changed: `gsnake-editor/src/tests/types.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - `buildLevelExportPayload(...)` intentionally preserves `snake: []` when `snakeSegments` is empty; downstream validation should decide whether that payload is acceptable.
  - Missing exit cells are serialized as `exit: null`, which must stay aligned with consumers expecting optional exit in editor export flows.
  - Duplicate exit entities are not deduplicated; export uses the last exit visited during row-major scan (`y` ascending, then `x` ascending).
---

## [2026-02-20 11:45:40 CET] - US-013
- Expanded `EditorLayout.saveLoad.test.ts` load assertions to validate exact sprite markers for `FloatingFood`, `FallingFood`, `Stone`, and `Spike` at their imported coordinates.
- Added a reusable helper for coordinate-based sprite verification and applied it to sequential-load optional-entity checks so assertions stay entity-specific.
- Files changed: `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In editor grid tests, `has-entity` confirms occupancy only; validate optional entity type by asserting the cell sprite `<use href>` suffix (for example `#FloatingFood`).
  - Keep coordinate assertions row/column explicit (`data-row`, `data-col`) so loaded-entity placement regressions are easy to diagnose.
  - `npm --prefix gsnake-editor run check && npm --prefix gsnake-editor run lint && npm --prefix gsnake-editor test` is the appropriate quality gate for editor test updates.
---
## [2026-02-20 11:49:16 CET] - US-014
- Added unit coverage in `gsnake-web/packages/gsnake-web-app/tests/unit/stores.test.ts` for snake-length derivation using a multi-row five-segment snake frame, a zero-snake frame, and mixed extended non-snake cell variants.
- Verified `snakeLength` remains based only on `SnakeHead`/`SnakeBody` while `Stone`, `Spike`, `FloatingFood`, and `FallingFood` do not affect the count.
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/stores.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In `connectGameEngineToStores`, snake-length behavior should be validated through emitted `frameChanged` events rather than direct helper access so tests cover store wiring and counting together.
  - Mixed-cell fixtures should include extended `CellType` variants explicitly to guard against regressions that accidentally treat non-snake entities as snake segments.
  - `npm --prefix gsnake-web/packages/gsnake-web-app run check && npm --prefix gsnake-web/packages/gsnake-web-app test` is a sufficient package-level gate for `stores` test updates.
---
## [2026-02-20 11:56:59 CET] - US-015
- Added `WasmGameEngine` regression coverage proving final-level completion is wrapper-normalized to `AllComplete` while `nextLevel()` remains a terminal no-op with no extra events/engine reconstruction.
- Added deterministic Playwright coverage for final-level completion UI (`All Levels Complete!`) plus keyboard recovery (`q`) back to level 1 with reset move counter.
- Updated wrapper behavior so final-level `LevelComplete` frames emitted by wasm are normalized to `AllComplete` before store/UI propagation.
- Files changed: `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `e2e/gravity.spec.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - The current wasm constructor (`new(level_json)`) does not receive total-level context, so web should own final-level `LevelComplete` -> `AllComplete` normalization.
  - Keep `nextLevel()` semantics explicit in tests: reaching terminal index must be a no-op with stable event counts.
  - When Playwright uses `vite preview`, rebuild `gsnake-web-app` before E2E runs after source changes to avoid stale dist behavior.
---
## [2026-02-20 12:00:45 CET] - US-016
- Consolidated shared `/api/test-level` upload/fetch/CORS assertions into `e2e/workflow.spec.ts` and removed duplicate overlap in `e2e/complete-workflow.spec.ts`.
- Preserved unique API checks by adding runtime schema validation (`isLevelDefinition`) and `totalFood` consistency assertions in the consolidated spec.
- Files changed: `e2e/workflow.spec.ts`, `e2e/complete-workflow.spec.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Keep shared API workflow assertions in one Playwright spec to avoid drift between duplicate tests.
  - Preserve non-overlapping checks as dedicated test steps in the consolidated spec (for example schema guards and derived-field assertions).
  - `npx playwright test e2e/workflow.spec.ts --project=chromium --reporter=list` is a fast targeted validation loop for editor API workflow coverage.
---
## [2026-02-20 12:04:00 CET] - US-017
- Added explicit editor API readiness to Playwright startup by splitting `gsnake-editor` startup into separate `dev:editor` and `dev:server` webServer entries and waiting on `http://localhost:3001/health`.
- Added a shared Playwright global preflight (`e2e/global-setup.ts`) that blocks test execution until web preview, editor UI, and editor API health endpoints are all ready, with service-specific failure messages.
- Files changed: `playwright.config.ts`, `e2e/global-setup.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - A single `npm --prefix gsnake-editor run dev` process can report UI readiness before API readiness; split startup commands when tests depend on both services.
  - Keep service-health validation centralized in Playwright `globalSetup` so missing dependencies fail early with actionable endpoint names.
  - `npx playwright test e2e/workflow.spec.ts e2e/snake-bugs.spec.ts --project=chromium --reporter=list` is a fast smoke check for editor API-dependent E2E paths.
---
## [2026-02-20 12:07:35 CET] - US-018
- Made `Cell` opacity tests explicit with a full 10-variant `CellType` matrix and aligned case naming to show expected opacity per type.
- Verified both special-opacity cells (`Spike`, `Stone`, `Obstacle`) and default-opacity cells are covered in one table-driven unit test.
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/Cell.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Opacity tests should enumerate every `CellType` variant, not a partial sample, so enum additions require explicit styling decisions.
  - Object-based `it.each` cases (`{ type, expectedOpacity }`) keep test names aligned with assertion scope and avoid placeholder-order mistakes.
  - `npm --prefix gsnake-web/packages/gsnake-web-app run check && npm --prefix gsnake-web/packages/gsnake-web-app test` is the right local gate for `gsnake-web-app` unit-test updates.
---
## [2026-02-20 15:37:44 CET] - US-019
- Added `LandingPage` interaction coverage for both primary actions by asserting `createNew` dispatch on button click and `loadExisting` dispatch after selecting a JSON file.
- Kept file-selection behavior testable by capturing the hidden `<input type="file">` created at click time and triggering its `change` event with a concrete `File`.
- Files changed: `gsnake-editor/src/tests/LandingPage.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In this Svelte 5 stack, component event assertions should use `render(..., { events })`; `component.$on(...)` throws `component_api_changed`.
  - For hidden file-picker flows, spying on `document.createElement` is a stable way to capture the generated input and drive `files` + `change` assertions.
  - `npm --prefix gsnake-editor run check && npm --prefix gsnake-editor run lint && npm --prefix gsnake-editor test` is the correct local quality gate for editor component-test changes.
---
