## Codebase Patterns
- Coverage behavior should be changed via each package's `coverage` command first; workflows should call those commands instead of duplicating coverage flags.
- For `gsnake-web` `WasmGameEngine` unit tests, mock `gsnake-wasm` with `vi.hoisted` shared state and a local `MockRustEngine` class to drive init/error branches deterministically.
- For `gsnake-web` store wiring tests, drive event-order transitions with a small fake engine (`engineError` followed by `frameChanged`) to assert stale errors are cleared and frame state is resynced.

## 2026-02-08 23:57 - US-001
- Defined and documented a single package-level coverage command contract for gsnake-web, gsnake-editor, gsnake-core, and gsnake-levels
- Added `coverage` npm scripts for JS packages and reusable `scripts/coverage.sh` scripts for Rust packages
- Updated root and submodule CI coverage jobs to call package-level commands instead of inline coverage invocations
- Standardized and documented coverage output locations: `coverage/` for JS packages and `target/llvm-cov/lcov.info` for Rust packages
- Verified all four coverage commands run successfully locally
- Verified typecheck and test commands pass for all four packages
- **Files changed:**
  - Modified: README.md
  - Modified: .github/workflows/ci.yml
  - Modified: gsnake-web/package.json
  - Modified: gsnake-web/README.md
  - Modified: gsnake-web/.github/workflows/ci.yml
  - Modified: gsnake-editor/package.json
  - Modified: gsnake-editor/README.md
  - Modified: gsnake-editor/.github/workflows/ci.yml
  - Modified: gsnake-core/README.md
  - Created: gsnake-core/scripts/coverage.sh
  - Modified: gsnake-levels/README.md
  - Created: gsnake-levels/scripts/coverage.sh
  - Modified: gsnake-levels/.github/workflows/ci.yml
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Package-level coverage commands are now the source of truth for CI and local runs; update these first when changing coverage behavior
  - For Rust packages, keep coverage flags in `scripts/coverage.sh` to avoid drift between different workflow files
  - Keep coverage outputs package-local (`coverage/` or `target/llvm-cov/lcov.info`) so artifact uploads stay stable across root and standalone workflows
---
## 2026-02-09 00:34 - US-002
- Added `WasmGameEngine` unit tests for init failure on level loading, contract-error passthrough mapping, and reset behavior after next-level progression
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check` and `npm --prefix gsnake-web run test`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-web/tests/unit/WasmGameEngine.test.ts
  - Modified: gsnake-web/engine/CLAUDE.md
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `WasmGameEngine` emits fallback `initializationFailed` errors for level-load failures, and preserves full contract errors when already in contract shape
  - Reset behavior can be validated by asserting constructor invocations in the mocked Rust engine (`init` + `nextLevel` + `resetLevel`)
  - Full act refresh currently reports coverage gate failures across package and root coverage jobs; functional/typecheck/test jobs remain green
---
## 2026-02-09 01:28 - US-003
- Added explicit `gsnake-web` store wiring tests for `levelChanged`, `frameChanged`, and `engineError` handling, including stale error clearing when a new frame arrives
- Verified `gameState` and `snakeLength` synchronization from `frameChanged` events and kept contract debug exposure coverage with and without `contractTest=1`
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-web/tests/unit/stores.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/CLAUDE.md
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Store wiring tests are easiest to keep deterministic by emitting engine events in sequence through a fake listener-based engine rather than mocking Svelte internals
  - To validate `frameChanged` recovery, set `engineError` first via `engineError` event and assert it is cleared after the next `frameChanged` event
  - CI status refresh currently remains blocked by coverage gate jobs across package and root workflows even when functional/test/typecheck jobs pass
---
