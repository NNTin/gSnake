## Codebase Patterns
- Coverage behavior should be changed via each package's `coverage` command first; workflows should call those commands instead of duplicating coverage flags.
- For `gsnake-web` `WasmGameEngine` unit tests, mock `gsnake-wasm` with `vi.hoisted` shared state and a local `MockRustEngine` class to drive init/error branches deterministically.
- For `gsnake-web` store wiring tests, drive event-order transitions with a small fake engine (`engineError` followed by `frameChanged`) to assert stale errors are cleared and frame state is resynced.
- For `gsnake-web` component tests, keep `vitest.config.ts` aligned with Vite (`svelte`, `vite-plugin-wasm`, `vite-plugin-top-level-await`) and use `// @vitest-environment jsdom` plus `context` maps when components rely on `getContext`.
- For `gsnake-web` `GameContainer` UI tests, inject a `GAME_ENGINE` context stub (`loadLevel`, `restartLevel`, `processMove`) and drive `gameState`/`level` stores to assert status-specific CTA visibility via `data-element-id` selectors.
- For `gsnake-editor` server API tests, call `resetTestLevelForTests()` in `beforeEach` so module-scoped in-memory storage does not leak state between requests/assertions.
- For `gsnake-editor` export/ID logic, keep pure helpers in `src/lib/levelModel.ts` and call them from Svelte components so unit tests cover runtime payload contracts without UI harness setup.
- For `gsnake-editor` Svelte component tests, keep `vitest.config.ts` aligned with `vite.config.ts` and do not force runes mode while components still use legacy `export let` syntax.
- For `gsnake-editor` load flows that change grid dimensions and then hydrate entities, `await tick()` between dimension updates and `placeEntitiesFromLevelData(...)` so reactive grid reinitialization does not wipe imported entities.
- For `gsnake-editor` grid interaction tests, target cells with `.cell[data-row][data-col]` and assert snake labels (`H`, `1`, `2`, ...) to verify segment reindexing after removals and undo/redo.

## 2026-02-08 23:57 - US-001
- Defined and documented a single package-level coverage command contract for gsnake-web, gsnake-editor, gsnake-core, and gsnake-levels
- Added `coverage` npm scripts for JS packages and reusable `scripts/coverage.sh` scripts for Rust packages
- Updated root and submodule CI coverage jobs to call package-level commands instead of inline coverage invocations
- Standardized and documented coverage output locations: `coverage/` for JS packages and `target/llvm-cov/lcov.info` for Rust packages
- Verified all four coverage commands run successfully locally
- Verified typecheck and test commands pass for all four packages
- **Files changed:**
  - Modified: README.md
  - Modified: .github/workflows/ci.yml
  - Modified: gsnake-web/package.json
  - Modified: gsnake-web/README.md
  - Modified: gsnake-web/.github/workflows/ci.yml
  - Modified: gsnake-editor/package.json
  - Modified: gsnake-editor/README.md
  - Modified: gsnake-editor/.github/workflows/ci.yml
  - Modified: gsnake-core/README.md
  - Created: gsnake-core/scripts/coverage.sh
  - Modified: gsnake-levels/README.md
  - Created: gsnake-levels/scripts/coverage.sh
  - Modified: gsnake-levels/.github/workflows/ci.yml
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Package-level coverage commands are now the source of truth for CI and local runs; update these first when changing coverage behavior
  - For Rust packages, keep coverage flags in `scripts/coverage.sh` to avoid drift between different workflow files
  - Keep coverage outputs package-local (`coverage/` or `target/llvm-cov/lcov.info`) so artifact uploads stay stable across root and standalone workflows
---
## 2026-02-09 00:34 - US-002
- Added `WasmGameEngine` unit tests for init failure on level loading, contract-error passthrough mapping, and reset behavior after next-level progression
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check` and `npm --prefix gsnake-web run test`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-web/tests/unit/WasmGameEngine.test.ts
  - Modified: gsnake-web/engine/CLAUDE.md
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `WasmGameEngine` emits fallback `initializationFailed` errors for level-load failures, and preserves full contract errors when already in contract shape
  - Reset behavior can be validated by asserting constructor invocations in the mocked Rust engine (`init` + `nextLevel` + `resetLevel`)
  - Full act refresh currently reports coverage gate failures across package and root coverage jobs; functional/typecheck/test jobs remain green
---
## 2026-02-09 01:28 - US-003
- Added explicit `gsnake-web` store wiring tests for `levelChanged`, `frameChanged`, and `engineError` handling, including stale error clearing when a new frame arrives
- Verified `gameState` and `snakeLength` synchronization from `frameChanged` events and kept contract debug exposure coverage with and without `contractTest=1`
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-web/tests/unit/stores.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/CLAUDE.md
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Store wiring tests are easiest to keep deterministic by emitting engine events in sequence through a fake listener-based engine rather than mocking Svelte internals
  - To validate `frameChanged` recovery, set `engineError` first via `engineError` event and assert it is cleared after the next `frameChanged` event
  - CI status refresh currently remains blocked by coverage gate jobs across package and root workflows even when functional/test/typecheck jobs pass
---
## 2026-02-09 02:24 - US-004
- Added `gsnake-web` component tests for level selector open/close, selecting a level, and level-load-error modal display/dismiss behavior
- Updated `gsnake-web` Vitest config to load Svelte components in tests by reusing the Vite plugin stack
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Modified: gsnake-web/vitest.config.ts
  - Added: gsnake-web/tests/unit/LevelUiFlows.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `LevelSelectorOverlay` tests that click level cards need async flush cycles after click because `selectLevel` awaits `loadLevel` before closing the overlay store
  - For components that use Svelte stores directly, instantiate components against `document.body` and assert both visible labels/buttons and store state transitions
  - CI full refresh continues to fail only on coverage gates while functional/typecheck/test/e2e jobs remain green
---
## 2026-02-09 03:19 - US-005
- Added `gsnake-web` UI flow tests for level-complete/all-complete states, game-over CTAs, header restart button behavior, and keyboard restart/back actions driven by UI state
- Verified `gsnake-web` quality checks pass with `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, and `npm --prefix gsnake-web run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Modified: gsnake-web/tests/unit/LevelUiFlows.test.ts
  - Modified: gsnake-web (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `GameContainer` tests should always provide a full `GAME_ENGINE` stub because restart controls and game-over modal actions both rely on context methods
  - To validate restart-related CTAs, set `gameState` to `GameOver` and `AllComplete` explicitly and assert modal action buttons by `data-element-id`
  - CI full refresh still fails only on coverage gates while functional/typecheck/test/e2e jobs remain green
---
## 2026-02-09 04:15 - US-006
- Added negative-path API tests for `POST /api/test-level` (missing payload, malformed field types, malformed JSON body) and unsupported methods on `/api/test-level`
- Hardened `gsnake-editor` server behavior with runtime payload schema validation, structured `400` JSON errors, and explicit `405` responses with `Allow` header
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run lint` (lint only reports warnings from generated coverage files)
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Modified: gsnake-editor/server.ts
  - Modified: gsnake-editor/src/tests/server.test.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `gsnake-editor/server.ts` stores test levels in module-scoped memory; export/use `resetTestLevelForTests()` in test suites to keep API tests deterministic
  - API negative-path tests in this repo should assert structured JSON error contracts (`error` plus `details`/`allowedMethods`) and `Allow` headers for `405`
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 05:12 - US-007
- Added `gsnake-editor` model tests for uint32 ID validation boundaries/invalid inputs, deterministic ID generation behavior, and export payload contract shape/field naming
- Extracted shared editor model logic into `src/lib/levelModel.ts` (`isValidLevelId`, `generateLevelId`, `buildLevelExportPayload`) and wired `App.svelte` + `EditorLayout.svelte` to use it
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- **Files changed:**
  - Added: gsnake-editor/src/lib/levelModel.ts
  - Modified: gsnake-editor/src/App.svelte
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/src/tests/types.test.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Move reusable Svelte component logic (ID validation and export serialization) into plain `src/lib/*.ts` helpers first, then call from components to keep tests deterministic and lightweight
  - Export payload contract checks should assert camelCase keys (`gridSize`, `snakeDirection`) and reject snake_case variants to mirror gsnake-core contract expectations
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 06:09 - US-008
- Added `gsnake-editor` `EditorLayout` component tests covering save modal opening, export/download payload flow, valid JSON load rendering, and invalid load toast feedback
- Fixed load hydration ordering in `EditorLayout` by awaiting a Svelte tick after grid dimension updates before applying loaded entities, preventing reactive grid reset from clearing imported state
- Updated `gsnake-editor` Vitest Svelte plugin setup to match Vite config (no forced runes mode) so legacy `export let` components compile in tests
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint` (warnings only from generated coverage files), `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Added: gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/vitest.config.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - `EditorLayout` load tests can mock `input[type=file]` payloads with file-like objects exposing `text()` instead of relying on environment-specific `File`/`Blob` APIs
  - For save-export UI tests, assert `URL.createObjectURL` inputs and anchor-click side effects to cover download behavior without filesystem/network dependencies
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
## 2026-02-09 07:02 - US-009
- Added `gsnake-editor` `EditorLayout` interaction tests for grid placement/removal, snake segment reindexing during edits, and multi-step undo/redo behavior with redo clearing on new actions
- Verified `gsnake-editor` checks pass with `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `npm --prefix gsnake-editor run test:coverage`
- Refreshed CI status via `scripts/test/test_act.sh` (result: 19 passed, 6 failed coverage jobs)
- Browser verification: no browser MCP resource is configured in this environment, so manual browser verification is still required
- **Files changed:**
  - Added: gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts
  - Added: gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts
  - Modified: gsnake-editor/src/lib/EditorLayout.svelte
  - Modified: gsnake-editor/vitest.config.ts
  - Modified: gsnake-editor (submodule pointer)
  - Modified: scripts/test/result.txt
  - Modified: scripts/ralph/prd.json
  - Modified: scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Undo/redo regression tests for `EditorLayout` are easiest to stabilize by asserting toolbar button enabled states alongside grid cell classes and snake index labels
  - Use Shift+click in component tests (`fireEvent.click(cell, { shiftKey: true })`) to cover the removal path and segment-index compaction logic
  - Full `act` refresh still reports six coverage-gate failures while functional/typecheck/test/e2e jobs pass
---
