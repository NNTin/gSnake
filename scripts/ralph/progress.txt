## Codebase Patterns
- `GameEngine::process_move` returns `Result<bool, EngineError>`: use `Ok(false)` for rejected-but-valid gameplay input and `Err(...)` for runtime invariant violations; bindings decide how to map/report engine errors.
- `GameEngine::new` is a fallible constructor: propagate/annotate `EngineError` at app boundaries (CLI/WASM/tooling) instead of unwrapping, and include level identifiers in context strings for debuggability.
- In `gsnake-core/engine/bindings/cli`, never discard `GameEngine::process_move(...)` results; propagate errors with move-direction and level-id context so invariant failures surface as actionable CLI diagnostics.
- Grid-size boundary tests should use `MAX_GRID_CELLS` directly (`1x1` minimum valid, `MAX_GRID_CELLS x 1` maximum valid, `(MAX_GRID_CELLS + 1) x 1` overflow) to lock behavior to the engine's safety cap constant.
- For web startup level selection, pass the raw `level` query value to `WasmGameEngine.init(...)`; `WasmGameEngine` owns strict parsing and deterministic fallback-to-level-1 behavior.
- In `gsnake-web/packages/gsnake-web-app/components/App.svelte`, keep startup loading transitions in the `init(...)` `finally` path so `data-element-id="engine-loading-indicator"` remains visible until initialization succeeds or fails, while existing error modals continue to surface unchanged after loading clears.
- `WasmGameEngine.init(...)` startup invariants should assert one `levelChanged` then one `frameChanged` event with no `engineError` for normalized query inputs, so startup behavior stays stable across parsing refactors.
- Every `WasmGameEngine` path that creates a Rust engine (`init`/`loadLevel`/`nextLevel`/`resetLevel`) must call `getFrame()` immediately after `onFrame` registration and preserve event order `levelChanged` then `frameChanged`; keep the contract in `gsnake-web/packages/gsnake-web-app/engine/frame-emission.md`.
- `LevelDefinition` schema changes must be made in `contracts/level-definition.schema.json` and validated with `npm run test:level-schema`; keep fixtures in `contracts/fixtures/` updated in the same change.
- Keep `contracts/generated/level-definition-validator.ts` in sync with schema changes by running `npm run generate:level-validator`; `npm run test:level-schema` now enforces freshness via `npm run check:level-validator`.
- In `gsnake-web`, `packages/gsnake-web-app/contracts/levelDefinitionGuard.ts` should stay a typed wrapper around a generated validator artifact (`gsnake-web/contracts/generated/level-definition-validator.ts`) instead of maintaining manual field-by-field guards.
- Optional-field and `totalFood` semantics for editor/server round-trips are centralized in `contracts/level-definition-semantics.md`; source code should link there instead of re-documenting semantics ad hoc.
- For schema drift tests in submodules, resolve schema paths with monorepo-first and vendored-local fallback candidates so checks run in both monorepo CI and standalone submodule CI.
- Editor server LevelDefinition validation must flow through `src/server/levelDefinitionValidator.ts` (Ajv + canonical schema) and return `details` as `{ field, keyword, message }` objects so API errors stay field-addressable.
- E2E `LevelDefinition` contract guards should be centralized in `e2e/level-definition.ts` as a typed wrapper around `contracts/generated/level-definition-validator.ts`; API/E2E specs should import this helper instead of redefining local `isLevelDefinition` logic.
- Editor API validation tests should assert `details` entries by `field` + `keyword` (including nested paths like `snake.0.x` and `additionalProperties` paths like `stones.0.z`) so schema-driven failures stay stable and actionable.
- Svelte component unit tests in `gsnake-web-app` should use `// @vitest-environment jsdom`, instantiate components with `new Component({ target: document.body, props })`, and reset `document.body.innerHTML` between tests for deterministic DOM assertions.
- For composed Svelte UI units (for example `Header.svelte`), assert action wiring through `data-element-id` buttons and verify both store side effects and engine stub calls to keep interaction contracts stable.
- For interactive Svelte button components, keep native button semantics (`type="button"` and `disabled`) and add dedicated tests that assert enabled/disabled state via DOM attributes plus click side effects.
- `KeyboardHandler` should forward rapid directional key events to `processMove` in order and leave lock/rejection decisions to the engine; tests should validate this via `attach()` + `window.dispatchEvent(...)`.
- In `gsnake-web` contract tests, keep CellType coverage centralized with shared variant lists and pair `isFrame(...)` assertions with explicit invalid-cell diagnostics so enum drift (casing/whitespace/non-string payloads) fails with actionable messages.
- In `gsnake-core` stone interaction contract tests, use a dedicated fixture level with a fixed obstacle platform row so gravity is deterministic and push-matrix assertions focus on interaction semantics rather than fall order side effects.
- In `gsnake-core`, preserve physics sequencing in `GameEngine::process_move` (collision -> win -> snake gravity -> stone gravity -> falling-food gravity) and validate intentional changes against the order-locking tests documented in `gsnake-core/README.md`.
- CLI playback parsing should attach `anyhow::Context` at each stage (file read, JSON parse, per-step key parse with step index + file path) so malformed playback diagnostics are actionable without panics.
- In `gsnake-levels` tests that mutate process CWD, prefer lock helpers that return `Result` (`?`) over `expect(...)` on `cwd_mutex` so generation-path regressions surface as test errors instead of panic paths.
- In Rust tests that assert `Result<T, anyhow::Error>`, avoid `assert_eq!(result, Ok(...))` because `anyhow::Error` has no `PartialEq`; use explicit `match` assertions for Ok/Err paths.
- `gsnake-levels validate-levels-toml` should aggregate issues with deterministic numbered output (`[io]`, `[parse]`, `[validation]`) and continue scanning all difficulties/entries in one run.
- `gsnake-levels` solver baselines should use `cargo run --bin profile_solver -- --levels-root <...> --difficulties <...> --iterations <...> --max-depth <...>` with fixed arguments; the command scans sorted level JSON files and reports deterministic cumulative-time hotspots.
- In `gsnake-levels`, keep playback generation and `solve_level` CLI output wiring through `solver::solve_level_to_playback(...)` so playback JSON format stays aligned while metadata sync avoids per-level subprocess overhead.
- `act` runs for `gsnake-levels` can fail in dependency resolution when the remote `nntin/gsnake` git dependency references a submodule commit that is not yet reachable; treat local `cargo check`/`cargo test` as the reliable code-validation signal and log the exact missing-ref error in `scripts/test/result.txt`.
- Before rerunning root `act` E2E (`.github/workflows/ci.yml::e2e-test`) after broad sudden failures, clear stale host Playwright processes (`pkill -f 'chromium_headless_shell|playwright_chromiumdev_profile' || true`); workflow cleanup relies on `fuser`, which may be unavailable in the act container.

## 2026-02-16 16:59:41 CET - US-001
- Added a root generation workflow for a shared TypeScript LevelDefinition runtime validator (`scripts/contracts/generate-level-definition-validator.mjs`) that compiles `contracts/level-definition.schema.json` via Ajv standalone and emits `contracts/generated/level-definition-validator.ts`.
- Added reproducible root commands in `package.json` (`generate:level-validator`, `check:level-validator`) and updated `test:level-schema` to enforce validator freshness before fixture checks.
- Updated contract docs to document the generated artifact location and regeneration workflow.
- Ran `npm run generate:level-validator`, `npm run test:level-schema`, and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `scripts/contracts/generate-level-definition-validator.mjs`, `contracts/generated/level-definition-validator.ts`, `contracts/README.md`, `package.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep schema-derived validator output committed under `contracts/generated/` so all packages can import one canonical runtime guard source.
  - Gotchas encountered: Ajv standalone emits `require(...)` runtime helpers even with ESM codegen, so generation should normalize those imports for ESM-friendly TypeScript output.
  - Useful context: this story changed shared contract tooling/docs only; no browser verification was required.
---
## 2026-02-16 17:39:37 CET - US-002
- Replaced the manual web `LevelDefinition` guard implementation with a typed wrapper that delegates validation to a generated schema-derived validator.
- Added a vendored generated validator artifact at `gsnake-web/contracts/generated/level-definition-validator.ts` and updated web drift-test messaging to reference generated-validator alignment.
- Added `../../../contracts` to `gsnake-web-app` Vite `server.fs.allow` so the app can import the shared generated validator from the web submodule-level contracts directory in dev/test workflows.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/contracts/levelDefinitionGuard.ts`, `gsnake-web/packages/gsnake-web-app/tests/contract/levelDefinitionSchemaDrift.test.ts`, `gsnake-web/packages/gsnake-web-app/vite.config.ts`, `gsnake-web/contracts/generated/level-definition-validator.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: web runtime contract checks should consume generated validators and keep app-level files as typed wrappers only.
  - Gotchas encountered: when importing shared contract artifacts from outside `gsnake-web-app`, update Vite `server.fs.allow` or dev/test runs can fail with out-of-root access errors.
  - Useful context: browser tooling is not configured in this environment; this story changed contract-validation plumbing and tests, so manual browser verification can be done separately if desired.
---
## 2026-02-16 18:23:45 CET - US-003
- Replaced duplicate E2E `LevelDefinition` guard internals in `e2e/level-definition.ts` with a typed wrapper around the shared generated validator (`contracts/generated/level-definition-validator.ts`) and aligned the exported type with `gsnake-web` model types.
- Kept existing E2E spec import paths stable (`./level-definition`) so all API/E2E checks now transitively use the shared validator path without local guard duplication.
- Ran `npx playwright test e2e/level-validation.spec.ts e2e/complete-workflow.spec.ts --reporter=list` and `act -W .github/workflows/ci.yml -j e2e-test --container-architecture linux/amd64` (success).
- Files changed: `e2e/level-definition.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep E2E validator consumption behind `e2e/level-definition.ts` so specs get schema-generated behavior via one typed wrapper.
  - Gotchas encountered: E2E helper type exports can drift unless they reuse `gsnake-web` model types rather than re-declaring `LevelDefinition`.
  - Useful context: this story changed E2E contract helper plumbing only; browser UI verification was covered by the root `e2e-test` workflow run.
---
## 2026-02-16 19:03:31 CET - US-004
- Removed remaining panic-style `expect(...)` usage in CLI source tests (`levels.rs`) and strengthened CLI runtime error propagation for move processing by surfacing `process_move(...)` failures with direction + level-id context.
- Hardened CLI level-loading diagnostics so malformed JSON errors include both parse stage and source file path for `load_levels(...)` and `load_level_from_file(...)`.
- Added regression coverage for malformed level JSON paths in both level-loading module tests and CLI argument-path tests.
- Ran `cargo test --manifest-path gsnake-core/engine/bindings/cli/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/bindings/cli/src/main.rs`, `gsnake-core/engine/bindings/cli/src/levels.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: CLI gameplay paths should treat `process_move(...)` errors as actionable runtime failures, not ignorable events.
  - Gotchas encountered: parse-context assertions are more stable when tests check the full chained error (`format!("{err:#}")`) instead of only `to_string()`.
  - Useful context: root `act` test job exercises `gsnake-core` contract tests plus fixture generation, so CLI binding error-handling changes are covered in that run.
---
## 2026-02-16 19:43:01 CET - US-005
- Removed remaining production `unwrap(...)` in `gsnake-levels/src/playback.rs` by making single-character key extraction fallible and propagating errors via `Result`.
- Added per-step playback parse context (`Failed to parse playback step N in <path>`) so `verify` command failures report actionable location details instead of opaque key errors.
- Added regression coverage for invalid playback keys in both unit (`playback.rs`) and CLI integration (`tests/cli_error_paths_test.rs`) paths.
- Ran `cargo check` and `cargo test` in `gsnake-levels` (success), and ran `act` for `gsnake-levels` workflows (failed due external checkout/dependency issues noted below).
- Files changed: `gsnake-levels/src/playback.rs`, `gsnake-levels/tests/cli_error_paths_test.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep playback parsing errors wrapped with step index + playback file path context so CLI verification failures are directly traceable to an input row.
  - Gotchas encountered: `act -W gsnake-levels/.github/workflows/ci.yml -j test` can fail independently of local code when upstream git dependency submodule refs are unavailable.
  - Useful context: `act -W gsnake-levels/.github/workflows/test.yml -j test` requires a GitHub token for the cross-repo checkout step (`NNTin/gSnake`), so local `cargo test` remains the reliable signal in tokenless environments.
---
## 2026-02-16 20:23:36 CET - US-006
- Verified and finalized aggregated multi-issue reporting for `validate-levels-toml`: deterministic numbered output (`[io]`, `[parse]`, `[validation]`) is present and one run reports multiple issues without fail-fast behavior.
- Revalidated aggregation coverage in unit/CLI tests (`validate_levels_toml` module tests + `tests/cli_error_paths_test.rs::test_validate_levels_toml_reports_aggregated_errors`) and confirmed local quality gates with `cargo check` and `cargo test`.
- Re-ran `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-levels`; failure is external (`gsnake-specs` submodule commit `25ec6e9115ffea7fdaca64428d74298c902b6cad` not found on remote), not a validation-command regression.
- Files changed: `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`, `scripts/test/CLAUDE.md`.
- **Learnings for future iterations:**
  - Patterns discovered: for `validate-levels-toml`, keep issue ordering deterministic (difficulty order then entry order) so numbered CLI diagnostics stay testable and stable.
  - Gotchas encountered: `act` in `gsnake-levels` can fail before tests run if git dependency submodule refs are unavailable remotely; preserve this as CI-environment evidence and rely on local cargo checks for code validation.
  - Useful context: this story required validation-command/test verification only; no UI behavior changed, so browser verification was not required.
---
## 2026-02-16 21:10:42 CET - US-007
- Added a shared solver module (`gsnake-levels/src/solver.rs`) and refactored `src/bin/solve_level.rs` to reuse it, establishing one implementation path for solve logic.
- Added a repeatable benchmark command via new binary `src/bin/profile_solver.rs` that runs deterministic repeated solves over sorted level fixtures and reports wall time, per-difficulty totals, and top cumulative-time hotspots.
- Documented reproducible benchmark usage and captured baseline metrics in `gsnake-levels/docs/solver-performance-baseline.md`, then linked rerun guidance from `gsnake-levels/README.md`.
- Ran `cargo fmt` and `cargo test` in `gsnake-levels` (success). Ran `act -W gsnake-levels/.github/workflows/ci.yml -j test --container-architecture linux/amd64` (failed due external git dependency submodule ref `25ec6e9115ffea7fdaca64428d74298c902b6cad` not found on remote).
- Files changed: `gsnake-levels/src/solver.rs`, `gsnake-levels/src/lib.rs`, `gsnake-levels/src/bin/solve_level.rs`, `gsnake-levels/src/bin/profile_solver.rs`, `gsnake-levels/docs/solver-performance-baseline.md`, `gsnake-levels/README.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: use `profile_solver` with fixed args to keep solver baseline comparisons stable over time and directly comparable between runs.
  - Gotchas encountered: including harder difficulty sets at large depth/iteration values can make profiling runs impractically long; baseline docs should pin a representative bounded scope.
  - Useful context: `act` failure in this area is currently dominated by remote submodule-ref availability in the git dependency chain, not local benchmark/solver code correctness.
---
## 2026-02-16 21:53:48 CET - US-008
- Replaced playback generation subprocess spawning in `gsnake-levels/src/playback_generator.rs` by calling shared in-process solver flow (`solver::solve_level_to_playback`) and sorted level file traversal for deterministic processing order.
- Centralized playback JSON emission in `gsnake-levels/src/solver.rs` (`solve_level_to_playback`) and refactored `src/bin/solve_level.rs` to consume the same path, preventing format drift between CLI and metadata sync generation.
- Added regression tests for playback-format compatibility and parse-error handling in `gsnake-levels/src/playback_generator.rs`, plus documented throughput baseline and measured improvement in `gsnake-levels/docs/playback-generation-performance-baseline.md` and `gsnake-levels/README.md`.
- Benchmarked `sync-metadata --difficulty easy` before/after: `0.49s` before vs `~10ms` average after (10 runs), showing ~49x speedup on the representative easy-level set.
- Ran `cargo fmt`, `cargo check`, and `cargo test` in `gsnake-levels` (success). Ran `act -W gsnake-levels/.github/workflows/ci.yml -j test --container-architecture linux/amd64` (failed due external git dependency submodule ref `25ec6e9115ffea7fdaca64428d74298c902b6cad` not found on remote).
- Files changed: `gsnake-levels/src/solver.rs`, `gsnake-levels/src/bin/solve_level.rs`, `gsnake-levels/src/playback_generator.rs`, `gsnake-levels/src/main.rs`, `gsnake-levels/docs/playback-generation-performance-baseline.md`, `gsnake-levels/README.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep playback writing logic shared between CLI and metadata generation to avoid schema/format divergence and subprocess overhead.
  - Gotchas encountered: fixture-based solver tests are more stable than synthetic handcrafted levels for compatibility assertions because engine rules can make minimal examples unintentionally unsolvable.
  - Useful context: browser verification was not required because this story only changed Rust CLI/tooling paths and docs.
---
## 2026-02-16 22:38:44 CET - US-009
- Added explicit non-blocking startup UI state in `gsnake-web/packages/gsnake-web-app/components/App.svelte`: the app now shows `data-element-id="engine-loading-indicator"` while `WasmGameEngine.init(...)` is in flight and swaps to `GameContainer` only after init success or failure.
- Preserved existing initialization error-handling behavior by keeping the prior `engineError`/`levelLoadError` catch paths and only clearing the loading state in `finally` so failure modals still render through the same flow.
- Verified locally with `npm run check` and `npm test` in `gsnake-web`; verified CI parity with `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web`.
- Verified in browser with `agent-browser` against `http://localhost:3000/`: observed `Loading game engine...` during startup and confirmed existing `Level Load Failed` modal flow after initialization failure path.
- Files changed: `gsnake-web/packages/gsnake-web-app/components/App.svelte`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep startup loading indicators tied to engine init lifecycle in `finally` so first paint is explicit and deterministic without suppressing existing error overlays.
  - Gotchas encountered: `act -W gsnake-web/.github/workflows/ci.yml ...` must run from `gsnake-web/` workspace; running from monorepo root breaks the workflow's relative script paths.
  - Useful context: `agent-browser` is available in this environment and can assert startup text via `agent-browser get text body` for quick UI verification.
---
