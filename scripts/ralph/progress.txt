# Ralph Progress Log
Started: Fri Feb 20 09:53:43 CET 2026
## Codebase Patterns
- For `gsnake-levels validate-levels-toml`, keep validation output aggregated and deterministic (`[io]`, `[parse]`, `[validation]` with numbered lines) so one run reports all actionable issues and tests can assert stable CLI output.
- For `gsnake-levels` playback generation, keep `sync-metadata` and `solve_level` aligned through `solver::solve_level_to_playback(...)` so playback JSON format cannot drift and per-level `cargo` subprocess overhead is avoided.
- In `gsnake-core` stone push logic, keep `stone_mechanics::is_space_available` aligned with gravity occupancy rules by treating all food variants plus the exit tile as blocking cells.
- In `gsnake-core/engine/core/src/stone_mechanics.rs`, keep `find_stone_row` horizontal-only with an in-function `debug_assert!` so new call sites cannot silently pass vertical directions.
- In `gsnake-core/engine/bindings/wasm`, regenerate committed `pkg/` artifacts with `wasm-pack build --target bundler` whenever Rust binding code or dependency wiring changes.
- In `gsnake-core/engine/bindings/wasm`, keep `on_frame` callback registration non-throwing for JS by preserving `()` return type and logging initial `emit_frame` failures via `web_sys::console::error_1`.
- In `gsnake-core/engine/bindings/wasm/src/lib.rs`, prefer borrowing `&JsValue` where ownership is unnecessary so `cargo clippy -D warnings` stays clean without no-op early-drop patterns.
- In `gsnake-core` level definitions, keep `total_food` typed as `Option<u32>` where `None` auto-counts all food vectors and `Some(0)` is an explicit zero-food requirement.
- In `gsnake-core` level definitions, keep `LevelDefinition::new()` setting `exit_is_solid: None` and resolve the default in `LevelState::from_definition` with `unwrap_or(true)` so constructor-created and JSON-deserialized levels follow the same default semantics.
- In `gsnake-core`, use `GameEngine::new_with_total_levels(...)` from host/binding multi-level flows so the final-level exit can emit `GameStatus::AllComplete`; keep `GameEngine::new(...)` for single-level or host-managed progression.
- In `gsnake-core/engine/core/tests/contract_tests.rs`, keep `CellType` wire-format tests exhaustive: serialization and roundtrip suites must include all enum variants with explicit expected JSON names.
- In `gsnake-core/engine/core/src/gravity.rs`, keep `is_settled_falling_food` recursion bounded (`depth` + `MAX_SETTLED_FALLING_FOOD_DEPTH`) and fail closed at the cap so malformed deep columns cannot cause stack overflows.
- In `gsnake-core` movement flow, keep food consumption tied to `GameEngine::check_and_eat_food` during deliberate `process_move` input only; gravity (`can_snake_fall`) treats food as support and must not auto-consume adjacent body-segment food.
- In `gsnake-core/engine/core/src/engine.rs`, keep `process_move` stone handling ordered before `check_collision`; `check_collision` intentionally omits stones because `try_push_stone` rejects any move where the head would occupy an unpushable stone.
---
## [2026-02-20 09:55:34 CET] - US-001
- Implemented US-001 by updating `stone_mechanics::is_space_available` to block stone pushes into regular food, floating food, falling food, and the exit tile.
- Added regression tests covering blocked pushes into `food`, `floating_food`, `falling_food`, and the exit tile (including `exit_is_solid = false` behavior).
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/stone_mechanics.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - Stone push occupancy rules should mirror gravity support rules to avoid divergent behavior between horizontal pushes and vertical settling.
  - `stone_mechanics` unit tests are the fastest regression surface for push-blocking semantics; keep focused tests there when adding occupancy constraints.
  - `cargo test -p gsnake-core` covers both unit and contract/property suites relevant to engine behavior changes.
---
## [2026-02-20 09:58:02 CET] - US-002
- Implemented US-002 by removing the unmaintained `wee_alloc` dependency and deleting the WASM `#[global_allocator]` declaration so the crate uses Rustâ€™s default WASM allocator.
- Rebuilt WASM bundler artifacts after the allocator change and validated no API surface changes were introduced.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-wasm --all-targets -- -D warnings`, `cargo test -p gsnake-wasm`, `cargo test -p gsnake-core`, and `wasm-pack build --target bundler`.
- Files changed: `gsnake-core/engine/bindings/wasm/Cargo.toml`, `gsnake-core/engine/bindings/wasm/src/lib.rs`, `gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm.d.ts`, `gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm.js`, `gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm_bg.js`, `gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm_bg.wasm`, `gsnake-core/engine/bindings/wasm/pkg/package.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - `gsnake-wasm` keeps checked-in generated outputs under `engine/bindings/wasm/pkg`; dependency/runtime wiring changes in Rust should always be followed by `wasm-pack build --target bundler`.
  - The workspace emits a non-blocking Cargo warning about package-local profiles in `engine/bindings/wasm/Cargo.toml`; treat it as informational unless workspace profile ownership is being refactored.
  - `cargo test -p gsnake-wasm` provides fast feedback for binding-layer regressions before running broader `gsnake-core` suites.
---
## [2026-02-20 09:59:50 CET] - US-003
- Implemented US-003 by replacing the silent `let _ = self.emit_frame()` in `on_frame` with explicit error handling that logs failures to `web_sys::console::error_1`.
- Kept the `on_frame` public API unchanged (`pub fn on_frame(&mut self, callback: Function)` returning `()`), so JavaScript callers still see the same contract while failures become diagnosable in DevTools.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-wasm --all-targets -- -D warnings`, and `cargo test -p gsnake-wasm`.
- Files changed: `gsnake-core/engine/bindings/wasm/src/lib.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - WASM callback-registration APIs that return `()` should log startup/frame emission failures instead of silently discarding them, so JS integrations can diagnose initialization issues.
  - Existing `gsnake-wasm` unit tests are sufficient to validate non-API-breaking internal error-handling tweaks in `on_frame` when behavior changes are limited to logging paths.
  - The package-local profile warning from Cargo in `engine/bindings/wasm/Cargo.toml` is expected during clippy/test runs and should not be treated as a failure.
---
## [2026-02-20 10:04:33 CET] - US-004
- Implemented US-004 by changing `LevelDefinition.total_food` from `u32` to `Option<u32>` and updating `GameEngine::new` to treat `None` as auto-count and `Some(n)` (including `Some(0)`) as explicit required food.
- Added regression coverage for JSON semantics (`totalFood` omitted => `None`, `totalFood: 0` => `Some(0)`), default constructor behavior, and explicit-zero engine initialization behavior.
- Regenerated contract fixture output so `tests/fixtures/level.json` omits `totalFood` when unset.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/models.rs`, `gsnake-core/engine/core/src/engine.rs`, `gsnake-core/engine/core/tests/fixtures/level.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - `LevelDefinition::new()` should keep `total_food` unset (`None`) so auto-count is the default for programmatic level creation and serialized fixtures.
  - For level JSON contracts, `totalFood` must only be present when overriding auto-count; explicit `0` is now a meaningful value and should not be conflated with missing.
  - `cargo test -p gsnake-core` includes `generate_contract_fixtures`, so fixture drift can be caught and refreshed while validating engine changes.
---
## [2026-02-20 10:11:18 CET] - US-005
- Implemented US-005 by wiring `GameStatus::AllComplete` into real engine transitions via `GameEngine::new_with_total_levels(...)`, which marks the final-level exit as `AllComplete` instead of leaving the variant unreachable.
- Updated CLI engine creation paths to pass total level count only in multi-level mode, so pack progression can emit `AllComplete` while single-level runs preserve `LevelComplete` semantics.
- Added regression coverage in core engine tests for the final-level transition (`LevelComplete` -> `AllComplete` when total level count is configured).
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core -p gsnake-cli --all-targets -- -D warnings`, and `cargo test -p gsnake-core -p gsnake-cli`.
- Files changed: `gsnake-core/engine/core/src/engine.rs`, `gsnake-core/engine/bindings/cli/src/main.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - `GameStatus::AllComplete` is now an opt-in engine behavior tied to host-provided total level count; without that configuration, completion remains `LevelComplete`.
  - Multi-level bindings should centralize engine construction to avoid inconsistent `total_levels` wiring between initial load, reset, and level transitions.
  - `cargo test -p gsnake-core -p gsnake-cli` is the fastest combined regression pass for engine status transitions plus CLI flow integration.
---
## [2026-02-20 10:13:27 CET] - US-006
- Implemented US-006 by extending `CellType` contract coverage to all 10 variants in both `test_celltype_serialization` and `test_celltype_roundtrip`.
- Added explicit expected JSON-name assertions for every `CellType` variant, including `FloatingFood`, `FallingFood`, `Stone`, and `Spike`.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/tests/contract_tests.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - `CellType` wire-format contract tests should be treated as exhaustive snapshots of enum variants; missing a variant weakens frontend compatibility guarantees.
  - Pair explicit serialization-string assertions with roundtrip coverage so rename regressions are caught before TS/Svelte integrations consume changed values.
  - `cargo test -p gsnake-core` is sufficient to validate these contract-test changes because it runs `contract_tests.rs` and fixture generation checks.
---
## [2026-02-20 10:15:47 CET] - US-007
- Implemented US-007 by enforcing a horizontal-direction invariant in `stone_mechanics::find_stone_row` via `debug_assert!`, making misuse fail fast in debug/test builds.
- Added a regression test that verifies `find_stone_row` panics when called with a vertical direction.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/stone_mechanics.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`
- **Learnings for future iterations:**
  - Keep internal helper invariants close to the function body (`debug_assert!`) even when the current public call path already guards inputs.
  - For panic/guard regressions on private helpers, colocated unit tests in the same module are the most direct coverage path.
  - `cargo test -p gsnake-core` remains the right full validation pass for engine-only safety hardening changes.
---
## [2026-02-20 10:19:43 CET] - US-008
- Implemented US-008 by adding depth-bounded recursion to `is_settled_falling_food` via a `depth` parameter and `MAX_SETTLED_FALLING_FOOD_DEPTH` guard.
- Updated gravity call sites to start recursion with `depth = 0` and documented the fail-closed cap behavior (treat deep chains as settled to prevent stack growth).
- Added a regression test with a deep vertical falling-food column that exercises the depth-cap path and completes safely.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/gravity.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - Recursive gravity/support checks should always carry an explicit depth bound because malformed/generated levels can create much deeper chains than gameplay does.
  - For defensive recursion caps in physics helpers, a fail-closed fallback keeps behavior deterministic while eliminating stack-overflow risk.
  - `cargo test -p gsnake-core` is the right validation sweep for gravity internals because it includes unit, contract, and property tests.
---
## [2026-02-20 10:22:36 CET] - US-009
- Implemented US-009 by documenting gravity food-consumption semantics in `can_snake_fall` and clarifying in `process_move` that only deliberate input-driven moves call `check_and_eat_food`.
- Added comments describing the intentional food-as-platform invariant and the multi-segment edge case where body-adjacent food after a fall is not auto-consumed.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/gravity.rs`, `gsnake-core/engine/core/src/engine.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - Food collection in the engine is intentionally tied to `GameEngine::process_move` via `check_and_eat_food`; gravity resolution should remain non-collecting.
  - `can_snake_fall` treating food as support is a gameplay contract, not a missing consumption check.
  - Comment-only semantic clarifications in core engine code should still run the standard `cargo fmt/clippy/test` gate to prevent incidental regressions.
---
## [2026-02-20 10:26:02 CET] - US-010
- Implemented US-010 by removing the no-op `drop(direction)` from the WASM move path and keeping direction parsing behavior unchanged (`direction_str` extraction followed by `parse_direction_str`).
- Updated `process_move`/`parse_direction_js_value` to borrow `&JsValue` where ownership is unnecessary, preserving behavior while satisfying strict clippy settings.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-wasm --all-targets -- -D warnings`, `cargo test -p gsnake-wasm`, and `wasm-pack build --target bundler`.
- Files changed: `gsnake-core/engine/bindings/wasm/src/lib.rs`, `gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm_bg.js`, `gsnake-core/engine/bindings/wasm/pkg/gsnake_wasm_bg.wasm`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - In wasm-bindgen entrypoints, prefer borrowing `&JsValue` when the value is only inspected; this avoids no-op explicit drops and keeps `clippy::needless_pass_by_value` from failing `-D warnings` builds.
  - Even tiny Rust binding changes should run `wasm-pack build --target bundler` so committed `pkg/` outputs stay synchronized with generated glue.
  - `cargo test -p gsnake-wasm` is the fastest regression pass for move-parsing and contract-error behavior in the WASM wrapper.
---
## [2026-02-20 10:29:38 CET] - US-011
- Implemented US-011 by aligning `LevelDefinition::new()` with deserialization defaults: `exit_is_solid` now initializes to `None` and runtime behavior continues to default to solid exit via `unwrap_or(true)`.
- Added regression tests covering missing `exitIsSolid` deserialization (`None`) and parity between `None` and `Some(true)` in `LevelState::from_definition`.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/models.rs`, `gsnake-core/engine/core/tests/fixtures/level.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - Optional level-definition fields with serde defaults should be initialized as `None` in constructors when runtime logic already applies `unwrap_or(...)`, so constructor and JSON paths cannot drift.
  - `cargo test -p gsnake-core` runs `generate_contract_fixtures`; constructor default changes can intentionally update committed fixture JSON.
  - Keep `exitIsSolid` omitted in fixture JSON unless a level explicitly overrides the default behavior.
---
## [2026-02-20 10:31:55 CET] - US-012
- Implemented US-012 by documenting the intentional stone omission in `check_collision`: stones are guarded earlier in `process_move` via `try_push_stone`, and blocked/vertical stone interactions return before collision checks.
- Kept runtime behavior unchanged and preserved the existing collision-oracle pattern while making the call-order dependency explicit in code.
- Ran quality checks in `gsnake-core`: `cargo fmt --all`, `cargo clippy -p gsnake-core --all-targets -- -D warnings`, and `cargo test -p gsnake-core`.
- Files changed: `gsnake-core/engine/core/src/engine.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `CLAUDE.md`
- **Learnings for future iterations:**
  - `check_collision` in `engine.rs` is intentionally not exhaustive for stones; correctness depends on `process_move` performing stone push/rejection before collision evaluation.
  - When refactoring move flow, preserve the order: compute new head -> resolve stone interaction -> then call `check_collision`.
  - Comment-only safety clarifications should still pass the standard `cargo fmt/clippy/test` quality gate for `gsnake-core`.
---
