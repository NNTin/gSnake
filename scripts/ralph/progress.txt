## Codebase Patterns
- `GameEngine::process_move` returns `Result<bool, EngineError>`: use `Ok(false)` for rejected-but-valid gameplay input and `Err(...)` for runtime invariant violations; bindings decide how to map/report engine errors.
- `GameEngine::new` is a fallible constructor: propagate/annotate `EngineError` at app boundaries (CLI/WASM/tooling) instead of unwrapping, and include level identifiers in context strings for debuggability.
- Grid-size boundary tests should use `MAX_GRID_CELLS` directly (`1x1` minimum valid, `MAX_GRID_CELLS x 1` maximum valid, `(MAX_GRID_CELLS + 1) x 1` overflow) to lock behavior to the engine's safety cap constant.
- For web startup level selection, pass the raw `level` query value to `WasmGameEngine.init(...)`; `WasmGameEngine` owns strict parsing and deterministic fallback-to-level-1 behavior.
- `WasmGameEngine.init(...)` startup invariants should assert one `levelChanged` then one `frameChanged` event with no `engineError` for normalized query inputs, so startup behavior stays stable across parsing refactors.
- `LevelDefinition` schema changes must be made in `contracts/level-definition.schema.json` and validated with `npm run test:level-schema`; keep fixtures in `contracts/fixtures/` updated in the same change.
- Editor server LevelDefinition validation must flow through `src/server/levelDefinitionValidator.ts` (Ajv + canonical schema) and return `details` as `{ field, keyword, message }` objects so API errors stay field-addressable.
- E2E `LevelDefinition` contract guards should be centralized in `e2e/level-definition.ts`; API/E2E specs should import this helper instead of redefining local `isLevelDefinition` logic.

# Ralph Progress Log
Started: Sun Feb 15 20:54:09 CET 2026
---
## 2026-02-15 22:24:05 CET - US-001
- Replaced snake-head access `unwrap` in `GameEngine::process_move` with explicit guarded access and structured `EngineError` propagation for malformed empty-snake runtime state.
- Added `EngineError::SnakeHasNoSegments` with a clear diagnostic message and updated engine tests to assert `Err(EngineError::SnakeHasNoSegments)` rather than panic-like behavior.
- Updated affected consumers/callers for the new `Result<bool, EngineError>` contract (`gsnake-wasm`, CLI binding, and core/CLI demo flows), including WASM-side mapping to `ContractErrorKind::InternalError`.
- Files changed: `gsnake-core/engine/core/src/engine.rs`, `gsnake-core/engine/core/src/models.rs`, `gsnake-core/engine/bindings/wasm/src/lib.rs`, `gsnake-core/engine/bindings/cli/src/main.rs`, `gsnake-core/engine/bindings/cli/examples/ui_demo.rs`, `gsnake-core/engine/core/examples/gameplay_demo.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: for engine move semantics, callers must handle both soft rejection (`Ok(false)`) and hard invariant errors (`Err(EngineError)`); this avoids silently swallowing malformed state.
  - Gotchas encountered: changing a core engine API requires propagating signature updates through bindings and demos, not just core tests.
  - Useful context: WASM adapter maps engine invariant failures to `ContractErrorKind::InternalError` and should preserve the engine error message for debugging.
---
## 2026-02-15 23:05:16 CET - US-002
- Added constructor-time grid-size validation in `GameEngine::new` and made the constructor fallible (`Result<Self, EngineError>`) so invalid dimensions are rejected before runtime frame/grid usage.
- Added `EngineError::InvalidGridSize { width, height }` and `EngineError::GridSizeExceedsMaxCells { ... }` with explicit messages including invalid values; introduced `MAX_GRID_CELLS` as the enforced safety cap.
- Updated engine consumers (core tests/examples, wasm binding, CLI binding, and `gsnake-levels` verification/solver tooling) to handle constructor errors via propagation/context or explicit test/demo `expect(...)`.
- Added regression coverage for non-positive and oversized grid-size rejection and ensured defensive frame generation behavior is still safe for malformed runtime state.
- Files changed: `gsnake-core/engine/core/src/models.rs`, `gsnake-core/engine/core/src/engine.rs`, `gsnake-core/engine/core/examples/gameplay_demo.rs`, `gsnake-core/engine/bindings/wasm/src/lib.rs`, `gsnake-core/engine/bindings/cli/src/main.rs`, `gsnake-core/engine/bindings/cli/examples/ui_demo.rs`, `gsnake-levels/src/verify.rs`, `gsnake-levels/src/bin/solve_level.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: constructor contract changes in `gsnake-core` ripple into sibling tooling repos (`gsnake-levels`) because they consume the same engine API.
  - Gotchas encountered: `Result::expect_err` on `initialize_engine` required avoiding a `Debug` bound on `WasmGameEngine`; use explicit `match` when only the error path matters.
  - Useful context: CLI/WASM entrypoints now surface invalid grid-size errors with level-specific context, making malformed level debugging deterministic.
---
## 2026-02-15 23:48:28 CET - US-003
- Added explicit grid-size boundary tests in `GameEngine` for negative, zero, minimum valid, maximum valid, and maximum+1 cases.
- Asserted exact `EngineError` variants and messages for invalid boundary values, and asserted successful engine creation at both valid boundaries.
- Ran `cargo test --manifest-path gsnake-core/engine/core/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/core/src/engine.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: engine boundary tests are colocated in `gsnake-core/engine/core/src/engine.rs` under `mod tests` and should validate both error variant and error message text.
  - Gotchas encountered: `act` output is verbose and truncated in terminal captures; keep a concise summary in `scripts/test/result.txt` for iteration traceability.
  - Useful context: root CI `test` job runs `cargo test -p gsnake-core --verbose` plus the `generate_contract_fixtures` test target, so core engine boundary regressions are covered there.
---
## 2026-02-16 00:27:11 CET - US-004
- Hardened `WasmGameEngine` start-level parsing to reject invalid query-like inputs (`NaN`, empty, decimal, text, non-positive) and centralized the fallback behavior in engine code.
- Updated startup semantics so out-of-range start levels deterministically fall back to level 1, and switched `App.svelte` to pass the raw `level` query param into `WasmGameEngine.init(...)`.
- Added/updated `WasmGameEngine` unit coverage for invalid query-like values fallback, above-range fallback behavior, and valid integer string handling.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, `gsnake-web/packages/gsnake-web-app/components/App.svelte`, `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: URL-level sanitization should be engine-owned to keep every startup entrypoint consistent (query parsing and direct init calls).
  - Gotchas encountered: running `act` for submodule workflows from the monorepo root can break relative script paths; run from submodule root with local workflow path.
  - Useful context: browser tools were not available in this iteration, so manual browser verification is still needed for the URL-query startup path.
---
## 2026-02-16 01:06:40 CET - US-005
- Expanded `WasmGameEngine` query-parameter regression coverage into deterministic permutation tests for valid integer, NaN, empty, decimal, text, below-range, and above-range inputs.
- Added assertions for selected startup level identity and initialization consistency (`levelChanged` then `frameChanged`, no `engineError`) across each query-input scenario.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: query-input regression tests are most robust when they assert both loaded level identity and emitted startup events, not only fallback index.
  - Gotchas encountered: if `act` runs against a submodule workflow, execute from that submodule directory so relative script paths resolve correctly.
  - Useful context: this story required test and docs hardening only; browser verification was not required because no UI behavior changed.
---
## 2026-02-16 01:47:25 CET - US-006
- Added a canonical shared `LevelDefinition` JSON Schema at `contracts/level-definition.schema.json`, including optional fields (`floatingFood`, `fallingFood`, `stones`, `spikes`, `exitIsSolid`, `difficulty`) and documented `totalFood` semantics.
- Added schema fixture set under `contracts/fixtures/` for valid minimal payload, valid optional-field payload, missing-`totalFood` rejection, and invalid optional-field shape rejection.
- Added contract ownership/import workflow documentation in `contracts/README.md` and created `scripts/contracts/validate-level-definition-schema.mjs` plus `npm run test:level-schema` to enforce fixture-based schema validation.
- Ran `npm run test:level-schema` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `contracts/level-definition.schema.json`, `contracts/fixtures/level-definition.valid.json`, `contracts/fixtures/level-definition.valid-optionals.json`, `contracts/fixtures/level-definition.invalid-missing-total-food.json`, `contracts/fixtures/level-definition.invalid-optional-shape.json`, `contracts/README.md`, `scripts/contracts/validate-level-definition-schema.mjs`, `package.json`, `package-lock.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: the canonical contract lives at repo root (`contracts/`) so editor/web/e2e tooling can consume the same schema artifact.
  - Gotchas encountered: draft 2020-12 schemas require Ajv's 2020 runtime (`ajv/dist/2020.js`) for local fixture validation.
  - Useful context: this story changed shared contract artifacts/documentation only, so browser verification was not required.
---
## 2026-02-16 02:27:00 CET - US-007
- Replaced `gsnake-editor/server.ts` manual LevelDefinition checks with schema-driven validation via new `src/server/levelDefinitionValidator.ts` using Ajv 2020 and canonical schema lookup.
- Added structured field-level validation response details (`{ field, keyword, message }`) while keeping the existing top-level API error contract (`error: \"Invalid level payload\"`).
- Added standalone-safe schema fallback by vendoring `gsnake-editor/contracts/level-definition.schema.json` and resolving schema path in both monorepo and standalone editor CI contexts.
- Updated server API tests to assert structured validation errors and keyword/field mappings for malformed payloads.
- Ran `npm run check`, `npm run lint`, `npm test` in `gsnake-editor`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-editor` (all success).
- Files changed: `gsnake-editor/.gitignore`, `gsnake-editor/contracts/level-definition.schema.json`, `gsnake-editor/README.md`, `gsnake-editor/package.json`, `gsnake-editor/package-lock.json`, `gsnake-editor/server.ts`, `gsnake-editor/src/server/levelDefinitionValidator.ts`, `gsnake-editor/src/tests/server.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: map Ajv `instancePath` + `required`/`additionalProperties` params into dot-path field identifiers so clients can tie validation failures directly to form inputs.
  - Gotchas encountered: `server.ts` imports must omit `.ts` suffix because the editor typecheck path does not enable `allowImportingTsExtensions`.
  - Useful context: editor standalone CI (`FORCE_GIT_DEPS=1`) cannot rely on monorepo-only paths; schema loading needs a local fallback artifact.
---
## 2026-02-16 03:10:31 CET - US-008
- Extracted shared `LevelDefinition` typing and `isLevelDefinition` guard into `e2e/level-definition.ts` and removed duplicated ad-hoc guard/type blocks from the two target E2E specs.
- Updated `e2e/complete-workflow.spec.ts` and `e2e/level-validation.spec.ts` to import `LevelDefinition` and `isLevelDefinition` from the shared utility.
- Ran `npm run test:e2e -- e2e/complete-workflow.spec.ts e2e/level-validation.spec.ts` and `act -W .github/workflows/ci.yml -j e2e-test --container-architecture linux/amd64` (success).
- Files changed: `e2e/level-definition.ts`, `e2e/complete-workflow.spec.ts`, `e2e/level-validation.spec.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: when E2E specs validate serialized LevelDefinition payloads, import `isLevelDefinition` from `e2e/level-definition.ts` to keep contract checks synchronized.
  - Gotchas encountered: `act` E2E job first-run setup is heavy (Playwright/browser packages), so expect longer runtime even for small test-only refactors.
  - Useful context: this story changed test utilities/spec wiring only; no product UI behavior changed.
---
