## Codebase Patterns
- For gsnake-web enum contract drift checks, keep runtime enum guard constants in `gsnake-web/packages/gsnake-web-app/contracts/enumGuards.ts` and assert parity against both generated TS unions (`types/models.ts`) and Rust wire enums (`gsnake-core/engine/core/src/models.rs`) so cross-language mismatch fails tests.
- For `gsnake-wasm` in `WasmGameEngine.ts`, import as a namespace and treat the default initializer as optional because generated `pkg/gsnake_wasm.js` may omit a default export while unit-test mocks still provide one.
- For `gsnake-editor/src/tests/integration.test.ts`, keep live endpoint checks opt-in with `GSNAKE_EDITOR_LIVE_INTEGRATION=1` and use explicit `it.skip` semantics by default, so CI avoids false-green placeholder assertions while enabled runs still enforce real HTTP contract checks.
- For `e2e/contract.spec.ts`, load deterministic fixture levels through `levelsUrl` using a `data:application/json,...` URL when asserting `CellType` coverage so tests are not coupled to mutable default levels or the editor API test server.
- In the `gsnake-core` workspace, run package-targeted checks with `cargo ... -p gsnake-core` (hyphenated package name); `gsnake_core` is the Rust crate import path, not the Cargo package ID.
- For `KeyboardHandler` unit coverage, set `gameState` per status (`Playing`, `GameOver`, `LevelComplete`, `AllComplete`) and assert side-effect exclusivity (`processMove` vs `restartLevel` vs `loadLevel`) so shortcut regressions are caught at state boundaries.

# Ralph Progress Log
Started: Fri Feb 20 10:55:27 CET 2026
---

## [2026-02-20 11:00:51 CET] - US-001
- Replaced tautological enum contract tests with runtime assertions backed by production guard arrays and cross-checked against generated TS unions plus Rust enum serialization names.
- Added reusable runtime enum guard constants/type guards and updated WASM import initialization handling to satisfy package typecheck without relying on a guaranteed default export.
- Files changed: `gsnake-web/packages/gsnake-web-app/contracts/enumGuards.ts`, `gsnake-web/packages/gsnake-web-app/tests/contract/enums.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Runtime enum contract tests are strongest when they compare three sources: production guard arrays, generated TS bindings, and Rust enum wire values.
  - `gsnake-wasm` module shape can differ between generated artifacts and mocks; default initializer should be feature-detected before calling.
  - `npm run check` for `gsnake-web-app` catches module-shape/type issues that `vitest` can miss due to mocking.
---

## [2026-02-20 11:05:37 CET] - US-002
- Reworked editor integration tests to remove unconditional pass fallbacks and replaced them with explicit opt-in skip semantics plus strict runtime assertions against `VITE_GSNAKE_WEB_URL` and `?test=true` route contracts.
- Files changed: `gsnake-editor/src/tests/integration.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Live cross-service checks in unit-test suites should be opt-in and skipped explicitly when the environment is not provisioned, instead of passing vacuously.
  - Integration assertions should validate concrete response contracts (status/content-type/app shell marker) so endpoint regressions produce a hard failure.
  - `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, and `npm --prefix gsnake-editor test` provide sufficient local quality gates for editor test-only changes.
---

## [2026-02-20 11:10:35 CET] - US-003
- Expanded `e2e/contract.spec.ts` CellType allowlists to the full 10-variant contract set and added a dedicated fixture-level E2E scenario that asserts `FloatingFood`, `FallingFood`, `Stone`, and `Spike` each appear in the runtime frame.
- Files changed: `e2e/contract.spec.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - Use `levelsUrl` with a `data:application/json,...` fixture in Playwright when you need deterministic level content without relying on `/api/test-level`.
  - Keep CellType allowlists centralized (for example `ALL_CELL_TYPES`) to prevent partial-contract drift across E2E scenarios.
  - `npx playwright test e2e/contract.spec.ts --project=chromium --reporter=list` is a fast targeted validation loop for contract-grid changes.
---

## [2026-02-20 11:18:27 CET] - US-004
- Verified and locked Rust contract coverage for all 10 `CellType` variants in both serialization and round-trip tests (`Empty`, `SnakeHead`, `SnakeBody`, `Food`, `Obstacle`, `Exit`, `FloatingFood`, `FallingFood`, `Stone`, `Spike`).
- Ran targeted Rust quality checks to confirm this story stays green.
- Files changed: `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - `cargo test --test contract_tests test_celltype_` is a fast targeted check for enum wire-contract coverage in `gsnake-core/engine/core/tests/contract_tests.rs`.
  - In the workspace, use `cargo check -p gsnake-core` (hyphenated package name) for package-scoped compile checks.
  - When a PRD story is already implemented in code, still record verification evidence in `progress.txt` before marking `passes: true`.
---

## [2026-02-20 11:20:26 CET] - US-005
- Added missing `KeyboardHandler` unit coverage for `Playing` shortcuts (`r` -> `restartLevel`, `q` -> `loadLevel(1)`) and `LevelComplete` no-op behavior.
- Verified keyboard tests assert no unintended side effects across `processMove`, `restartLevel`, and `loadLevel` for the new scenarios.
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/KeyboardHandler.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- **Learnings for future iterations:**
  - In keyboard-state tests, always set `gameState` explicitly before dispatch to avoid relying on prior test status.
  - Shortcut coverage should assert both the expected engine call and the absence of the other two engine actions.
  - For `gsnake-web-app` test-only updates, `npm --prefix gsnake-web/packages/gsnake-web-app run check && npm --prefix gsnake-web/packages/gsnake-web-app test` is a fast, sufficient quality gate.
---
