# Ralph Progress Log
Started: 2026-01-30
---
## Codebase Patterns
- CI results stored in scripts/test/result.txt (scripts/test/test_act.sh automatically run each iteration)
- Individual job logs in scripts/test/tmp_act_results/ with .log and .status files
- Test with act: act -W <workflow-path> -j <job-name> --container-architecture linux/amd64
- Submodules: gsnake-web, gsnake-editor, gsnake-levels, gsnake-specs
- Workflows use FORCE_GIT_DEPS=true for standalone mode testing
- Full test suite runs with scripts/test/test_act.sh (30+ minutes)
- the full test suite runs using pushed code on remote, so unpushed code are not reflected in the run. git push after committing.
---
## 2026-01-30 20:25 - US-001
- Fixed TypeScript type errors in gsnake-web/scripts/detect-local-deps.js
- Added JSDoc type annotations for `targetDependency` and `label` parameters in updateDependency function
- Excluded vendor directory from tsconfig.json to prevent type errors in generated WASM files
- Verified typecheck passes with: cd gsnake-web && npm run check
- Files changed: gsnake-web/scripts/detect-local-deps.js, gsnake-web/tsconfig.json

**Learnings for future iterations:**
- The gsnake-web typecheck uses `npm run check` which runs `svelte-check --tsconfig ./tsconfig.json`
- Generated/vendored code (like WASM bindings) should be excluded from TypeScript checking
- JSDoc type annotations are sufficient for fixing implicit 'any' errors in JavaScript files
- The repository structure has gsnake-web as a git submodule, so changes need to be committed in the submodule first, then the submodule reference updated in the root repo
---
## 2026-01-30 21:25 - US-002
- Verified typecheck now passes in deploy workflow validate job
- Fix from US-001 (gsnake-web TypeScript type annotations) resolved this issue
- Tested with: act -W .github/workflows/deploy.yml -j validate --container-architecture linux/amd64
- Typecheck step output: "svelte-check found 0 errors and 0 warnings"
- Files changed: scripts/ralph/prd.json (marked US-002 as passing)

**Learnings for future iterations:**
- Deploy workflow validate job runs the same typecheck as gsnake-web CI: `npm --prefix gsnake-web run check`
- The validate job includes multiple steps: typecheck, Rust contract tests, TypeScript contract tests, E2E contract tests
- The typecheck passes, but E2E tests in the validate job are failing (14 failed tests) - this is a separate issue
- Note: US-002 acceptance criteria is about typecheck passing, not the entire validate job passing
---
## 2026-01-30 22:30 - US-003
- Fixed gsnake-levels test workflow Cargo.toml path issue
- Added directory resolution logic to test.yml workflow to handle different checkout scenarios (act vs GitHub Actions)
- Fixed build.rs to create .cargo directory before writing config.toml
- Files changed: 
  - gsnake-levels/.github/workflows/test.yml (added directory resolution step)
  - gsnake-levels/build.rs (added fs::create_dir_all before writing config)
- Verified with: act -W gsnake-levels/.github/workflows/test.yml -j test --container-architecture linux/amd64
- Test results: 17 unit tests passed + 3 integration tests passed

**Learnings for future iterations:**
- The act tool (nektos/act) handles checkout differently than GitHub Actions - it copies the entire repo instead of just the submodule
- The ci.yml workflow (which passes) uses a "Resolve directory" pattern that checks multiple candidate paths: ".", "submodule-name", "submodule-name/submodule-name"
- This pattern sets an env var (LEVELS_DIR) and uses it in all subsequent steps with working-directory: ${{ env.LEVELS_DIR }}
- Build scripts that write to .cargo/config.toml must create the .cargo directory first with fs::create_dir_all
- When fixing CI workflows, check if similar workflows already exist (ci.yml) and reuse their patterns
- The act tool (nektos/act) checkouts the remote repository. Local unpushed changes are not seen.
---
## 2026-01-30 23:05 - US-004
- Fixed gsnake-web test workflow path resolution issues
- Added directory resolution logic similar to gsnake-levels (checks ".", "gsnake-web", "gsnake-web/gsnake-web")
- Removed problematic scripts symlink that was overwriting local gsnake-web/scripts directory
- Added dynamic ROOT_REL_PATH calculation based on WEB_DIR depth (handles ../../gsnake-root vs ../gsnake-root)
- Added Configure dependencies step to run detect-local-deps.js before npm install
- Changed npm ci to npm install to ensure preinstall hook runs and all dependencies install correctly
- Fixed Build WASM step to reference build_wasm.py from gsnake-root using calculated relative path
- Verified with: act -W gsnake-web/.github/workflows/test.yml -j test --container-architecture linux/amd64
- Test results: 3 test files, 41 tests, all passing
- Files changed:
  - gsnake-web/.github/workflows/test.yml
  - scripts/ralph/prd.json

**Learnings for future iterations:**
- The test.yml workflow tests with the root repo structure (different from ci.yml which uses FORCE_GIT_DEPS)
- Creating a symlink overwrites/hides the target directory - don't symlink directories that have their own content
- detect-local-deps.js is in gsnake-web/scripts/, not root scripts/, so the scripts symlink was hiding it
- The directory resolution pattern from gsnake-levels works well: check multiple candidates and set env var
- When WEB_DIR = "gsnake-web/gsnake-web", need ../../gsnake-root; when "gsnake-web", need ../gsnake-root
- npm ci skips preinstall scripts, use npm install if you need preinstall to run
- The workflow structure: checkout -> resolve directory -> setup tools -> symlinks -> build WASM -> configure deps -> install -> test
---
