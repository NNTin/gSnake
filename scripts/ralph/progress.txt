# Ralph Progress Log
Started: Thu Feb 19 16:54:50 CET 2026
---
## Codebase Patterns
- In `gsnake-editor`, tool-selection handlers should stay side-effect free for grid data; any state mutation that changes placed entities should go through the command/undo pipeline.
- In `EditorLayout.handleLoad`, hidden file inputs must use idempotent cleanup and hook both `change` and picker-close signals (`cancel` plus `window` focus fallback) so canceled dialogs do not leak DOM nodes.
- In `EditorLayout`, both export and test payloads should be built via `buildLevelExportPayload(...)` to keep `difficulty`, `snakeDirection`, and `totalFood` serialization rules aligned.
- In `EditorLayout` import paths, validate all entity coordinates against current grid bounds before mutating editor state so unsupported coordinates fail loudly instead of partially loading.
- In `SpriteLoader`, treat `spritesUrl` as trusted only after validating `response.ok` and `content-type: image/svg+xml`, then sanitize parsed SVG content before rendering via `{@html}`.
- In `gsnake-editor/server.ts`, resolve `GSNAKE_EDITOR_ALLOWED_ORIGINS` once at startup and keep per-request CORS checks bound to that frozen allowlist for deterministic policy behavior.
- In `gsnake-editor`, both landing-page and in-editor level-load paths should call shared `parseAndValidateLevelFileData(...)` from `src/lib/levelFileValidation.ts` so required-field and grid-size checks never drift.

## [2026-02-19 17:00:35 CET] - US-001
- Implemented US-001 by removing implicit snake auto-clear on snake-tool selection in `EditorLayout`, so selecting Snake no longer destroys existing snake segments outside undo/redo commands.
- Added regression coverage that places snake segments, switches to Food, reselects Snake, and asserts snake segments remain intact.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts`
- **Learnings for future iterations:**
  - `EntityPalette` emits `select` events; `EditorLayout.handleEntitySelect` should only update `selectedEntity` and avoid hidden grid mutations.
  - `EditorLayout.gridInteractions` tests are the right place for undo/tool-selection regressions affecting in-canvas behavior.
---
## [2026-02-19 17:46:15 CET] - US-002
- Implemented hidden file-input cleanup hardening in `EditorLayout.handleLoad` by introducing a single idempotent cleanup function wired to `change`, `cancel`, and a window-focus fallback for cancel flows.
- Added regression coverage that simulates canceling the load picker and verifies the temporary hidden file input is removed from the DOM.
- Refreshed CI artifact status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` and updated `scripts/test/result.txt` with success output.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Load-picker flows should not rely solely on `onchange`; canceled dialogs can skip `change` and leak temporary DOM nodes.
  - Cleanup helpers for transient DOM nodes should be idempotent (`parentNode` guard) because multiple completion paths can fire in browser and test environments.
  - `EditorLayout.saveLoad` tests are the right location for regressions around file-load lifecycle and hidden input teardown.
---
## [2026-02-19 18:33:12 CET] - US-003
- Replaced `EditorLayout.handleTest`â€™s ad-hoc payload assembly with `buildLevelExportPayload(...)` using test metadata (`id`, `name`, and default `difficulty`) so test uploads use the same canonical serializer as exports.
- Added a regression test that clicks `Test`, captures the POST body for `/api/test-level`, and asserts canonical payload fields including `difficulty`, runtime snake-direction conversion, and `totalFood`.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Attempted live `agent-browser` verification on `http://localhost:3003`, but repeated command hangs while interacting with editor controls prevented reliable end-to-end browser confirmation; manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - `EditorLayout.handleTest` should treat payload construction as shared model logic; keep endpoint-specific behavior limited to transport (`fetch`) and launch UX.
  - For editor-side API payload regressions, `EditorLayout.saveLoad.test.ts` can validate real request bodies by mocking `fetch` and asserting serialized JSON directly.
  - Refreshing CI with targeted `act -W ... -j ...` runs is sufficient for story-level validation while keeping iteration time low.
---
## [2026-02-19 19:22:53 CET] - US-004
- Implemented strict in-bounds coordinate validation for editor imports in `EditorLayout` and fail-fast error messaging so negative/out-of-range positions are rejected instead of silently dropped.
- Added regression coverage that loads a level containing `food[0]` at `(-1, 2)` and verifies the editor rejects it with user-facing feedback while leaving the grid unchanged.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Attempted live `agent-browser` verification on `http://localhost:3003`; hidden file-input automation was flaky in headless mode for this flow, so manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - `placeEntitiesFromLevelData(...)` should validate all incoming coordinates before clearing/rebuilding grid state, preventing partial imports on malformed payloads.
  - Regression tests for import validation belong in `EditorLayout.saveLoad.test.ts` and should assert both toast feedback and unchanged editor state.
  - For hidden file pickers in browser automation, direct `upload` may hang; fallback strategies are needed, and manual validation may still be required for picker-driven flows.
---
## [2026-02-19 20:09:57 CET] - US-005
- Hardened `SpriteLoader` to require successful fetch responses and `image/svg+xml` content types before loading sprite assets.
- Replaced raw sprite HTML injection with parse-and-sanitize flow that strips executable markup/attributes (`script`, `foreignObject`, `iframe`, `object`, `embed`, `on*`, `style`, `javascript:` URLs, non-fragment hrefs) before rendering.
- Added dedicated `SpriteLoader` regression tests for successful sanitization, non-SVG content-type rejection, and non-2xx response rejection.
- Verified in-browser with `agent-browser` on `http://localhost:3003`: sprite definitions load and `.sprite-loader svg` contains no script nodes, event attributes, or external href references.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/src/lib/SpriteLoader.svelte`, `gsnake-editor/src/tests/SpriteLoader.test.ts`, `gsnake-editor/README.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - For shared SVG sprite sheets, keep loader safety at the ingestion boundary: enforce response/content-type checks and sanitize SVG AST before render.
  - `SpriteLoader` regression tests should assert both happy path availability (`symbol` defs present) and hard-failure behavior (`sprite-loader` remains empty) for invalid responses.
  - `agent-browser eval` is effective for DOM-level security verification when visual assertions are insufficient.
---
## [2026-02-19 20:56:06 CET] - US-006
- Froze CORS allowlist resolution in `gsnake-editor/server.ts` by resolving `GSNAKE_EDITOR_ALLOWED_ORIGINS` once at module startup and reusing the frozen array for every request.
- Updated server CORS tests to assert deterministic behavior when environment variables change after startup, and added parser coverage for comma-separated allowlist values.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status with `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/server.ts`, `gsnake-editor/src/tests/server.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - CORS env configuration in `gsnake-editor/server.ts` is startup configuration, not runtime mutable state.
  - Server CORS regressions are best covered in `src/tests/server.test.ts` by asserting both allowed and rejected origins around env mutation scenarios.
  - Targeted root CI job `gsnake-editor-test` is sufficient to validate editor-side server/test changes in the Ralph loop.
---
## [2026-02-19 21:44:04 CET] - US-007
- Implemented a shared level-file validation module (`parseAndValidateLevelFileData` / `validateLevelFileData`) and replaced duplicated load validation logic in both `App.handleLoadExisting` and `EditorLayout.handleLoad`.
- Added App-level regression tests that exercise landing-page load acceptance (valid payload enters editor) and rejection (invalid payload stays on landing page), complementing existing in-editor load tests.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, and `npm --prefix gsnake-editor run test`; refreshed CI via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/src/lib/levelFileValidation.ts`, `gsnake-editor/src/App.svelte`, `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/App.loadExisting.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - `App.svelte` and `EditorLayout.svelte` should share level-file validation through a single helper to keep error semantics and accepted payload shape consistent across both entry points.
  - Landing-page load regressions are easiest to test by intercepting the transient file input created in `LandingPage` and dispatching a synthetic `change` event with a file-like object.
  - `svelte-5-french-toast` can require `window.matchMedia` in tests when an error toast path is exercised; provide a local stub in test setup for deterministic behavior.
---
