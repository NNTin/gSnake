## Codebase Patterns
- `GameEngine::process_move` returns `Result<bool, EngineError>`: use `Ok(false)` for rejected-but-valid gameplay input and `Err(...)` for runtime invariant violations; bindings decide how to map/report engine errors.
- `GameEngine::new` is a fallible constructor: propagate/annotate `EngineError` at app boundaries (CLI/WASM/tooling) instead of unwrapping, and include level identifiers in context strings for debuggability.
- In `gsnake-core/engine/bindings/cli`, never discard `GameEngine::process_move(...)` results; propagate errors with move-direction and level-id context so invariant failures surface as actionable CLI diagnostics.
- Grid-size boundary tests should use `MAX_GRID_CELLS` directly (`1x1` minimum valid, `MAX_GRID_CELLS x 1` maximum valid, `(MAX_GRID_CELLS + 1) x 1` overflow) to lock behavior to the engine's safety cap constant.
- For web startup level selection, pass the raw `level` query value to `WasmGameEngine.init(...)`; `WasmGameEngine` owns strict parsing and deterministic fallback-to-level-1 behavior.
- `WasmGameEngine.init(...)` startup invariants should assert one `levelChanged` then one `frameChanged` event with no `engineError` for normalized query inputs, so startup behavior stays stable across parsing refactors.
- Every `WasmGameEngine` path that creates a Rust engine (`init`/`loadLevel`/`nextLevel`/`resetLevel`) must call `getFrame()` immediately after `onFrame` registration and preserve event order `levelChanged` then `frameChanged`; keep the contract in `gsnake-web/packages/gsnake-web-app/engine/frame-emission.md`.
- `LevelDefinition` schema changes must be made in `contracts/level-definition.schema.json` and validated with `npm run test:level-schema`; keep fixtures in `contracts/fixtures/` updated in the same change.
- Keep `contracts/generated/level-definition-validator.ts` in sync with schema changes by running `npm run generate:level-validator`; `npm run test:level-schema` now enforces freshness via `npm run check:level-validator`.
- In `gsnake-web`, `packages/gsnake-web-app/contracts/levelDefinitionGuard.ts` should stay a typed wrapper around a generated validator artifact (`gsnake-web/contracts/generated/level-definition-validator.ts`) instead of maintaining manual field-by-field guards.
- Optional-field and `totalFood` semantics for editor/server round-trips are centralized in `contracts/level-definition-semantics.md`; source code should link there instead of re-documenting semantics ad hoc.
- For schema drift tests in submodules, resolve schema paths with monorepo-first and vendored-local fallback candidates so checks run in both monorepo CI and standalone submodule CI.
- Editor server LevelDefinition validation must flow through `src/server/levelDefinitionValidator.ts` (Ajv + canonical schema) and return `details` as `{ field, keyword, message }` objects so API errors stay field-addressable.
- E2E `LevelDefinition` contract guards should be centralized in `e2e/level-definition.ts` as a typed wrapper around `contracts/generated/level-definition-validator.ts`; API/E2E specs should import this helper instead of redefining local `isLevelDefinition` logic.
- Editor API validation tests should assert `details` entries by `field` + `keyword` (including nested paths like `snake.0.x` and `additionalProperties` paths like `stones.0.z`) so schema-driven failures stay stable and actionable.
- Svelte component unit tests in `gsnake-web-app` should use `// @vitest-environment jsdom`, instantiate components with `new Component({ target: document.body, props })`, and reset `document.body.innerHTML` between tests for deterministic DOM assertions.
- For composed Svelte UI units (for example `Header.svelte`), assert action wiring through `data-element-id` buttons and verify both store side effects and engine stub calls to keep interaction contracts stable.
- For interactive Svelte button components, keep native button semantics (`type="button"` and `disabled`) and add dedicated tests that assert enabled/disabled state via DOM attributes plus click side effects.
- `KeyboardHandler` should forward rapid directional key events to `processMove` in order and leave lock/rejection decisions to the engine; tests should validate this via `attach()` + `window.dispatchEvent(...)`.
- In `gsnake-web` contract tests, keep CellType coverage centralized with shared variant lists and pair `isFrame(...)` assertions with explicit invalid-cell diagnostics so enum drift (casing/whitespace/non-string payloads) fails with actionable messages.
- In `gsnake-core` stone interaction contract tests, use a dedicated fixture level with a fixed obstacle platform row so gravity is deterministic and push-matrix assertions focus on interaction semantics rather than fall order side effects.
- In `gsnake-core`, preserve physics sequencing in `GameEngine::process_move` (collision -> win -> snake gravity -> stone gravity -> falling-food gravity) and validate intentional changes against the order-locking tests documented in `gsnake-core/README.md`.
- CLI playback parsing should attach `anyhow::Context` at each stage (file read, JSON parse, per-step key parse with step index + file path) so malformed playback diagnostics are actionable without panics.
- In `gsnake-levels` tests that mutate process CWD, prefer lock helpers that return `Result` (`?`) over `expect(...)` on `cwd_mutex` so generation-path regressions surface as test errors instead of panic paths.
- In Rust tests that assert `Result<T, anyhow::Error>`, avoid `assert_eq!(result, Ok(...))` because `anyhow::Error` has no `PartialEq`; use explicit `match` assertions for Ok/Err paths.
- `gsnake-levels validate-levels-toml` should aggregate issues with deterministic numbered output (`[io]`, `[parse]`, `[validation]`) and continue scanning all difficulties/entries in one run.
- Before rerunning root `act` E2E (`.github/workflows/ci.yml::e2e-test`) after broad sudden failures, clear stale host Playwright processes (`pkill -f 'chromium_headless_shell|playwright_chromiumdev_profile' || true`); workflow cleanup relies on `fuser`, which may be unavailable in the act container.

# Ralph Progress Log
Started: Sun Feb 15 20:54:09 CET 2026
---
## 2026-02-15 22:24:05 CET - US-001
- Replaced snake-head access `unwrap` in `GameEngine::process_move` with explicit guarded access and structured `EngineError` propagation for malformed empty-snake runtime state.
- Added `EngineError::SnakeHasNoSegments` with a clear diagnostic message and updated engine tests to assert `Err(EngineError::SnakeHasNoSegments)` rather than panic-like behavior.
- Updated affected consumers/callers for the new `Result<bool, EngineError>` contract (`gsnake-wasm`, CLI binding, and core/CLI demo flows), including WASM-side mapping to `ContractErrorKind::InternalError`.
- Files changed: `gsnake-core/engine/core/src/engine.rs`, `gsnake-core/engine/core/src/models.rs`, `gsnake-core/engine/bindings/wasm/src/lib.rs`, `gsnake-core/engine/bindings/cli/src/main.rs`, `gsnake-core/engine/bindings/cli/examples/ui_demo.rs`, `gsnake-core/engine/core/examples/gameplay_demo.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: for engine move semantics, callers must handle both soft rejection (`Ok(false)`) and hard invariant errors (`Err(EngineError)`); this avoids silently swallowing malformed state.
  - Gotchas encountered: changing a core engine API requires propagating signature updates through bindings and demos, not just core tests.
  - Useful context: WASM adapter maps engine invariant failures to `ContractErrorKind::InternalError` and should preserve the engine error message for debugging.
---
## 2026-02-15 23:05:16 CET - US-002
- Added constructor-time grid-size validation in `GameEngine::new` and made the constructor fallible (`Result<Self, EngineError>`) so invalid dimensions are rejected before runtime frame/grid usage.
- Added `EngineError::InvalidGridSize { width, height }` and `EngineError::GridSizeExceedsMaxCells { ... }` with explicit messages including invalid values; introduced `MAX_GRID_CELLS` as the enforced safety cap.
- Updated engine consumers (core tests/examples, wasm binding, CLI binding, and `gsnake-levels` verification/solver tooling) to handle constructor errors via propagation/context or explicit test/demo `expect(...)`.
- Added regression coverage for non-positive and oversized grid-size rejection and ensured defensive frame generation behavior is still safe for malformed runtime state.
- Files changed: `gsnake-core/engine/core/src/models.rs`, `gsnake-core/engine/core/src/engine.rs`, `gsnake-core/engine/core/examples/gameplay_demo.rs`, `gsnake-core/engine/bindings/wasm/src/lib.rs`, `gsnake-core/engine/bindings/cli/src/main.rs`, `gsnake-core/engine/bindings/cli/examples/ui_demo.rs`, `gsnake-levels/src/verify.rs`, `gsnake-levels/src/bin/solve_level.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: constructor contract changes in `gsnake-core` ripple into sibling tooling repos (`gsnake-levels`) because they consume the same engine API.
  - Gotchas encountered: `Result::expect_err` on `initialize_engine` required avoiding a `Debug` bound on `WasmGameEngine`; use explicit `match` when only the error path matters.
  - Useful context: CLI/WASM entrypoints now surface invalid grid-size errors with level-specific context, making malformed level debugging deterministic.
---
## 2026-02-15 23:48:28 CET - US-003
- Added explicit grid-size boundary tests in `GameEngine` for negative, zero, minimum valid, maximum valid, and maximum+1 cases.
- Asserted exact `EngineError` variants and messages for invalid boundary values, and asserted successful engine creation at both valid boundaries.
- Ran `cargo test --manifest-path gsnake-core/engine/core/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/core/src/engine.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: engine boundary tests are colocated in `gsnake-core/engine/core/src/engine.rs` under `mod tests` and should validate both error variant and error message text.
  - Gotchas encountered: `act` output is verbose and truncated in terminal captures; keep a concise summary in `scripts/test/result.txt` for iteration traceability.
  - Useful context: root CI `test` job runs `cargo test -p gsnake-core --verbose` plus the `generate_contract_fixtures` test target, so core engine boundary regressions are covered there.
---
## 2026-02-16 00:27:11 CET - US-004
- Hardened `WasmGameEngine` start-level parsing to reject invalid query-like inputs (`NaN`, empty, decimal, text, non-positive) and centralized the fallback behavior in engine code.
- Updated startup semantics so out-of-range start levels deterministically fall back to level 1, and switched `App.svelte` to pass the raw `level` query param into `WasmGameEngine.init(...)`.
- Added/updated `WasmGameEngine` unit coverage for invalid query-like values fallback, above-range fallback behavior, and valid integer string handling.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, `gsnake-web/packages/gsnake-web-app/components/App.svelte`, `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: URL-level sanitization should be engine-owned to keep every startup entrypoint consistent (query parsing and direct init calls).
  - Gotchas encountered: running `act` for submodule workflows from the monorepo root can break relative script paths; run from submodule root with local workflow path.
  - Useful context: browser tools were not available in this iteration, so manual browser verification is still needed for the URL-query startup path.
---
## 2026-02-16 01:06:40 CET - US-005
- Expanded `WasmGameEngine` query-parameter regression coverage into deterministic permutation tests for valid integer, NaN, empty, decimal, text, below-range, and above-range inputs.
- Added assertions for selected startup level identity and initialization consistency (`levelChanged` then `frameChanged`, no `engineError`) across each query-input scenario.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: query-input regression tests are most robust when they assert both loaded level identity and emitted startup events, not only fallback index.
  - Gotchas encountered: if `act` runs against a submodule workflow, execute from that submodule directory so relative script paths resolve correctly.
  - Useful context: this story required test and docs hardening only; browser verification was not required because no UI behavior changed.
---
## 2026-02-16 01:47:25 CET - US-006
- Added a canonical shared `LevelDefinition` JSON Schema at `contracts/level-definition.schema.json`, including optional fields (`floatingFood`, `fallingFood`, `stones`, `spikes`, `exitIsSolid`, `difficulty`) and documented `totalFood` semantics.
- Added schema fixture set under `contracts/fixtures/` for valid minimal payload, valid optional-field payload, missing-`totalFood` rejection, and invalid optional-field shape rejection.
- Added contract ownership/import workflow documentation in `contracts/README.md` and created `scripts/contracts/validate-level-definition-schema.mjs` plus `npm run test:level-schema` to enforce fixture-based schema validation.
- Ran `npm run test:level-schema` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `contracts/level-definition.schema.json`, `contracts/fixtures/level-definition.valid.json`, `contracts/fixtures/level-definition.valid-optionals.json`, `contracts/fixtures/level-definition.invalid-missing-total-food.json`, `contracts/fixtures/level-definition.invalid-optional-shape.json`, `contracts/README.md`, `scripts/contracts/validate-level-definition-schema.mjs`, `package.json`, `package-lock.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: the canonical contract lives at repo root (`contracts/`) so editor/web/e2e tooling can consume the same schema artifact.
  - Gotchas encountered: draft 2020-12 schemas require Ajv's 2020 runtime (`ajv/dist/2020.js`) for local fixture validation.
  - Useful context: this story changed shared contract artifacts/documentation only, so browser verification was not required.
---
## 2026-02-16 02:27:00 CET - US-007
- Replaced `gsnake-editor/server.ts` manual LevelDefinition checks with schema-driven validation via new `src/server/levelDefinitionValidator.ts` using Ajv 2020 and canonical schema lookup.
- Added structured field-level validation response details (`{ field, keyword, message }`) while keeping the existing top-level API error contract (`error: \"Invalid level payload\"`).
- Added standalone-safe schema fallback by vendoring `gsnake-editor/contracts/level-definition.schema.json` and resolving schema path in both monorepo and standalone editor CI contexts.
- Updated server API tests to assert structured validation errors and keyword/field mappings for malformed payloads.
- Ran `npm run check`, `npm run lint`, `npm test` in `gsnake-editor`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-editor` (all success).
- Files changed: `gsnake-editor/.gitignore`, `gsnake-editor/contracts/level-definition.schema.json`, `gsnake-editor/README.md`, `gsnake-editor/package.json`, `gsnake-editor/package-lock.json`, `gsnake-editor/server.ts`, `gsnake-editor/src/server/levelDefinitionValidator.ts`, `gsnake-editor/src/tests/server.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: map Ajv `instancePath` + `required`/`additionalProperties` params into dot-path field identifiers so clients can tie validation failures directly to form inputs.
  - Gotchas encountered: `server.ts` imports must omit `.ts` suffix because the editor typecheck path does not enable `allowImportingTsExtensions`.
  - Useful context: editor standalone CI (`FORCE_GIT_DEPS=1`) cannot rely on monorepo-only paths; schema loading needs a local fallback artifact.
---
## 2026-02-16 03:10:31 CET - US-008
- Extracted shared `LevelDefinition` typing and `isLevelDefinition` guard into `e2e/level-definition.ts` and removed duplicated ad-hoc guard/type blocks from the two target E2E specs.
- Updated `e2e/complete-workflow.spec.ts` and `e2e/level-validation.spec.ts` to import `LevelDefinition` and `isLevelDefinition` from the shared utility.
- Ran `npm run test:e2e -- e2e/complete-workflow.spec.ts e2e/level-validation.spec.ts` and `act -W .github/workflows/ci.yml -j e2e-test --container-architecture linux/amd64` (success).
- Files changed: `e2e/level-definition.ts`, `e2e/complete-workflow.spec.ts`, `e2e/level-validation.spec.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: when E2E specs validate serialized LevelDefinition payloads, import `isLevelDefinition` from `e2e/level-definition.ts` to keep contract checks synchronized.
  - Gotchas encountered: `act` E2E job first-run setup is heavy (Playwright/browser packages), so expect longer runtime even for small test-only refactors.
  - Useful context: this story changed test utilities/spec wiring only; no product UI behavior changed.
---
## 2026-02-16 03:57:26 CET - US-009
- Added contract drift protection tests that compare canonical schema verdicts against runtime consumers: `gsnake-editor/src/tests/levelDefinitionSchemaDrift.test.ts` (editor validator + schema parity) and `gsnake-web/packages/gsnake-web-app/tests/contract/levelDefinitionSchemaDrift.test.ts` (web guard parity).
- Extracted and hardened web `LevelDefinition` guard logic into `gsnake-web/packages/gsnake-web-app/contracts/levelDefinitionGuard.ts`, wired `App.svelte` to consume it, and aligned checks with schema semantics (integer/range validation and additional-property rejection).
- Added standalone-safe schema artifact in `gsnake-web/contracts/level-definition.schema.json` and updated web/editor drift tests to resolve canonical schema via monorepo + vendored fallback paths.
- Ran `npm run check` + `npm test` in `gsnake-web` and `gsnake-editor`, then ran `act` jobs: `gsnake-web/.github/workflows/ci.yml::{typecheck,test}` and `gsnake-editor/.github/workflows/ci.yml::{typecheck,test}` (all success).
- Files changed: `gsnake-web/contracts/level-definition.schema.json`, `gsnake-web/packages/gsnake-web-app/contracts/levelDefinitionGuard.ts`, `gsnake-web/packages/gsnake-web-app/components/App.svelte`, `gsnake-web/packages/gsnake-web-app/tests/contract/levelDefinitionSchemaDrift.test.ts`, `gsnake-web/packages/gsnake-web-app/package.json`, `gsnake-web/package-lock.json`, `gsnake-editor/src/tests/levelDefinitionSchemaDrift.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: drift tests should validate consumer parity against schema verdicts rather than only fixture pass/fail labels, so integer/additional-property drift is caught early.
  - Gotchas encountered: `act` cannot run same workflow/job names concurrently in one repo due container-name collisions; run targeted jobs sequentially.
  - Useful context: web/editor standalone CI runs without monorepo root, so tests must not assume `../contracts` exists outside each submodule unless fallback handling is implemented.
---
## 2026-02-16 04:38:10 CET - US-010
- Added editor API edge-case regression tests for `gridSize.width=0`, negative coordinate payload handling, invalid coordinate types, and multi-field invalid payload combinations with stable structured validation details.
- Verified HTTP status + error response contract behavior (`400` + `error/details`) for rejected payloads and round-trip storage for schema-valid negative coordinates.
- Ran `npm run check`, `npm run lint`, `npm test` in `gsnake-editor`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-editor` (all success).
- Files changed: `gsnake-editor/src/tests/server.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: schema-driven server tests should validate `field` and `keyword` together to make Ajv path normalization regressions visible.
  - Gotchas encountered: negative coordinates are currently schema-valid for `position` fields, so edge-case coverage should explicitly assert acceptance semantics where intended.
  - Useful context: this story was API/test hardening only; browser verification was not required because no UI behavior changed.
---
## 2026-02-16 05:15:25 CET - US-011
- Added a dedicated `Cell.svelte` unit test suite at `gsnake-web/packages/gsnake-web-app/tests/unit/Cell.test.ts` covering sprite reference rendering for representative gameplay cell variants.
- Added opacity assertions for variant-specific visual output (`Spike`, `Stone`, `Obstacle`) plus default-opacity variants and a reactive update test validating DOM changes when `type` props change.
- Ran `npm run check` and `npm test` in `gsnake-web/packages/gsnake-web-app`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/Cell.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: for Svelte component-only tests, instantiate components directly and assert emitted DOM attributes/styles without pulling in extra UI testing libraries.
  - Gotchas encountered: `gsnake-web` act jobs must be run from the `gsnake-web` submodule root so standalone dependency rewriting paths resolve correctly.
  - Useful context: browser tooling is not configured in this environment, so manual browser verification is still needed for UI-story visual checks.
---
## 2026-02-16 05:53:14 CET - US-012
- Added a dedicated `Header.svelte` unit test suite at `gsnake-web/packages/gsnake-web-app/tests/unit/Header.test.ts`.
- Covered representative header rendering states by asserting score labels (`Level`, `Length`, `Moves`) and corresponding values from stores, including reactive updates after store changes.
- Verified header action wiring by asserting `Levels` toggles `levelSelectorOpen` and `Restart` invokes `gameEngine.restartLevel()`.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/Header.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: in composed component tests, assert both rendered state and side effects from child controls (`store` mutation + engine callback) to lock UI wiring contracts.
  - Gotchas encountered: focused `vitest --run` filters are relative to the package cwd; using repo-root paths reports `No test files found`.
  - Useful context: browser tooling is not configured in this environment, so manual browser verification is still needed for UI-story visual checks.
---
## 2026-02-16 06:31:12 CET - US-013
- Added disabled-state support to `RestartButton.svelte` (`disabled` prop, native `disabled` attribute, and `aria-disabled`) while preserving existing restart behavior for enabled usage.
- Added dedicated unit coverage in `tests/unit/RestartButton.test.ts` for default enabled rendering, disabled rendering, enabled click wiring (`restartLevel`), focus blur behavior, and reactive disabled toggling.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/components/RestartButton.svelte`, `gsnake-web/packages/gsnake-web-app/tests/unit/RestartButton.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: component-level button tests should assert native accessibility semantics (`type="button"`, `disabled`, `aria-disabled`) in addition to action callbacks.
  - Gotchas encountered: when adding disabled behavior to a reused button component, keep default props backward-compatible so parent components need no wiring changes.
  - Useful context: browser tooling is not configured in this environment, so manual browser verification is still needed for this UI-component story.
---
## 2026-02-16 07:09:07 CET - US-014
- Expanded `KeyboardHandler` unit coverage with rapid repeated key input assertions through the real `window` listener path, validating directional events are forwarded in order to `processMove`.
- Added regression tests for modifier-key combinations (`ctrl`, `alt`, `shift`, `meta`) and non-movement key behavior (`Tab`, `Escape`, arbitrary keys) to ensure deterministic ignore/prevent-default behavior.
- Updated engine module documentation with reusable KeyboardHandler testing/ownership guidance in `engine/CLAUDE.md`.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/unit/KeyboardHandler.test.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: KeyboardHandler coverage is strongest when tests dispatch real `window` keydown events after `attach()`, since that exercises listener wiring and prevent-default behavior together.
  - Gotchas encountered: `gsnake-web` workspace does not define a root `lint` script, so quality checks for this area should use `npm run check` + `npm test` plus workflow `act` jobs.
  - Useful context: input lock/rejection behavior is enforced by engine `processMove`; web handler tests should verify forwarding order, not local debounce/queue logic.
---
## 2026-02-16 07:48:26 CET - US-015
- Expanded `gsnake-web/packages/gsnake-web-app/tests/contract/types.test.ts` with shared CellType variant constants and explicit coverage for `FloatingFood`, `FallingFood`, `Stone`, and `Spike` in both direct type-guard and mixed-frame scenarios.
- Added mixed-variant frame fixture assertions and invalid variant regression coverage (casing drift, whitespace drift, unknown string, non-string) with explicit expected validation-error messages via a test-local `validateFrameCellTypes(...)` helper.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/tests/contract/types.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: contract tests are more durable when they assert both positive mixed-variant acceptance and deterministic invalid-cell diagnostics for drift-prone payload variants.
  - Gotchas encountered: `isFrame(...)` alone only returns a boolean, so pairing it with an explicit diagnostic helper in tests avoids opaque failures when enum strings drift.
  - Useful context: this iteration changed contract tests only; browser verification was not required.
---
## 2026-02-16 08:28:56 CET - US-016
- Expanded `gsnake-core/engine/core/tests/contract_tests.rs` with a stone interaction matrix covering: single horizontal push success, horizontal row push success, blocked row push, vertical push rejection, horizontal push into vertical stack (only same-row stone moves), and stone destruction when pushed onto spike.
- Added reusable test helpers (`create_stone_matrix_level`, `create_engine`) to keep matrix fixtures deterministic and make expected outcomes explicit in test names/assertions.
- Ran `cargo test --manifest-path gsnake-core/engine/core/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/core/tests/contract_tests.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: stone matrix coverage is most stable when tests isolate push behavior from gravity with an explicit support platform.
  - Gotchas encountered: root `test` workflow job recompiles contract tests and runs `generate_contract_fixtures`, so matrix changes must remain compatible with fixture-generation path.
  - Useful context: this story changed core contract tests only; browser verification was not required.
---
## 2026-02-16 09:08:23 CET - US-017
- Replaced panic-prone playback parsing paths in `gsnake-core/engine/bindings/cli/src/playback.rs` by removing runtime `unwrap` usage and adding structured `anyhow::Context` on JSON parse and per-step key parsing.
- Added regression coverage to assert malformed playback errors include parse stage, step index, file path, and underlying invalid-key detail via the full error chain.
- Ran `cargo test --manifest-path gsnake-core/engine/bindings/cli/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/bindings/cli/src/playback.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: when wrapping parse failures with `anyhow::Context`, assert nested diagnostics with `format!("{err:#}")` in tests to validate full error chains, not just top-level messages.
  - Gotchas encountered: `Error::to_string()` only surfaces the outer context message, so direct string assertions can miss inner parse causes unless chain formatting is used.
  - Useful context: this story affected CLI/tooling parsing only; browser verification was not required.
---
## 2026-02-16 09:46:35 CET - US-018
- Replaced `expect(...)` panic paths in `gsnake-levels/src/generate.rs` tests (cwd mutex acquisition) with a shared `Result`-based lock helper, keeping generation-path tests aligned with graceful-error handling goals.
- Hardened level JSON parse diagnostics in `load_level(...)` to include the failing file path context and added a regression test that asserts stable malformed-level error messaging.
- Ran `cargo test` in `gsnake-levels` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-levels` (success).
- Files changed: `gsnake-levels/src/generate.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: generation-path failure tests are more actionable when assertions use chained diagnostics (`format!("{err:#}")`) and include the level file path.
  - Gotchas encountered: `cwd_mutex().lock()` poison errors can be converted into `anyhow` once in a helper to avoid repeated panic-prone `expect(...)` calls across tests.
  - Useful context: this story was generation command hardening + tests only; browser verification was not required.
---
## 2026-02-16 10:27:45 CET - US-019
- Hardened `gsnake-levels/src/migration.rs` migration error handling with step-specific `anyhow::Context` messages for read/parse/serialize/write/validate operations, each including the target file path.
- Removed `unwrap` usage from migration module tests by switching to `Result`-returning tests and explicit `match` assertions, and added regression coverage for malformed JSON migration input and missing level file errors.
- Ran `cargo test` in `gsnake-levels` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-levels` (success).
- Files changed: `gsnake-levels/src/migration.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: migration-path regression tests should assert chained errors via `format!("{err:#}")` so both step context and root parse/validation failures remain visible.
  - Gotchas encountered: `act` validates a snapshot taken at job start; if source changes during a run, rerun the job to test the latest code.
  - Useful context: `Result<T, anyhow::Error>` comparisons need `match`-based assertions because `anyhow::Error` is not `PartialEq`.
---
## 2026-02-16 11:10:11 CET - US-020
- Implemented multi-error aggregation for `validate-levels-toml` by introducing structured issue collection across all difficulties and level entries with stable numbered stderr output.
- Added issue typing (`io`/`parse`/`validation`) and deterministic exit-code selection, then expanded tests to cover intra-difficulty aggregation, cross-difficulty aggregation, and output-format stability.
- Added CLI regression coverage proving one command run reports multiple actionable issues (`missing JSON` + `invalid JSON`) instead of fail-fast behavior.
- Ran `cargo test --manifest-path gsnake-levels/Cargo.toml` and `act -W gsnake-levels/.github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-levels/src/validate_levels_toml.rs`, `gsnake-levels/tests/cli_error_paths_test.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: validation workflows are easier to triage when they emit typed, ordered issue lists and reserve process exit codes for coarse severity.
  - Gotchas encountered: keep aggregation order deterministic (difficulty order then entry order) so CLI-output assertions remain stable.
  - Useful context: `validate-levels-toml` now returns parse exit code (`3`) whenever any parse issue is present, even when IO/validation issues are also collected.
---
## 2026-02-16 11:50:14 CET - US-021
- Added focused order-dependency comments in `gsnake-core/engine/core/src/gravity.rs` documenting why stone gravity remains incremental/fixed-point and linking to regression tests that lock collision/platform semantics.
- Added a new `Physics Order Invariants` section to `gsnake-core/README.md` documenting the required `process_move` sequencing, rationale for off-by-one risk, and maintenance guidance for future edits.
- Ran `cargo test --manifest-path gsnake-core/engine/core/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/core/src/gravity.rs`, `gsnake-core/README.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: physics-order docs are most effective when they pair the required sequencing rule with concrete test names that should fail on regressions.
  - Gotchas encountered: this area has no nearby `CLAUDE.md`, so reusable guidance should live in `gsnake-core/README.md` and `scripts/ralph/progress.txt`.
  - Useful context: browser verification was not required because this story changed Rust/docs only.
---
## 2026-02-16 12:28:42 CET - US-022
- Added a single authoritative developer document for LevelDefinition optional-field and `totalFood` semantics at `contracts/level-definition-semantics.md`, including explicit editor/server round-trip expectations.
- Linked semantics guidance from relevant editor/server source paths so maintainers can discover the contract directly from serialization and validation code.
- Refreshed CI evidence with local quality checks plus `act` runs for `gsnake-editor` (`typecheck`, `test`).
- Files changed: `contracts/level-definition-semantics.md`, `contracts/README.md`, `gsnake-editor/src/lib/levelModel.ts`, `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/server/levelDefinitionValidator.ts`, `gsnake-editor/server.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: semantic contracts that span editor serialization and server validation should live under `contracts/` and be referenced from code entrypoints on both sides.
  - Gotchas encountered: optional arrays are schema-optional for compatibility, but editor serialization should still emit them explicitly to keep round-trip payloads stable.
  - Useful context: browser tooling is not configured in this environment; this story was documentation/source-linking only, so manual browser verification was not required.
---
## 2026-02-16 13:06:47 CET - US-023
- Added a single authoritative frame-emission contract document at `gsnake-web/packages/gsnake-web-app/engine/frame-emission.md`, documenting required engine-create sequence and explicit `getFrame()` behavior.
- Updated discovery links to the contract from `gsnake-web/README.md`, `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, and `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`.
- Strengthened `WasmGameEngine` regression coverage to assert `getFrame()` is called once per engine creation path and that event order remains `levelChanged` then `frameChanged` across init/next/reset flows.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/README.md`, `gsnake-web/packages/gsnake-web-app/engine/frame-emission.md`, `gsnake-web/packages/gsnake-web-app/engine/WasmGameEngine.ts`, `gsnake-web/packages/gsnake-web-app/engine/CLAUDE.md`, `gsnake-web/packages/gsnake-web-app/tests/unit/WasmGameEngine.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: frame emission expectations should be maintained as a contract document plus unit tests, not just inline comments, so load/reset refactors cannot silently break first render.
  - Gotchas encountered: init-only startup assertions are not enough; reset and next-level paths also construct engines and must keep the same `levelChanged` â†’ `frameChanged` order.
  - Useful context: browser tooling is not configured in this environment; this story changed docs/comments/tests only, so manual browser verification was not required.
---
## 2026-02-16 13:59:55 CET - US-024
- Completed final reliability-hardening verification sweep and updated status notes in `gsnake-specs/tasks/prd-codebase-reliability-hardening.md` with implemented outcomes and residual risks.
- Ran quality checks with `act`: `./.github/workflows/ci.yml::e2e-test`, `gsnake-specs/.github/workflows/ci.yml::markdown-lint`, and `gsnake-specs/.github/workflows/ci.yml::link-check` (all success on final rerun).
- Marked `US-024` as passed in `scripts/ralph/prd.json` and refreshed `scripts/test/result.txt` with this iteration's CI status update.
- Files changed: `gsnake-specs/tasks/prd-codebase-reliability-hardening.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`, `scripts/test/CLAUDE.md`.
- **Learnings for future iterations:**
  - Patterns discovered: root `act` E2E failures with many rapid spec failures can be environmental; clear stale Playwright processes before rerun.
  - Gotchas encountered: `.github/workflows/ci.yml` E2E cleanup calls `fuser`, but `fuser` is unavailable in the act container image; host leftovers can survive until explicitly cleaned.
  - Useful context: browser MCP tooling is not configured in this environment; this story updated docs/status artifacts and CI evidence only.
---
## 2026-02-16 16:59:41 CET - US-001
- Added a root generation workflow for a shared TypeScript LevelDefinition runtime validator (`scripts/contracts/generate-level-definition-validator.mjs`) that compiles `contracts/level-definition.schema.json` via Ajv standalone and emits `contracts/generated/level-definition-validator.ts`.
- Added reproducible root commands in `package.json` (`generate:level-validator`, `check:level-validator`) and updated `test:level-schema` to enforce validator freshness before fixture checks.
- Updated contract docs to document the generated artifact location and regeneration workflow.
- Ran `npm run generate:level-validator`, `npm run test:level-schema`, and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `scripts/contracts/generate-level-definition-validator.mjs`, `contracts/generated/level-definition-validator.ts`, `contracts/README.md`, `package.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep schema-derived validator output committed under `contracts/generated/` so all packages can import one canonical runtime guard source.
  - Gotchas encountered: Ajv standalone emits `require(...)` runtime helpers even with ESM codegen, so generation should normalize those imports for ESM-friendly TypeScript output.
  - Useful context: this story changed shared contract tooling/docs only; no browser verification was required.
---
## 2026-02-16 17:39:37 CET - US-002
- Replaced the manual web `LevelDefinition` guard implementation with a typed wrapper that delegates validation to a generated schema-derived validator.
- Added a vendored generated validator artifact at `gsnake-web/contracts/generated/level-definition-validator.ts` and updated web drift-test messaging to reference generated-validator alignment.
- Added `../../../contracts` to `gsnake-web-app` Vite `server.fs.allow` so the app can import the shared generated validator from the web submodule-level contracts directory in dev/test workflows.
- Ran `npm run check` and `npm test` in `gsnake-web`, plus `act -W .github/workflows/ci.yml -j typecheck --container-architecture linux/amd64` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` in `gsnake-web` (all success).
- Files changed: `gsnake-web/packages/gsnake-web-app/contracts/levelDefinitionGuard.ts`, `gsnake-web/packages/gsnake-web-app/tests/contract/levelDefinitionSchemaDrift.test.ts`, `gsnake-web/packages/gsnake-web-app/vite.config.ts`, `gsnake-web/contracts/generated/level-definition-validator.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: web runtime contract checks should consume generated validators and keep app-level files as typed wrappers only.
  - Gotchas encountered: when importing shared contract artifacts from outside `gsnake-web-app`, update Vite `server.fs.allow` or dev/test runs can fail with out-of-root access errors.
  - Useful context: browser tooling is not configured in this environment; this story changed contract-validation plumbing and tests, so manual browser verification can be done separately if desired.
---
## 2026-02-16 18:23:45 CET - US-003
- Replaced duplicate E2E `LevelDefinition` guard internals in `e2e/level-definition.ts` with a typed wrapper around the shared generated validator (`contracts/generated/level-definition-validator.ts`) and aligned the exported type with `gsnake-web` model types.
- Kept existing E2E spec import paths stable (`./level-definition`) so all API/E2E checks now transitively use the shared validator path without local guard duplication.
- Ran `npx playwright test e2e/level-validation.spec.ts e2e/complete-workflow.spec.ts --reporter=list` and `act -W .github/workflows/ci.yml -j e2e-test --container-architecture linux/amd64` (success).
- Files changed: `e2e/level-definition.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep E2E validator consumption behind `e2e/level-definition.ts` so specs get schema-generated behavior via one typed wrapper.
  - Gotchas encountered: E2E helper type exports can drift unless they reuse `gsnake-web` model types rather than re-declaring `LevelDefinition`.
  - Useful context: this story changed E2E contract helper plumbing only; browser UI verification was covered by the root `e2e-test` workflow run.
---
## 2026-02-16 19:03:31 CET - US-004
- Removed remaining panic-style `expect(...)` usage in CLI source tests (`levels.rs`) and strengthened CLI runtime error propagation for move processing by surfacing `process_move(...)` failures with direction + level-id context.
- Hardened CLI level-loading diagnostics so malformed JSON errors include both parse stage and source file path for `load_levels(...)` and `load_level_from_file(...)`.
- Added regression coverage for malformed level JSON paths in both level-loading module tests and CLI argument-path tests.
- Ran `cargo test --manifest-path gsnake-core/engine/bindings/cli/Cargo.toml` and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-core/engine/bindings/cli/src/main.rs`, `gsnake-core/engine/bindings/cli/src/levels.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: CLI gameplay paths should treat `process_move(...)` errors as actionable runtime failures, not ignorable events.
  - Gotchas encountered: parse-context assertions are more stable when tests check the full chained error (`format!("{err:#}")`) instead of only `to_string()`.
  - Useful context: root `act` test job exercises `gsnake-core` contract tests plus fixture generation, so CLI binding error-handling changes are covered in that run.
---
## 2026-02-16 19:43:01 CET - US-005
- Removed remaining production `unwrap(...)` in `gsnake-levels/src/playback.rs` by making single-character key extraction fallible and propagating errors via `Result`.
- Added per-step playback parse context (`Failed to parse playback step N in <path>`) so `verify` command failures report actionable location details instead of opaque key errors.
- Added regression coverage for invalid playback keys in both unit (`playback.rs`) and CLI integration (`tests/cli_error_paths_test.rs`) paths.
- Ran `cargo check` and `cargo test` in `gsnake-levels` (success), and ran `act` for `gsnake-levels` workflows (failed due external checkout/dependency issues noted below).
- Files changed: `gsnake-levels/src/playback.rs`, `gsnake-levels/tests/cli_error_paths_test.rs`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`.
- **Learnings for future iterations:**
  - Patterns discovered: keep playback parsing errors wrapped with step index + playback file path context so CLI verification failures are directly traceable to an input row.
  - Gotchas encountered: `act -W gsnake-levels/.github/workflows/ci.yml -j test` can fail independently of local code when upstream git dependency submodule refs are unavailable.
  - Useful context: `act -W gsnake-levels/.github/workflows/test.yml -j test` requires a GitHub token for the cross-repo checkout step (`NNTin/gSnake`), so local `cargo test` remains the reliable signal in tokenless environments.
---
