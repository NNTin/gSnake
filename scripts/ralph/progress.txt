# Ralph Progress Log
Started: Thu Feb 19 16:54:50 CET 2026
---
## Codebase Patterns
- In `gsnake-editor`, tool-selection handlers should stay side-effect free for grid data; any state mutation that changes placed entities should go through the command/undo pipeline.
- In `EditorLayout.handleLoad`, hidden file inputs must use idempotent cleanup and hook both `change` and picker-close signals (`cancel` plus `window` focus fallback) so canceled dialogs do not leak DOM nodes.
- In `EditorLayout`, both export and test payloads should be built via `buildLevelExportPayload(...)` to keep `difficulty`, `snakeDirection`, and `totalFood` serialization rules aligned.
- In `EditorLayout.handleTest`, build the test upload URL from `VITE_GSNAKE_API_URL` (fallback `http://localhost:3001`) and trim trailing slashes before appending `/api/test-level`.
- In `EditorLayout`, calculate required-entity validation once (snake, any food variant, exit) and reuse it in both Save and Test flows so preflight rules cannot drift.
- In `EditorLayout` import paths, validate all entity coordinates against current grid bounds before mutating editor state so unsupported coordinates fail loudly instead of partially loading.
- In `SpriteLoader`, treat `spritesUrl` as trusted only after validating `response.ok` and `content-type: image/svg+xml`, then sanitize parsed SVG content before rendering via `{@html}`.
- In `SpriteLoader`, on sprite-load failure keep `spriteContent` empty, expose a visible fallback status, and store the root diagnostic in `data-sprite-load-error` for quick debugging.
- In `gsnake-editor/server.ts`, resolve `GSNAKE_EDITOR_ALLOWED_ORIGINS` once at startup and keep per-request CORS checks bound to that frozen allowlist for deterministic policy behavior.
- In Node ESM entrypoints like `gsnake-editor/server.ts`, detect direct execution by comparing `path.resolve(fileURLToPath(import.meta.url))` with `path.resolve(process.argv[1])`; avoid raw URL string checks.
- In `gsnake-editor`, both landing-page and in-editor level-load paths should call shared `parseAndValidateLevelFileData(...)` from `src/lib/levelFileValidation.ts` so required-field and grid-size checks never drift.
- In `EditorLayout`, grid reinitialization should happen through explicit `resetGrid(width, height)` calls in load/placement flows; avoid broad reactive resets that can wipe entities after dimension changes.
- In `EditorLayout`, any edit path that can reduce `snakeSegments` to zero should run through a shared helper that resets `snakeDirection` to the default `'east'` value.
- In `EditorLayout`, clear/reset helpers should always clear `entity`, `isSnakeSegment`, and `snakeSegmentIndex` together so snake metadata cannot drift on replacements/removals.
- In `EditorLayout.handleNewLevel`, treat `undoStack.length > 0` as unsaved editor state and gate `newLevel` dispatch behind `window.confirm(...)` so cancel paths preserve in-progress work.
- Keep `LevelDefinition` bounds enforcement split by concern: schema guarantees `snake.minItems >= 1` and non-negative coordinates, while `gsnake-editor` API validation enforces `x < gridSize.width` / `y < gridSize.height`.
- Keep `LevelDefinition.difficulty` constrained as schema enum (`easy|medium|hard`) to match TypeScript unions, and include an explicit invalid-difficulty drift/fixture case so downstream validator mismatches fail fast.
- In `EntityPalette.handleDragStart`, build drag-preview SVG nodes via `createElementNS` + `setAttribute` (no `innerHTML`) and preserve `dataTransfer.setData('entityType', ...)` / `setDragImage(..., 16, 16)` behavior with dedicated tests.

## [2026-02-19 17:00:35 CET] - US-001
- Implemented US-001 by removing implicit snake auto-clear on snake-tool selection in `EditorLayout`, so selecting Snake no longer destroys existing snake segments outside undo/redo commands.
- Added regression coverage that places snake segments, switches to Food, reselects Snake, and asserts snake segments remain intact.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts`
- **Learnings for future iterations:**
  - `EntityPalette` emits `select` events; `EditorLayout.handleEntitySelect` should only update `selectedEntity` and avoid hidden grid mutations.
  - `EditorLayout.gridInteractions` tests are the right place for undo/tool-selection regressions affecting in-canvas behavior.
---
## [2026-02-19 17:46:15 CET] - US-002
- Implemented hidden file-input cleanup hardening in `EditorLayout.handleLoad` by introducing a single idempotent cleanup function wired to `change`, `cancel`, and a window-focus fallback for cancel flows.
- Added regression coverage that simulates canceling the load picker and verifies the temporary hidden file input is removed from the DOM.
- Refreshed CI artifact status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` and updated `scripts/test/result.txt` with success output.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Load-picker flows should not rely solely on `onchange`; canceled dialogs can skip `change` and leak temporary DOM nodes.
  - Cleanup helpers for transient DOM nodes should be idempotent (`parentNode` guard) because multiple completion paths can fire in browser and test environments.
  - `EditorLayout.saveLoad` tests are the right location for regressions around file-load lifecycle and hidden input teardown.
---
## [2026-02-19 18:33:12 CET] - US-003
- Replaced `EditorLayout.handleTest`â€™s ad-hoc payload assembly with `buildLevelExportPayload(...)` using test metadata (`id`, `name`, and default `difficulty`) so test uploads use the same canonical serializer as exports.
- Added a regression test that clicks `Test`, captures the POST body for `/api/test-level`, and asserts canonical payload fields including `difficulty`, runtime snake-direction conversion, and `totalFood`.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Attempted live `agent-browser` verification on `http://localhost:3003`, but repeated command hangs while interacting with editor controls prevented reliable end-to-end browser confirmation; manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - `EditorLayout.handleTest` should treat payload construction as shared model logic; keep endpoint-specific behavior limited to transport (`fetch`) and launch UX.
  - For editor-side API payload regressions, `EditorLayout.saveLoad.test.ts` can validate real request bodies by mocking `fetch` and asserting serialized JSON directly.
  - Refreshing CI with targeted `act -W ... -j ...` runs is sufficient for story-level validation while keeping iteration time low.
---
## [2026-02-19 19:22:53 CET] - US-004
- Implemented strict in-bounds coordinate validation for editor imports in `EditorLayout` and fail-fast error messaging so negative/out-of-range positions are rejected instead of silently dropped.
- Added regression coverage that loads a level containing `food[0]` at `(-1, 2)` and verifies the editor rejects it with user-facing feedback while leaving the grid unchanged.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Attempted live `agent-browser` verification on `http://localhost:3003`; hidden file-input automation was flaky in headless mode for this flow, so manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - `placeEntitiesFromLevelData(...)` should validate all incoming coordinates before clearing/rebuilding grid state, preventing partial imports on malformed payloads.
  - Regression tests for import validation belong in `EditorLayout.saveLoad.test.ts` and should assert both toast feedback and unchanged editor state.
  - For hidden file pickers in browser automation, direct `upload` may hang; fallback strategies are needed, and manual validation may still be required for picker-driven flows.
---
## [2026-02-19 20:09:57 CET] - US-005
- Hardened `SpriteLoader` to require successful fetch responses and `image/svg+xml` content types before loading sprite assets.
- Replaced raw sprite HTML injection with parse-and-sanitize flow that strips executable markup/attributes (`script`, `foreignObject`, `iframe`, `object`, `embed`, `on*`, `style`, `javascript:` URLs, non-fragment hrefs) before rendering.
- Added dedicated `SpriteLoader` regression tests for successful sanitization, non-SVG content-type rejection, and non-2xx response rejection.
- Verified in-browser with `agent-browser` on `http://localhost:3003`: sprite definitions load and `.sprite-loader svg` contains no script nodes, event attributes, or external href references.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/src/lib/SpriteLoader.svelte`, `gsnake-editor/src/tests/SpriteLoader.test.ts`, `gsnake-editor/README.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - For shared SVG sprite sheets, keep loader safety at the ingestion boundary: enforce response/content-type checks and sanitize SVG AST before render.
  - `SpriteLoader` regression tests should assert both happy path availability (`symbol` defs present) and hard-failure behavior (`sprite-loader` remains empty) for invalid responses.
  - `agent-browser eval` is effective for DOM-level security verification when visual assertions are insufficient.
---
## [2026-02-19 20:56:06 CET] - US-006
- Froze CORS allowlist resolution in `gsnake-editor/server.ts` by resolving `GSNAKE_EDITOR_ALLOWED_ORIGINS` once at module startup and reusing the frozen array for every request.
- Updated server CORS tests to assert deterministic behavior when environment variables change after startup, and added parser coverage for comma-separated allowlist values.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status with `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/server.ts`, `gsnake-editor/src/tests/server.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - CORS env configuration in `gsnake-editor/server.ts` is startup configuration, not runtime mutable state.
  - Server CORS regressions are best covered in `src/tests/server.test.ts` by asserting both allowed and rejected origins around env mutation scenarios.
  - Targeted root CI job `gsnake-editor-test` is sufficient to validate editor-side server/test changes in the Ralph loop.
---
## [2026-02-19 21:44:04 CET] - US-007
- Implemented a shared level-file validation module (`parseAndValidateLevelFileData` / `validateLevelFileData`) and replaced duplicated load validation logic in both `App.handleLoadExisting` and `EditorLayout.handleLoad`.
- Added App-level regression tests that exercise landing-page load acceptance (valid payload enters editor) and rejection (invalid payload stays on landing page), complementing existing in-editor load tests.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, and `npm --prefix gsnake-editor run test`; refreshed CI via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/src/lib/levelFileValidation.ts`, `gsnake-editor/src/App.svelte`, `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/App.loadExisting.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - `App.svelte` and `EditorLayout.svelte` should share level-file validation through a single helper to keep error semantics and accepted payload shape consistent across both entry points.
  - Landing-page load regressions are easiest to test by intercepting the transient file input created in `LandingPage` and dispatching a synthetic `change` event with a file-like object.
  - `svelte-5-french-toast` can require `window.matchMedia` in tests when an error toast path is exercised; provide a local stub in test setup for deterministic behavior.
---
## [2026-02-19 22:34:04 CET] - US-008
- Replaced the broad reactive `cells` reinitialization in `EditorLayout` with explicit `createEmptyGrid(...)` / `resetGrid(...)` control flow, and routed level placement through that explicit reset path.
- Updated load sequencing to set dimensions and place entities without reactive-order dependence, preventing post-load grid wipes when dimensions change.
- Added regression coverage for sequential loads with different grid sizes to assert imported entities remain intact after resize + reload ordering.
- Verified in browser using `agent-browser` on `http://localhost:3003` by loading two payloads via the hidden-input path and confirming cell counts/entities transition `30 -> 35`; screenshot saved at `artifacts/images/us-008-sequential-load.png`.
- Ran `npm run check`, `npm run lint`, `npm run test` in `gsnake-editor`, then refreshed CI status via `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Grid-dimension transitions in `EditorLayout` are safest when reset and placement are co-located in explicit function calls, not broad reactive blocks.
  - For `gsnake-editor` browser automation, hidden file inputs can hang with direct `upload`; patching input `click` and dispatching a synthetic `change` event is a reliable fallback.
  - `EditorLayout.saveLoad.test.ts` is the right test surface for regressions that involve both file-load sequencing and post-resize entity preservation.
---
## [2026-02-19 23:19:49 CET] - US-009
- Made level-test API uploads configurable in `EditorLayout.handleTest` via `VITE_GSNAKE_API_URL` with fallback to `http://localhost:3001`, including safe trailing-slash normalization before appending `/api/test-level`.
- Updated test failure feedback to include the resolved endpoint and config guidance (`VITE_GSNAKE_API_URL`) instead of hardcoded localhost-only messaging.
- Added regression coverage for default endpoint behavior, configured endpoint behavior, and failure-toast endpoint guidance.
- Documented `VITE_GSNAKE_API_URL` in editor environment-variable docs.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, then refreshed CI with `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`.
- Attempted `agent-browser` verification at `http://localhost:3003`, but the session loaded an empty DOM (`<html><head></head><body></body></html>`) despite Vite connection logs; screenshot captured at `artifacts/images/us-009-browser.png`, and manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `gsnake-editor/README.md`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Keep test endpoint resolution centralized in `EditorLayout` and expose endpoint changes through environment config, not hardcoded URLs.
  - Endpoint helper logic should normalize trailing slashes so `VITE_GSNAKE_API_URL` works for both `http://host` and `http://host/`.
  - `EditorLayout.saveLoad.test.ts` is the correct place to assert API URL configuration and user-facing test-upload error guidance.
---
## [2026-02-20 00:06:20 CET] - US-010
- Implemented coherent snake-direction reset behavior by introducing a shared helper in `EditorLayout` that resets direction to `east` whenever edits clear snake segments to zero, and wired it into all snake-removal edit paths.
- Added regression coverage for the clear-and-redraw flow: set direction to South, clear all snake segments via entity replacement, confirm direction resets to East immediately, then redraw snake and confirm East remains selected.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success); refreshed `scripts/test/result.txt`.
- Browser verification was attempted with `agent-browser` against `http://localhost:3003`, but session interactions were flaky (stalled select action + unexpected return to landing state), so manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Direction/state coherence is easiest to maintain by centralizing snake-empty behavior in one helper instead of duplicating conditional resets in each edit handler.
  - `EditorLayout.gridInteractions.test.ts` is the right surface for direction + snake lifecycle regressions that depend on toolbar state transitions.
  - `agent-browser` sessions can become unstable on editor control interactions; when reproducibility drops, keep unit/regression coverage authoritative and note manual verification needs.
---
## [2026-02-20 00:53:05 CET] - US-011
- Hardened snake-clear metadata handling in `EditorLayout` by routing clear/replace flows through shared `clearCell(...)` and `setCellEntity(...)` helpers so `snakeSegmentIndex` is always reset alongside `entity` and `isSnakeSegment`.
- Added focused regression coverage that replaces a snake segment with Food and asserts stale `data-snake-segment-index` metadata is cleared while remaining segments are reindexed correctly.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success); refreshed `scripts/test/result.txt`.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/lib/GridCanvas.svelte`, `gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Snake metadata cleanup should be centralized in a helper so any future clear/replacement path cannot forget `snakeSegmentIndex` resets.
  - `GridCanvas`-level metadata attributes can provide lightweight observability for regression tests that need to verify internal per-cell state.
  - `EditorLayout.gridInteractions.test.ts` is the correct place for metadata-consistency regressions tied to interactive placement/replacement flows.
---
## [2026-02-20 01:38:40 CET] - US-012
- Added shared required-entity validation helpers in `EditorLayout` and applied them to both Save and Test paths; `handleTest` now blocks uploads when snake/food/exit requirements are missing and shows user-facing validation feedback before any POST.
- Added regression coverage that verifies Test is blocked with missing required entities (no network request), and updated existing test-upload specs to satisfy the new preflight requirements.
- Verified in browser with `agent-browser` on `http://localhost:3003`: clicking Test on an empty level now surfaces the full validation message; screenshot saved at `artifacts/images/us-012-test-validation.png`.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success); refreshed `scripts/test/result.txt`.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.saveLoad.test.ts`, `artifacts/images/us-012-test-validation.png`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Keep required-entity checks centralized in a helper (`calculateValidationData` + warnings mapper) so Save modal warnings and Test preflight rules stay aligned.
  - For Test-button validation regressions, `EditorLayout.saveLoad.test.ts` should assert both blocked network behavior (`fetch` not called) and user-facing toast content.
  - `agent-browser snapshot` status text is a reliable signal for toast-driven validation flows in this editor.
---
## [2026-02-20 02:26:49 CET] - US-013
- Tightened the LevelDefinition contract by requiring `snake` to be non-empty and disallowing negative coordinates in the canonical schema and vendored schema copies.
- Added API-level coordinate upper-bound validation in `gsnake-editor` (`x < gridSize.width`, `y < gridSize.height`) so out-of-grid payloads are rejected at `/api/test-level`.
- Expanded contract regression coverage: new schema fixtures (`invalid-empty-snake`, `invalid-negative-coordinate`), updated schema fixture runner, and drift tests in both editor and web for the new constraints.
- Regenerated and synchronized validator artifacts (`contracts/generated` and `gsnake-web/contracts/generated`).
- Ran `npm run test:level-schema`, `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, `npm --prefix gsnake-web run check`, `npm --prefix gsnake-web run test`, `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64`, and `act -W .github/workflows/ci.yml -j test --container-architecture linux/amd64` (from `gsnake-web`); refreshed `scripts/test/result.txt`.
- Files changed: `contracts/level-definition.schema.json`, `contracts/generated/level-definition-validator.ts`, `contracts/fixtures/level-definition.invalid-empty-snake.json`, `contracts/fixtures/level-definition.invalid-negative-coordinate.json`, `contracts/level-definition-semantics.md`, `scripts/contracts/validate-level-definition-schema.mjs`, `gsnake-editor/contracts/level-definition.schema.json`, `gsnake-editor/src/server/levelDefinitionValidator.ts`, `gsnake-editor/src/tests/server.test.ts`, `gsnake-editor/src/tests/levelDefinitionSchemaDrift.test.ts`, `gsnake-web/contracts/level-definition.schema.json`, `gsnake-web/contracts/generated/level-definition-validator.ts`, `gsnake-web/packages/gsnake-web-app/tests/contract/levelDefinitionSchemaDrift.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Keep schema-level constraints focused on shape and absolute bounds (`minItems`, non-negative positions), then enforce grid-relative bounds in API validators where `gridSize` context is available.
  - Update both drift suites (`gsnake-editor` and `gsnake-web`) whenever LevelDefinition constraints change so consumer parity checks fail fast.
  - Regenerate canonical validator artifacts first, then mirror to `gsnake-web/contracts/generated` to avoid hidden consumer drift.
---
## [2026-02-20 03:16:00 CET] - US-014
- Constrained `difficulty` in the canonical LevelDefinition schema to enum values (`easy`, `medium`, `hard`) and mirrored the same schema change into `gsnake-editor/contracts` and `gsnake-web/contracts`.
- Added schema regression coverage for invalid difficulty values via a new invalid fixture and updated schema validation/drift tests in both editor and web consumers.
- Regenerated `contracts/generated/level-definition-validator.ts`, synchronized `gsnake-web/contracts/generated/level-definition-validator.ts`, and validated through local checks plus targeted Act CI jobs.
- Files changed: `contracts/level-definition.schema.json`, `contracts/fixtures/level-definition.invalid-difficulty-value.json`, `contracts/generated/level-definition-validator.ts`, `scripts/contracts/validate-level-definition-schema.mjs`, `gsnake-editor/contracts/level-definition.schema.json`, `gsnake-editor/src/tests/levelDefinitionSchemaDrift.test.ts`, `gsnake-web/contracts/level-definition.schema.json`, `gsnake-web/contracts/generated/level-definition-validator.ts`, `gsnake-web/packages/gsnake-web-app/tests/contract/levelDefinitionSchemaDrift.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Whenever LevelDefinition schema constraints tighten, add an explicit invalid fixture plus editor/web drift cases for the same rule so validator drift is caught immediately.
  - Regenerate the canonical validator first (`npm run generate:level-validator`) and only then mirror it to `gsnake-web/contracts/generated` to avoid stale consumer validators.
  - For this contract scope, targeted `act` runs on `gsnake-web/.github/workflows/ci.yml::test` and root `ci.yml::gsnake-editor-test` are effective CI refresh points.
---
## [2026-02-20 04:01:43 CET] - US-015
- Implemented robust entrypoint detection in `gsnake-editor/server.ts` by replacing fragile raw-string checks with an `isMainModule(...)` helper that compares normalized filesystem paths via `fileURLToPath(import.meta.url)` and `process.argv[1]`.
- Added server regression coverage for direct-run detection, relative entry paths, missing entry path handling, and mismatched entry/module paths.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and refreshed CI status with `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success).
- Files changed: `gsnake-editor/server.ts`, `gsnake-editor/src/tests/server.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - For Node ESM executables, always convert `import.meta.url` through `fileURLToPath` before comparing with CLI entrypoint paths.
  - Keep main-module detection logic in a small exported helper so runtime behavior is testable without spawning child processes.
  - `src/tests/server.test.ts` is the right place for entrypoint/CORS/API contract regressions in `gsnake-editor`.
---
## [2026-02-20 04:48:35 CET] - US-016
- Replaced `EntityPalette` drag-preview `innerHTML` construction with explicit SVG DOM-node creation (`createElementNS` + `setAttribute`) so drag image rendering no longer depends on HTML string injection.
- Added `EntityPalette` regression coverage that asserts dragstart payload (`entityType`), drag-image offsets, SVG/use `href`, and cleanup removal after the scheduled timeout.
- Verified in browser with `agent-browser` on `http://localhost:3003` by dispatching a real `dragstart` event via `eval` and confirming `effectAllowed: copy`, `setData('entityType','food')`, drag image `href: #Food`, and post-timeout DOM cleanup; screenshot saved at `artifacts/images/us-016-entity-palette.png`.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success); refreshed `scripts/test/result.txt`.
- Files changed: `gsnake-editor/src/lib/EntityPalette.svelte`, `gsnake-editor/src/tests/EntityPalette.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Drag-preview visuals in `EntityPalette` should be constructed with DOM APIs and validated through behavior-level tests (`setData`, `setDragImage`, cleanup), not HTML-string snapshots.
  - For this editor UI, `agent-browser eval` is a reliable fallback for verifying drag-event internals when ref-based drag commands are flaky.
  - Keep targeted root CI validation on `ci.yml::gsnake-editor-test` after editor-only UI/security changes.
---
## [2026-02-20 05:34:12 CET] - US-017
- Added unsaved-change protection to `EditorLayout.handleNewLevel`: when edit history exists (`undoStack.length > 0`), New Level now prompts for confirmation and aborts navigation when canceled.
- Added regression coverage asserting New Level shows the unsaved-changes confirmation and canceling keeps current grid edits intact while preventing the `newLevel` event dispatch.
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success); refreshed `scripts/test/result.txt`.
- Attempted browser verification with `agent-browser` against `http://localhost:3003`; session connected to Vite but rendered an empty interactive tree, so manual browser verification is still recommended. Screenshot saved at `artifacts/images/us-017-browser.png`.
- Files changed: `gsnake-editor/src/lib/EditorLayout.svelte`, `gsnake-editor/src/tests/EditorLayout.gridInteractions.test.ts`, `CLAUDE.md`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Destructive toolbar navigation in `EditorLayout` should treat non-empty undo history as unsaved work and require explicit user confirmation before leaving.
  - For Svelte 5 tests, subscribe to component events in `render(...)` via mount `events` options (not `component.$on`, which is deprecated).
  - Keep New-Level confirmation regressions in `EditorLayout.gridInteractions.test.ts` so UI prompt behavior and cancel-state preservation stay covered together.
---
## [2026-02-20 06:21:13 CET] - US-018
- Added explicit sprite-load failure state in `SpriteLoader`: failure now captures a diagnostic string, logs actionable context with source URL, and renders a visible fallback status badge with `data-sprite-load-error` for debugging.
- Expanded `SpriteLoader` regression coverage to assert fallback rendering + diagnostics for non-SVG responses, non-OK HTTP responses, and rejected `fetch` (network failure).
- Ran `npm --prefix gsnake-editor run check`, `npm --prefix gsnake-editor run lint`, `npm --prefix gsnake-editor run test`, and `act -W .github/workflows/ci.yml -j gsnake-editor-test --container-architecture linux/amd64` (success); refreshed `scripts/test/result.txt`.
- Browser verification was attempted with `agent-browser` on `http://localhost:3003`: request interception for `sprites.svg` caused the app shell to render as an empty document in this environment, so fallback-path behavior is covered by automated tests and manual browser verification is still recommended.
- Files changed: `gsnake-editor/src/lib/SpriteLoader.svelte`, `gsnake-editor/src/tests/SpriteLoader.test.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`, `scripts/test/result.txt`
- **Learnings for future iterations:**
  - Keep sprite-load failure UX explicit in `SpriteLoader` by pairing console diagnostics with a visible in-app fallback signal.
  - `data-sprite-load-error` is a stable, testable hook for asserting diagnostics without coupling tests to exact visual styling.
  - `agent-browser` network interception can blank the Vite app shell in this flow; when that happens, rely on regression tests and note manual browser follow-up.
---
